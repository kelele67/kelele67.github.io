<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>树犹如此|人何以堪</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="做一个富有的废物">
<meta property="og:type" content="website">
<meta property="og:title" content="树犹如此|人何以堪">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="树犹如此|人何以堪">
<meta property="og:description" content="做一个富有的废物">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="树犹如此|人何以堪">
<meta name="twitter:description" content="做一个富有的废物">
  
  
    <link rel="icon" href="//favicon.png">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="http://oe9uedqb2.bkt.clouddn.com/4D9F59FD6F416AF4A92C4B977580BD95.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">kelele67</a></h1>
		</hgroup>

		
		<p class="header-subtitle">做一个富有的废物</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/about">关于本站</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/kelele67" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/kelele67" title="weibo">weibo</a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/liu-qi-21-51" title="zhihu">zhihu</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">kelele67</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="http://oe9uedqb2.bkt.clouddn.com/4D9F59FD6F416AF4A92C4B977580BD95.png" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">kelele67</h1>
			</hgroup>
			
			<p class="header-subtitle">做一个富有的废物</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/about">关于本站</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/kelele67" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/kelele67" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/liu-qi-21-51" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="airticle-深入 Lua Garbage Collector(二)" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/14/深入 Lua Garbage Collector(二)/">深入 Lua Garbage Collector(二)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>

</p><p>这一篇我们主要介绍一下Lua的GC机制</p>
<h2 id="Lua垃圾回收器函数"><a href="#Lua垃圾回收器函数" class="headerlink" title="Lua垃圾回收器函数"></a>Lua垃圾回收器函数</h2><p>Lua 提供了以下函数collectgarbage ([opt [, arg]])用来控制自动内存管理:</p>
<ul>
<li><p>collectgarbage(“collect”): 做一次完整的垃圾收集循环。通过参数 opt 它提供了一组不同的功能：</p>
</li>
<li><p>collectgarbage(“count”): 以 K 字节数为单位返回 Lua 使用的总内存数。 这个值有小数部分，所以只需要乘上 1024 就能得到 Lua 使用的准确字节数（除非溢出）。</p>
</li>
<li><p>collectgarbage(“restart”): 重启垃圾收集器的自动运行。</p>
</li>
<li><p>collectgarbage(“setpause”): 将 arg 设为收集器的 间歇率 。 返回 间歇率 的前一个值。</p>
</li>
<li><p>collectgarbage(“setstepmul”): 返回 步进倍率 的前一个值。</p>
</li>
<li><p>collectgarbage(“step”): 单步运行垃圾收集器。 步长”大小”由 arg 控制。 传入 0 时，收集器步进（不可分割的）一步。 传入非 0 值， 收集器收集相当于 Lua 分配这些多（K 字节）内存的工作。 如果收集器结束一个循环将返回 true 。</p>
</li>
<li><p>collectgarbage(“stop”): 停止垃圾收集器的运行。 在调用重启前，收集器只会因显式的调用运行。</p>
</li>
</ul>
<p>以下演示了一个简单的垃圾回收实例:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">mytable = &#123;<span class="string">"apple"</span>, <span class="string">"orange"</span>, <span class="string">"banana"</span>&#125;</div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="built_in">collectgarbage</span>(<span class="string">"count"</span>))</div><div class="line"></div><div class="line">mytable = <span class="keyword">nil</span></div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="built_in">collectgarbage</span>(<span class="string">"count"</span>))</div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="built_in">collectgarbage</span>(<span class="string">"collect"</span>))</div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="built_in">collectgarbage</span>(<span class="string">"count"</span>))</div></pre></td></tr></table></figure>
<hr>
<h2 id="基本算法"><a href="#基本算法" class="headerlink" title="基本算法"></a>基本算法</h2><p>基本算法就是我们之前的Mark &amp; Sweep</p>
<blockquote>
<p>首先，系统管理着所有已经创建了的对象。每个对象都有对其他对象的引用。root集合代表着已知的系统级别的对象引用。我们从root集合出发，就可以访问到系统引用到的所有对象。而没有被访问到的对象就是垃圾对象，需要被销毁。</p>
</blockquote>
<p>我们可以将所有对象分成三个状态：</p>
<p>①. White状态，也就是待访问状态。表示对象还没有被垃圾回收的标记过程访问到。</p>
<p>②. Gray状态，也就是待扫描状态。表示对象已经被垃圾回收访问到了，但是对象本身对于其他对象的引用还没有进行遍历访问。</p>
<p>③. Black状态，也就是已扫描状态。表示对象已经被访问到了，并且也已经遍历了对象本身对其他对象的引用</p>
<p>伪代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">当前所有对象都是White状态;  </div><div class="line">将root集合引用到的对象从White设置成Gray，并放到Gray集合中;  </div><div class="line">while(Gray集合不为空)  </div><div class="line">&#123;  </div><div class="line">    从Gray集合中移除一个对象O，并将O设置成Black状态;  </div><div class="line">    for(O中每一个引用到的对象O1) &#123;  </div><div class="line">        if(O1在White状态) &#123;  </div><div class="line">            将O1从White设置成Gray，并放到到Gray集合中；  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line">for(任意一个对象O)&#123;  </div><div class="line">    if(O在White状态)  </div><div class="line">        销毁对象O;  </div><div class="line">    else  </div><div class="line">        将O设置成White状态;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="Incremental-Garbage-Collection"><a href="#Incremental-Garbage-Collection" class="headerlink" title="Incremental Garbage Collection"></a>Incremental Garbage Collection</h2><blockquote>
<p>上面的算法如果一次性执行，在对象很多的情况下，会执行很长时间，严重影响程序本身的响应速度。其中一个解决办法就是，可以将上面的算法分步执行，这样每个步骤所耗费的时间就比较小了。我们可以将上述算法改为以下下几个步骤。</p>
</blockquote>
<ol>
<li><p>首先标识所有的root对象</p>
</li>
<li><p>遍历访问所有的gray对象。如果超出了本次计算量上限，退出等待下一次遍历</p>
</li>
<li><p>销毁垃圾对象</p>
</li>
</ol>
<blockquote>
<p>在每个步骤之间，由于程序可以正常执行，所以会破坏当前对象之间的引用关系。black对象表示已经被扫描的对象，所以他应该不可能引用到一个white对象。当程序的改变使得一个black对象引用到一个white对象时，就会造成错误。解决这个问题的办法就是设置barrier。barrier在程序正常运行过程中，监控所有的引用改变。如果一个black对象需要引用一个white对象，存在两种处理办法：</p>
</blockquote>
<p>①. 将white对象设置成gray，并添加到gray列表中等待扫描。这样等于帮助整个GC的标识过程向前推进了一步。<br>②. 将black对象该回成gray，并添加到gray列表中等待扫描。这样等于使整个GC的标识过程后退了一步。</p>
<blockquote>
<p>这种垃圾回收方式被称为”Incremental Garbage Collection”(简称为”IGC”，Lua所采用的就是这种方法。使用”IGC”并不是没有代价的。IGC所检测出来的垃圾对象集合比实际的集合要小，也就是说，有些在GC过程中变成垃圾的对象，有可能在本轮GC中检测不到。不过，这些残余的垃圾对象一定会在下一轮GC被检测出来，不会造成泄露。</p>
</blockquote>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/04/14/深入 Lua Garbage Collector(二)/" class="archive-article-date">
  	<time datetime="2017-04-14T02:50:02.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-04-14</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gc/">gc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lua/">lua</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="airticle-深入 Lua Garbage Collector(一)" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/13/深入 Lua Garbage Collector(一)/">深入 Lua Garbage Collector(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p></p><p><br>看到一个Bob Nystrom写的C语言实现的Garbage Collector</p>
<p><a href="http://journal.stuffwithstuff.com/2013/12/08/babys-first-garbage-collector/" target="_blank" rel="external">Baby’s First Garbage Collector</a></p>
<p>借着这个小程序顺便深入地了解一下Lua的垃圾回收机制</p>
<h2 id="Garbage-Collector算法小结"><a href="#Garbage-Collector算法小结" class="headerlink" title="Garbage Collector算法小结"></a>Garbage Collector算法小结</h2><p>这是之前做的一点小笔记：</p>
<p><img src="http://oe9uinblw.bkt.clouddn.com/WechatIMG1.jpeg" alt=""></p>
<h2 id="C-Garbage-Collector"><a href="#C-Garbage-Collector" class="headerlink" title="C Garbage Collector"></a>C Garbage Collector</h2><p>首先还是先来看看这个C的基本的垃圾回收器</p>
<h3 id="采用的算法"><a href="#采用的算法" class="headerlink" title="采用的算法"></a>采用的算法</h3><p>用的是经典的 Mark &amp; Sweep 算法</p>
<p>在上面的笔记里面已经介绍的很清楚了</p>
<p>该算法的工作原理几乎与我们对”可访问性(reachability)”的定义完全一样：</p>
<ol>
<li><p>从根节点开始，依次遍历整个对象图。每当你访问到一个对象，在上面设置一个”标记(mark)”位，置为true。</p>
</li>
<li><p>一旦搞定，找出所有标记位为”not”的对象集，然后删除它们。</p>
</li>
</ol>
<h3 id="对象对"><a href="#对象对" class="headerlink" title="对象对"></a>对象对</h3><p>要想清理垃圾，首先我们得制造点垃圾出来</p>
<p>所以假设我们正在为一种简单的语言编写一个解释器。它是动态的类型并且有两种类型的变量：int 和 pair。 下面是用枚举来标示一个对象的类型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// pair : 任何一对东西</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</div><div class="line">    OBJ_INT,</div><div class="line">    OBJ_PAIR</div><div class="line">&#125; ObjectType;</div><div class="line"></div><div class="line"><span class="comment">// 因为一个对象在虚拟机中可以是这两个当中的任意一种类型，所以在C中用tagged union 来实现对象</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> sObject &#123;</div><div class="line">    <span class="comment">//表示对象类型：pair or int</span></div><div class="line">    ObjectType type;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> marked;</div><div class="line"></div><div class="line">    <span class="comment">//仅维持一张由所有分配过(内存)的对象(组成)的链表。</span></div><div class="line">    <span class="keyword">struct</span> sObject*next;</div><div class="line"></div><div class="line">    <span class="comment">//union持有这个数据</span></div><div class="line">    <span class="comment">//union就是一个结构体，它将字段重叠在内存中</span></div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">int</span> value;</div><div class="line"></div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            <span class="keyword">struct</span> sObject* head;</div><div class="line">            <span class="keyword">struct</span> sObject* tail;</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line">&#125; Object;</div></pre></td></tr></table></figure>
<hr>
<h3 id="小虚拟机"><a href="#小虚拟机" class="headerlink" title="小虚拟机"></a>小虚拟机</h3><p>虚拟机要么基于栈(JVM, CLR)，要么基于寄存器(Lua)，其实本质上说都是基于栈的，它用来保存一个表达式中间需要用到的临时变量和局部变量</p>
<p>下面我们建立一个简洁的虚拟机模型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 小虚拟机</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    Object* <span class="built_in">stack</span>[STACK_MAX];</div><div class="line">    <span class="keyword">int</span> stackSize;</div><div class="line"></div><div class="line">    <span class="comment">//虚拟机会保留链表头的痕迹</span></div><div class="line">    Object* firstObject;</div><div class="line"></div><div class="line">    <span class="comment">//追踪创建了多少个对象</span></div><div class="line">    <span class="keyword">int</span> numObjects;</div><div class="line"></div><div class="line">    <span class="comment">//多少数目之后清理</span></div><div class="line">    <span class="keyword">int</span> maxObjects;</div><div class="line">&#125; VM;</div></pre></td></tr></table></figure>
<hr>
<h3 id="虚拟机的操作"><a href="#虚拟机的操作" class="headerlink" title="虚拟机的操作"></a>虚拟机的操作</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 初始化一个虚拟机</span></div><div class="line"><span class="function">VM* <span class="title">newVM</span><span class="params">()</span> </span>&#123;</div><div class="line">    VM* vm = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(VM));</div><div class="line">    vm-&gt;stackSize = <span class="number">0</span>;</div><div class="line">    Object* firstObject = <span class="literal">NULL</span>;</div><div class="line">    vm-&gt;numObjects = <span class="number">0</span>;</div><div class="line">    vm-&gt;maxObjects = <span class="number">8</span>;</div><div class="line">    <span class="keyword">return</span> vm;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//操作虚拟机堆栈</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(VM* vm, Object* value)</span> </span>&#123;</div><div class="line">    assert(vm-&gt;stackSize &lt; STACK_MAX, <span class="string">"Stack overflow!!!"</span>);</div><div class="line">    vm-&gt;<span class="built_in">stack</span>[vm-&gt;stackSize++] = value;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">Object* <span class="title">pop</span><span class="params">(VM* vm)</span> </span>&#123;</div><div class="line">    assert(vm-&gt;stackSize &gt; <span class="number">0</span>, <span class="string">"Stack underflow!!!"</span>);</div><div class="line">    <span class="keyword">return</span> vm-&gt;<span class="built_in">stack</span>[--vm-&gt;stackSize];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Mark"><a href="#Mark" class="headerlink" title="Mark"></a>Mark</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">mark</span><span class="params">(Object* object)</span> </span>&#123;</div><div class="line">    <span class="comment">//检查循环!</span></div><div class="line">    <span class="keyword">if</span> (object-&gt;marked) <span class="keyword">return</span>;</div><div class="line">    object-&gt;marked = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (object-&gt;type == OBJ_PAIR) &#123;</div><div class="line">        mark(object-&gt;head);</div><div class="line">        mark(object-&gt;tail);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">markAll</span><span class="params">(VM* vm)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; vm-&gt;stackSize; i++) &#123;</div><div class="line">        mark(vm-&gt;<span class="built_in">stack</span>[i]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="Sweep"><a href="#Sweep" class="headerlink" title="Sweep"></a>Sweep</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//清理</span></div><div class="line"><span class="comment">//仅维持一张由所有分配过(内存)的对象(组成)的链表。</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sweep</span><span class="params">(VM* vm)</span> </span>&#123;</div><div class="line">    Object** object = &amp;vm-&gt;firstObject;</div><div class="line">    <span class="keyword">while</span> (*object) &#123;</div><div class="line">        <span class="keyword">if</span> (!(*object)-&gt;marked) &#123;</div><div class="line">            <span class="comment">//没有访问过，所以从链表中移除然后释放它</span></div><div class="line">            Object* unreached = *object;</div><div class="line"></div><div class="line">            *object = unreached-&gt;next;</div><div class="line">            <span class="built_in">free</span>(unreached);</div><div class="line"></div><div class="line">            vm-&gt;numObjects--;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//访问过，所以不标记它</span></div><div class="line">            (*object)-&gt;marked = <span class="number">0</span>;</div><div class="line">            object = &amp;(*object)-&gt;next;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">gc</span><span class="params">(VM* vm)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> numObjects = vm-&gt;numObjects;</div><div class="line"></div><div class="line">    markAll(vm);</div><div class="line">    sweep(vm);</div><div class="line"></div><div class="line">    vm-&gt;maxObjects = vm-&gt;numObjects * <span class="number">2</span>;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Collected %d objects, %d remaining.\n"</span>, numObjects - vm-&gt;numObjects,</div><div class="line">            vm-&gt;numObjects);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="对象操作函数"><a href="#对象操作函数" class="headerlink" title="对象操作函数"></a>对象操作函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function">Object* <span class="title">newObject</span><span class="params">(VM* vm, ObjectType type)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (vm-&gt;numObjects == vm-&gt;maxObjects) gc(vm);</div><div class="line"></div><div class="line">    Object* object = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Object));</div><div class="line">    object-&gt;type = type;</div><div class="line">    <span class="comment">//无论何时创建对象，都添加到链表中</span></div><div class="line">    object-&gt;next = vm-&gt;firstObject;</div><div class="line">    vm-&gt;firstObject = object;</div><div class="line">    object-&gt;marked = <span class="number">0</span>;</div><div class="line"></div><div class="line">    vm-&gt;numObjects++;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> object;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//编写方法将每种类型的对象压到虚拟机的栈上</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">pushInt</span><span class="params">(VM* vm, <span class="keyword">int</span> intValue)</span> </span>&#123;</div><div class="line">    Object* object = newObject(vm, OBJ_INT);</div><div class="line">    object-&gt;value = intValue;</div><div class="line">    </div><div class="line">    push(vm, object);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">Object* <span class="title">pushPair</span><span class="params">(VM* vm)</span> </span>&#123;</div><div class="line">    Object* object = newObject(vm, OBJ_PAIR);</div><div class="line">    object-&gt;tail = pop(vm);</div><div class="line">    object-&gt;head = pop(vm);</div><div class="line"></div><div class="line">    push(vm, object);</div><div class="line">    <span class="keyword">return</span> object;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">objectPrint</span><span class="params">(Object* object)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (object-&gt;type) &#123;</div><div class="line">        <span class="keyword">case</span> OBJ_INT:</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d"</span>, object-&gt;value);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> OBJ_PAIR:</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"("</span>);</div><div class="line">        objectPrint(object-&gt;head);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">", "</span>);</div><div class="line">        objectPrint(object-&gt;tail);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">")"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="free、test、main"><a href="#free、test、main" class="headerlink" title="free、test、main"></a>free、test、main</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeVM</span><span class="params">(VM  *vm)</span> </span>&#123;</div><div class="line">    vm-&gt;stackSize = <span class="number">0</span>;</div><div class="line">    gc(vm);</div><div class="line">    <span class="built_in">free</span>(vm);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Test1: Objects on stack are preserved.\n"</span>);</div><div class="line">    VM* vm = newVM();</div><div class="line">    pushInt(vm, <span class="number">1</span>);</div><div class="line">    pushInt(vm, <span class="number">2</span>);</div><div class="line"></div><div class="line">    gc(vm);</div><div class="line">    assert(vm-&gt;numObjects == <span class="number">2</span>, <span class="string">"Should have preserved objects."</span>);</div><div class="line">    freeVM(vm);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Test2: Objects on stack are collected.\n"</span>);</div><div class="line">    VM* vm = newVM();</div><div class="line">    pushInt(vm, <span class="number">1</span>);</div><div class="line">    pushInt(vm, <span class="number">2</span>);</div><div class="line">    pop(vm);</div><div class="line">    pop(vm);</div><div class="line"></div><div class="line">    gc(vm);</div><div class="line">    assert(vm-&gt;numObjects == <span class="number">0</span>, <span class="string">"Should have collected objects."</span>);</div><div class="line">    freeVM(vm);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Test3: Reach nested objects.\n"</span>);</div><div class="line">    VM* vm = newVM();</div><div class="line">    pushInt(vm, <span class="number">1</span>);</div><div class="line">    pushInt(vm, <span class="number">2</span>);</div><div class="line">    pushPair(vm);</div><div class="line">    pushInt(vm, <span class="number">3</span>);</div><div class="line">    pushInt(vm, <span class="number">4</span>);</div><div class="line">    pushPair(vm);</div><div class="line">    pushPair(vm);</div><div class="line"></div><div class="line">    gc(vm);</div><div class="line">    assert(vm-&gt;numObjects == <span class="number">7</span>, <span class="string">"Should have reached objects."</span>);</div><div class="line">    freeVM(vm);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Test4: Handle cycles.\n"</span>);</div><div class="line">    VM* vm = newVM();</div><div class="line">    pushInt(vm, <span class="number">1</span>);</div><div class="line">    pushInt(vm, <span class="number">2</span>);</div><div class="line">    Object* a = pushPair(vm);</div><div class="line">    pushInt(vm, <span class="number">3</span>);</div><div class="line">    pushInt(vm, <span class="number">4</span>);</div><div class="line">    Object* b = pushPair(vm);</div><div class="line"></div><div class="line">    <span class="comment">//建立一个循环， 并且让2 和 4 不可到达和收集</span></div><div class="line">    a-&gt;tail = b;</div><div class="line">    b-&gt;tail = a;</div><div class="line"></div><div class="line">    gc(vm);</div><div class="line">    assert(vm-&gt;numObjects == <span class="number">4</span>, <span class="string">"Should have collected objects."</span>);</div><div class="line">    freeVM(vm);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">perfTest</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Performance Tset\n"</span>);</div><div class="line">    VM* vm = newVM();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">20</span>; j++) &#123;</div><div class="line">            pushInt(vm, i);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">20</span>; k++) &#123;</div><div class="line">            pop(vm);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    freeVM(vm);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    test1();</div><div class="line">    test2();</div><div class="line">    test3();</div><div class="line">    test4();</div><div class="line">    perfTest();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><p><img src="http://oe9uinblw.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-04-14%2015.20.31.png" alt=""></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这个简单的收集器与目前Ruby和Lua中的收集器非常的相似，所以下一次我们将深入了解Lua的GC机制。</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/04/13/深入 Lua Garbage Collector(一)/" class="archive-article-date">
  	<time datetime="2017-04-13T01:54:34.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-04-13</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gc/">gc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lua/">lua</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="airticle-Linux下的轻量服务器实现" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/31/Linux下的轻量服务器实现/">Linux下的的轻量级HTTP服务器实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p></p><p></p>
<h2 id="小型HTTP服务器"><a href="#小型HTTP服务器" class="headerlink" title="小型HTTP服务器"></a>小型HTTP服务器</h2><p>读了很多Linux下小型的http服务器，还是觉得来自<a href="http://www.jianshu.com/p/912fa6d0b5e0" target="_blank" rel="external">朱家顺的Zaver</a>的比较适合新手学习</p>
<blockquote>
<p>Zaver，一个结构简单，支持高并发的http服务器。基本架构是事件循环 + non-blocking I/O + 线程池。Zaver的代码风格参考了Nginx的风格，所以在可读性上非常高。另外，Zaver提供了配置文件和命令行参数解析，以及完善的Makefile和源代码结构，也可以帮助任何一个C初学者入门一个项目是怎么构建的。</p>
</blockquote>
<hr>
<h2 id="需要改进的地方"><a href="#需要改进的地方" class="headerlink" title="需要改进的地方"></a>需要改进的地方</h2><ul>
<li>只支持静态页面</li>
<li>HTTP1.1支持不完全，目前只实现了几个主要的（keep-alive, browser cache）的header解析</li>
<li>没有内存池</li>
<li>没有缓存</li>
<li>没有日志</li>
<li>没有用session建立对话</li>
<li>无活动连接的超时过期还没有做</li>
<li>后台运行用的是 <em>while死循环</em> 而不是 <em> daemon process </em> </li>
</ul>
<hr>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p>主要还是体会一下，毕竟刚接触网络编程，顺便复习一下知识点</p>
<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><p>使用一个文件描述符管理多个描述符，把事件都放入一个时间表中</p>
<ul>
<li>int epoll_create();</li>
<li>int epoll_ctl();</li>
<li>int epoll_wait();</li>
</ul>
<p>如果一个fd没有被它的工作线程读完，所以依然会被认为是可读的，如果下次事件循环又返回这个fd，又会分给别的线程。<br>所以要将默认的LT（level trigger）水平触发改为ET（edge trigger）边缘触发模式</p>
<p>更多关于select poll epoll的学习可以看<a href="http://www.cnblogs.com/Anker/p/3258674.html" target="_blank" rel="external">这个大神的博客</a></p>
<hr>
<h3 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h3><p>自定义调试信息的输出</p>
<blockquote>
<p>调试信息的输出方法有很多种,  例如直接用printf,  或者出错时使用perror, fprintf等将信息直接打印到终端上, 在Qt上面一般使用qDebug，而守护进程则一般是使用syslog将调试信息输出到日志文件中等等…</p>
<p>使用标准的方法打印调试信息有时候不是很方便,  例如Qt编程, 在调试已有的代码时, 我想在打印调试信息的地方, 把代码位置也打印出来以方便定位错误, 或者需要在调试信息前面加一个前辍, 好方便在调试信息太多的时候可以用grep过滤一下, 仅显示本模块的调试信息, 这时就需要一个一个地修改已有的qDebug, 使其成为以下形式:<br>　　<br>qDebug( “[模块名称] 调试信息  File:%s, Line:%d”, <strong>FILE</strong>, <strong>LINE</strong> );<br>　　<br>这样的修改比较烦人, 而且一不小心会遗漏某个没改的…<br>为了能方便地管理调试信息的输出，一个比较简单的方法就是自已定义一个打印调试信息的宏, 然后替换原来的，废话就不多说了，直接给出一个现成的，下面是一个例子, 我用WiFi表示当前代码的模块名称，我要求在模块中的所有调试信息前面均带有[WiFi]前辍，这样我就能方便地只需使用命令行 | grep “[WiFi]“来过滤掉来自其它模块的调试信息了:</p>
<p>#define qWiFiDebug(format, …) qDebug(“[WiFi] “format” File:%s, Line:%d, Function:%s”, ##<strong>VA_ARGS</strong>, <strong>FILE</strong>, <strong>LINE</strong> , <strong>FUNCTION</strong>);<br>　　<br>上面的宏是使用qDebug输出调试信息，在非Qt的程序中也可以改为printf，守护进程则可以改为syslog等等…  其中，决窍其实就是这几个宏 ##<strong>VA_ARGS</strong>, <strong>FILE</strong>, <strong>LINE</strong> 和<strong>FUNCTION</strong>,下面介绍一下这几个宏:<br>　　1)  <strong>VA_ARGS</strong> 是一个可变参数的宏，很少人知道这个宏，这个可变参数的宏是新的C99规范中新增的，目前似乎只有gcc支持（VC6.0的编译器不支持）。宏前面加上##的作用在于，当可变参数的个数为0时，这里的##起到把前面多余的”,”去掉的作用,否则会编译出错, 你可以试试。<br>　　2) <strong>FILE</strong> 宏在预编译时会替换成当前的源文件名<br>　　3) <strong>LINE</strong>宏在预编译时会替换成当前的行号<br>　　4) <strong>FUNCTION</strong>宏在预编译时会替换成当前的函数名称<br>　　有了以上这几个宏，特别是有了<strong>VA_ARGS</strong> ，调试信息的输出就变得灵活多了。</p>
</blockquote>
<hr>
<h3 id="threadpool"><a href="#threadpool" class="headerlink" title="threadpool"></a>threadpool</h3><p>用C++来实现线程池，之前也写过<a href="https://github.com/lizhenghn123/zl_threadpool" target="_blank" rel="external">这个大神的C++的线程池demo</a>，分别用C++98、C++03、C++11实现了一遍，体会到C++11的方便了啊</p>
<p>因为项目是C语言的，所以必须用到 <em> extern关键字 </em> 来混入C++代码，这也是面试常考的内容</p>
<p>具体的看这篇博文<a href="http://www.cnblogs.com/yc_sunniwell/archive/2010/07/14/1777431.html" target="_blank" rel="external">C/C++中extern关键字详解</a></p>
<p>线程池主要含有三个队列</p>
<ul>
<li>工作队列</li>
<li>工作线程队列</li>
<li>忙碌线程队列</li>
</ul>
<hr>
<h3 id="timer"><a href="#timer" class="headerlink" title="timer"></a>timer</h3><p>Nginx用rbtree实现timer</p>
<p>但是为了简单化，我们用libevent的<em> 2-heap </em>二叉最小堆来实现</p>
<blockquote>
<p>淘宝的Tengine用<em> 4-heap </em> 四叉最小堆实现<em> timer </em> ，四叉最小堆是二叉最小堆的变种，比其有更浅的深度和更好的<em> CPU Cache </em>命中率</p>
</blockquote>
<h3 id="http"><a href="#http" class="headerlink" title="http"></a>http</h3><p>1.method</p>
<blockquote>
<p>nginx在判断http method的时候用的不是字符串比较，而是整数比较。<br>比如“POST”，一般的写法是用strcmp，就会牵扯到4次char的比较。<br>而nginx把接受到的method转化为一个int，那么4次比较就可以转化为1次比较。</p>
</blockquote>
<p>具体代码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_str3Ocmp(m, c0, c1, c2, c3)                                     \</span></div><div class="line">    *(uint32_t *) m == ((c3 <span class="meta-string">&lt;&lt; 24) | (c2 &lt;&lt; 16) | (c1 &lt;&lt; 8) | c0)</span></div></pre></td></tr></table></figure>
<hr>
<p>2.request</p>
<ul>
<li>参考Nginx，用priority queue来存储header</li>
<li><a href="http://blog.csdn.net/stevenliyong/article/details/4160181" target="_blank" rel="external">关于__GNU_SOURCE这个宏</a></li>
<li><a href="http://stackoverflow.com/questions/20222079/epoll-wait-returning-events-on-closed-file-descriptor" target="_blank" rel="external">关于epoll的小细节</a></li>
</ul>
<p>3.parse</p>
<p>目前只实现了几个主要的（keep-alive, browser cache）的header解析</p>
<p>4.connection</p>
<p>这一部分的实现放在了utils里面</p>
<h3 id="utility各种通用函数"><a href="#utility各种通用函数" class="headerlink" title="utility各种通用函数"></a>utility各种通用函数</h3><p>这里主要是connect的函数</p>
<p>话说C的模块化真是一门技术活，全靠文件。。。</p>
<h3 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h3><h2 id="搭建成功"><a href="#搭建成功" class="headerlink" title="搭建成功"></a>搭建成功</h2><p><img src="http://oe9uinblw.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-04-09%2003.36.45.png" alt=""></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/03/31/Linux下的轻量服务器实现/" class="archive-article-date">
  	<time datetime="2017-03-31T03:53:23.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-03-31</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/http/">http</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web-server/">web server</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="airticle-C++11 并发学习(四)" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/14/C++11 并发学习(四)/">C++11 并发学习(三)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p></p><p><br><a href="http://www.cnblogs.com/haippy/p/3284540.html" target="_blank" rel="external">学习自大神博客</a></p>
<h2 id="下面我们来看一下C-11多线程下生产者消费者模型"><a href="#下面我们来看一下C-11多线程下生产者消费者模型" class="headerlink" title="下面我们来看一下C++11多线程下生产者消费者模型"></a>下面我们来看一下C++11多线程下生产者消费者模型</h2><h3 id="单生产者-单消费者模型"><a href="#单生产者-单消费者模型" class="headerlink" title="单生产者-单消费者模型"></a>单生产者-单消费者模型</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;condition_variable&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kItemRepositorySize = <span class="number">10</span>;  <span class="comment">//Item buffer size</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kItemsToProduce = <span class="number">100</span>; <span class="comment">//How many items we plan to produce</span></div><div class="line"></div><div class="line"><span class="keyword">struct</span> ItemRepository &#123;</div><div class="line">    <span class="keyword">int</span> item_buffer[kItemRepositorySize]; <span class="comment">//产品缓冲区， 配合模拟环形队列</span></div><div class="line">    <span class="keyword">size_t</span> read_position; <span class="comment">//消费者读取产品位置</span></div><div class="line">    <span class="keyword">size_t</span> write_position; <span class="comment">//生产者写入产品位置</span></div><div class="line">    <span class="built_in">std</span>::mutex mtx; <span class="comment">//互斥量，保护产品缓冲区</span></div><div class="line">    <span class="built_in">std</span>::condition_variable repo_not_full; <span class="comment">//条件变量，指示产品缓冲区不为满</span></div><div class="line">    <span class="built_in">std</span>::condition_variable repo_not_empty; <span class="comment">//条件变量，指示产品缓冲区不为空</span></div><div class="line">&#125; gItemRepository; <span class="comment">//产品库全局变量，生产者和消费者操作该变量</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> ItemRepository ItemRepository;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProduceItem</span><span class="params">(ItemRepository *ir, <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">    <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(ir-&gt;mtx);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (((ir-&gt;write_position + <span class="number">1</span>) % kItemRepositorySize) == ir-&gt;read_position) &#123;</div><div class="line">        <span class="comment">//buffer is full</span></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Producer is waiting for an empty slot...\n"</span>;</div><div class="line">        (ir-&gt;repo_not_full).wait(lock); <span class="comment">//生产者等待"产品库缓冲区不为满"这一条件发生</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;item_buffer)[ir-&gt;write_position] = item; <span class="comment">//写入产品</span></div><div class="line">    (ir-&gt;write_position)++; <span class="comment">//写入位置后移</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ir-&gt;write_position == kItemRepositorySize) &#123;</div><div class="line">        <span class="comment">//写入位置如果在队列最后 则需要重新设置为初始位置</span></div><div class="line">        ir-&gt;write_position = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;repo_not_empty).notify_all(); <span class="comment">//通知消费者产品库不为空</span></div><div class="line">    lock.unlock();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ConsumeItem</span><span class="params">(ItemRepository *ir)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> data;</div><div class="line">    <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(ir-&gt;mtx);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (ir-&gt;write_position == ir-&gt;read_position) &#123;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consumer is waiting for items...\n"</span>;</div><div class="line">        (ir-&gt;repo_not_empty).wait(lock); <span class="comment">// 消费者等待"产品库缓冲区不为空"这一条件发生</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    data = (ir-&gt;item_buffer)[ir-&gt;read_position]; <span class="comment">//读取产品</span></div><div class="line">    (ir-&gt;read_position)++; <span class="comment">//读取位置后移</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ir-&gt;read_position &gt;= kItemRepositorySize) &#123;</div><div class="line">        <span class="comment">//读取位置如果在队列最后 则需要重新设置为初始位置</span></div><div class="line">        ir-&gt;read_position = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;repo_not_full).notify_all();</div><div class="line">    lock.unlock();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> data;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//生产者任务</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProducerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; kItemsToProduce; ++i) &#123;</div><div class="line">        <span class="comment">//sleep(1);</span></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Produce the"</span> &lt;&lt; i &lt;&lt; <span class="string">"^th item..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">        ProduceItem(&amp;gItemRepository, i); <span class="comment">//循环生产 kItemsToProduce 个产品</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//消费者任务</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ConsumerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        <span class="keyword">int</span> item = ConsumeItem(&amp;gItemRepository); <span class="comment">//消费一个产品</span></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consume the"</span> &lt;&lt; item &lt;&lt; <span class="string">"^th item"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">if</span> (++cnt == kItemsToProduce) &#123;</div><div class="line">            <span class="comment">//如果产品消费个数为 kItemsToProduce, 则退出.</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitItemRepository</span><span class="params">(ItemRepository *ir)</span> </span>&#123;</div><div class="line">    ir-&gt;write_position = <span class="number">0</span>;</div><div class="line">    ir-&gt;read_position = <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    InitItemRepository(&amp;gItemRepository);</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">producer</span><span class="params">(ProducerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">consumer</span><span class="params">(ConsumerTask)</span></span>;</div><div class="line">    producer.join();</div><div class="line">    consumer.join();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="单生产者-多消费者模型"><a href="#单生产者-多消费者模型" class="headerlink" title="单生产者-多消费者模型"></a>单生产者-多消费者模型</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*与单生产者和单消费者模型不同的是，</span></div><div class="line">单生产者-多消费者模型中可以允许多个消费者同时从产品库中取走产品。</div><div class="line">所以除了保护产品库在多个读写线程下互斥之外，还需要维护消费者取走产品的计数器*/</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;condition_variable&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kItemRepositorySize = <span class="number">10</span>;  <span class="comment">//Item buffer size</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kItemsToProduce = <span class="number">100</span>; <span class="comment">//How many items we plan to produce</span></div><div class="line"></div><div class="line"><span class="keyword">struct</span> ItemRepository &#123;</div><div class="line">    <span class="keyword">int</span> item_buffer[kItemRepositorySize]; <span class="comment">//产品缓冲区， 配合模拟环形队列</span></div><div class="line">    <span class="keyword">size_t</span> read_position; <span class="comment">//消费者读取产品位置</span></div><div class="line">    <span class="keyword">size_t</span> write_position; <span class="comment">//生产者写入产品位置</span></div><div class="line">    </div><div class="line">    <span class="keyword">size_t</span> item_counter;</div><div class="line">    <span class="built_in">std</span>::mutex item_counter_mtx;</div><div class="line">    </div><div class="line">    <span class="built_in">std</span>::mutex mtx; <span class="comment">//互斥量，保护产品缓冲区</span></div><div class="line">    <span class="built_in">std</span>::condition_variable repo_not_full; <span class="comment">//条件变量，指示产品缓冲区不为满</span></div><div class="line">    <span class="built_in">std</span>::condition_variable repo_not_empty; <span class="comment">//条件变量，指示产品缓冲区不为空</span></div><div class="line">&#125; gItemRepository; <span class="comment">//产品库全局变量，生产者和消费者操作该变量</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> ItemRepository ItemRepository;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProduceItem</span><span class="params">(ItemRepository *ir, <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">    <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(ir-&gt;mtx);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (((ir-&gt;write_position + <span class="number">1</span>) % kItemRepositorySize) == ir-&gt;read_position) &#123;</div><div class="line">        <span class="comment">//buffer is full</span></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Producer is waiting for an empty slot...\n"</span>;</div><div class="line">        (ir-&gt;repo_not_full).wait(lock); <span class="comment">//生产者等待"产品库缓冲区不为满"这一条件发生</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;item_buffer)[ir-&gt;write_position] = item; <span class="comment">//写入产品</span></div><div class="line">    (ir-&gt;write_position)++; <span class="comment">//写入位置后移</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ir-&gt;write_position == kItemRepositorySize) &#123;</div><div class="line">        <span class="comment">//写入位置如果在队列最后 则需要重新设置为初始位置</span></div><div class="line">        ir-&gt;write_position = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;repo_not_empty).notify_all(); <span class="comment">//通知消费者产品库不为空</span></div><div class="line">    lock.unlock();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ConsumeItem</span><span class="params">(ItemRepository *ir)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> data;</div><div class="line">    <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(ir-&gt;mtx);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (ir-&gt;write_position == ir-&gt;read_position) &#123;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consumer is waiting for items...\n"</span>;</div><div class="line">        (ir-&gt;repo_not_empty).wait(lock); <span class="comment">// 消费者等待"产品库缓冲区不为空"这一条件发生</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    data = (ir-&gt;item_buffer)[ir-&gt;read_position]; <span class="comment">//读取产品</span></div><div class="line">    (ir-&gt;read_position)++; <span class="comment">//读取位置后移</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ir-&gt;read_position &gt;= kItemRepositorySize) &#123;</div><div class="line">        <span class="comment">//读取位置如果在队列最后 则需要重新设置为初始位置</span></div><div class="line">        ir-&gt;read_position = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;repo_not_full).notify_all();</div><div class="line">    lock.unlock();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> data;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//生产者任务</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProducerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; kItemsToProduce; ++i) &#123;</div><div class="line">        <span class="comment">//sleep(1);</span></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Producer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"Produce the"</span> &lt;&lt; i &lt;&lt; <span class="string">"^th item..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">        ProduceItem(&amp;gItemRepository, i); <span class="comment">//循环生产 kItemsToProduce 个产品</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Producer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is exiting..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//消费者任务</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ConsumerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">bool</span> ready_to_exit = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(gItemRepository.item_counter_mtx);</div><div class="line">        <span class="keyword">if</span> (gItemRepository.item_counter &lt; kItemsToProduce) &#123;</div><div class="line">            <span class="keyword">int</span> item = ConsumeItem(&amp;gItemRepository);</div><div class="line">            ++(gItemRepository.item_counter);</div><div class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consumer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is consuming the"</span> &lt;&lt; item &lt;&lt; <span class="string">"^th item"</span>&lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">        &#125; <span class="keyword">else</span> ready_to_exit = <span class="literal">true</span>;</div><div class="line">        lock.unlock();</div><div class="line">        <span class="keyword">if</span> (ready_to_exit == <span class="literal">true</span>) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consumer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is exiting..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitItemRepository</span><span class="params">(ItemRepository *ir)</span> </span>&#123;</div><div class="line">    ir-&gt;write_position = <span class="number">0</span>;</div><div class="line">    ir-&gt;read_position = <span class="number">0</span>;</div><div class="line">    ir-&gt;item_counter = <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    InitItemRepository(&amp;gItemRepository);</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">producer</span><span class="params">(ProducerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">consumer1</span><span class="params">(ConsumerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">consumer2</span><span class="params">(ConsumerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">consumer3</span><span class="params">(ConsumerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">consumer4</span><span class="params">(ConsumerTask)</span></span>;</div><div class="line">    producer.join();</div><div class="line">    consumer1.join();</div><div class="line">    consumer2.join();</div><div class="line">    consumer3.join();</div><div class="line">    consumer4.join();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="多生产者-单消费者模型"><a href="#多生产者-单消费者模型" class="headerlink" title="多生产者-单消费者模型"></a>多生产者-单消费者模型</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*与单生产者和单消费者模型不同的是，</span></div><div class="line">单生产者-多消费者模型中可以允许多个消费者同时从产品库中取走产品。</div><div class="line">所以除了保护产品库在多个读写线程下互斥之外，还需要维护生产者放入产品的计数器*/</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;condition_variable&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kItemRepositorySize = <span class="number">10</span>;  <span class="comment">//Item buffer size</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kItemsToProduce = <span class="number">100</span>; <span class="comment">//How many items we plan to produce</span></div><div class="line"></div><div class="line"><span class="keyword">struct</span> ItemRepository &#123;</div><div class="line">    <span class="keyword">int</span> item_buffer[kItemRepositorySize]; <span class="comment">//产品缓冲区， 配合模拟环形队列</span></div><div class="line">    <span class="keyword">size_t</span> read_position; <span class="comment">//消费者读取产品位置</span></div><div class="line">    <span class="keyword">size_t</span> write_position; <span class="comment">//生产者写入产品位置</span></div><div class="line">    </div><div class="line">    <span class="keyword">size_t</span> item_counter;</div><div class="line">    <span class="built_in">std</span>::mutex item_counter_mtx;</div><div class="line">    </div><div class="line">    <span class="built_in">std</span>::mutex mtx; <span class="comment">//互斥量，保护产品缓冲区</span></div><div class="line">    <span class="built_in">std</span>::condition_variable repo_not_full; <span class="comment">//条件变量，指示产品缓冲区不为满</span></div><div class="line">    <span class="built_in">std</span>::condition_variable repo_not_empty; <span class="comment">//条件变量，指示产品缓冲区不为空</span></div><div class="line">&#125; gItemRepository; <span class="comment">//产品库全局变量，生产者和消费者操作该变量</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> ItemRepository ItemRepository;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProduceItem</span><span class="params">(ItemRepository *ir, <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">    <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(ir-&gt;mtx);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (((ir-&gt;write_position + <span class="number">1</span>) % kItemRepositorySize) == ir-&gt;read_position) &#123;</div><div class="line">        <span class="comment">//buffer is full</span></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Producer is waiting for an empty slot...\n"</span>;</div><div class="line">        (ir-&gt;repo_not_full).wait(lock); <span class="comment">//生产者等待"产品库缓冲区不为满"这一条件发生</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;item_buffer)[ir-&gt;write_position] = item; <span class="comment">//写入产品</span></div><div class="line">    (ir-&gt;write_position)++; <span class="comment">//写入位置后移</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ir-&gt;write_position == kItemRepositorySize) &#123;</div><div class="line">        <span class="comment">//写入位置如果在队列最后 则需要重新设置为初始位置</span></div><div class="line">        ir-&gt;write_position = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;repo_not_empty).notify_all(); <span class="comment">//通知消费者产品库不为空</span></div><div class="line">    lock.unlock();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ConsumeItem</span><span class="params">(ItemRepository *ir)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> data;</div><div class="line">    <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(ir-&gt;mtx);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (ir-&gt;write_position == ir-&gt;read_position) &#123;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consumer is waiting for items...\n"</span>;</div><div class="line">        (ir-&gt;repo_not_empty).wait(lock); <span class="comment">// 消费者等待"产品库缓冲区不为空"这一条件发生</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    data = (ir-&gt;item_buffer)[ir-&gt;read_position]; <span class="comment">//读取产品</span></div><div class="line">    (ir-&gt;read_position)++; <span class="comment">//读取位置后移</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ir-&gt;read_position &gt;= kItemRepositorySize) &#123;</div><div class="line">        <span class="comment">//读取位置如果在队列最后 则需要重新设置为初始位置</span></div><div class="line">        ir-&gt;read_position = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;repo_not_full).notify_all();</div><div class="line">    lock.unlock();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> data;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//生产者任务</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProducerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">bool</span> ready_to_exit = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(gItemRepository.item_counter_mtx);</div><div class="line">        <span class="keyword">if</span> (gItemRepository.item_counter &lt; kItemsToProduce) &#123;</div><div class="line">            ++(gItemRepository.item_counter);</div><div class="line">            ProduceItem(&amp;gItemRepository, gItemRepository.item_counter);</div><div class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Producer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is producing the"</span> &lt;&lt; gItemRepository.item_counter &lt;&lt; <span class="string">"^th item..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">        &#125; <span class="keyword">else</span> ready_to_exit = <span class="literal">true</span>;</div><div class="line">        lock.unlock();</div><div class="line">        <span class="keyword">if</span> (ready_to_exit == <span class="literal">true</span>) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Producer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is exiting..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//消费者任务</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ConsumerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> item_consumed = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        ++item_consumed;</div><div class="line">        <span class="keyword">if</span> (item_consumed &lt;= kItemsToProduce) &#123;</div><div class="line">            <span class="keyword">int</span> item = ConsumeItem(&amp;gItemRepository);</div><div class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consumer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is consuming the"</span> &lt;&lt; item &lt;&lt; <span class="string">"^th item"</span>&lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;   </div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consumer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is exiting..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitItemRepository</span><span class="params">(ItemRepository *ir)</span> </span>&#123;</div><div class="line">    ir-&gt;write_position = <span class="number">0</span>;</div><div class="line">    ir-&gt;read_position = <span class="number">0</span>;</div><div class="line">    ir-&gt;item_counter = <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    InitItemRepository(&amp;gItemRepository);</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">producer1</span><span class="params">(ProducerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">producer2</span><span class="params">(ProducerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">producer3</span><span class="params">(ProducerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">producer4</span><span class="params">(ProducerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">consumer</span><span class="params">(ConsumerTask)</span></span>;</div><div class="line">    producer1.join();</div><div class="line">    producer2.join();</div><div class="line">    producer3.join();</div><div class="line">    producer4.join();</div><div class="line">    consumer.join();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="多生产者-多消费者模型"><a href="#多生产者-多消费者模型" class="headerlink" title="多生产者-多消费者模型"></a>多生产者-多消费者模型</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*该模型可以说是前面两种模型的综合，程序需要维护两个计数器，分别是生产者已生产产品的数目和消费者已取走产品的数目。</span></div><div class="line">另外也需要保护产品库在多个生产者和多个消费者互斥地访问*/</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;condition_variable&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kItemRepositorySize = <span class="number">10</span>;  <span class="comment">//Item buffer size</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kItemsToProduce = <span class="number">100</span>; <span class="comment">//How many items we plan to produce</span></div><div class="line"></div><div class="line"><span class="keyword">struct</span> ItemRepository &#123;</div><div class="line">    <span class="keyword">int</span> item_buffer[kItemRepositorySize]; <span class="comment">//产品缓冲区， 配合模拟环形队列</span></div><div class="line">    <span class="keyword">size_t</span> read_position; <span class="comment">//消费者读取产品位置</span></div><div class="line">    <span class="keyword">size_t</span> write_position; <span class="comment">//生产者写入产品位置</span></div><div class="line">    </div><div class="line">    <span class="keyword">size_t</span> produced_item_counter;</div><div class="line">    <span class="keyword">size_t</span> consumed_item_counter;</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::mutex produced_item_counter_mtx;</div><div class="line">    <span class="built_in">std</span>::mutex consumed_item_counter_mtx;</div><div class="line">    </div><div class="line">    <span class="built_in">std</span>::mutex mtx; <span class="comment">//互斥量，保护产品缓冲区</span></div><div class="line">    <span class="built_in">std</span>::condition_variable repo_not_full; <span class="comment">//条件变量，指示产品缓冲区不为满</span></div><div class="line">    <span class="built_in">std</span>::condition_variable repo_not_empty; <span class="comment">//条件变量，指示产品缓冲区不为空</span></div><div class="line">&#125; gItemRepository; <span class="comment">//产品库全局变量，生产者和消费者操作该变量</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> ItemRepository ItemRepository;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProduceItem</span><span class="params">(ItemRepository *ir, <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">    <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(ir-&gt;mtx);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (((ir-&gt;write_position + <span class="number">1</span>) % kItemRepositorySize) == ir-&gt;read_position) &#123;</div><div class="line">        <span class="comment">//buffer is full</span></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Producer is waiting for an empty slot...\n"</span>;</div><div class="line">        (ir-&gt;repo_not_full).wait(lock); <span class="comment">//生产者等待"产品库缓冲区不为满"这一条件发生</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;item_buffer)[ir-&gt;write_position] = item; <span class="comment">//写入产品</span></div><div class="line">    (ir-&gt;write_position)++; <span class="comment">//写入位置后移</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ir-&gt;write_position == kItemRepositorySize) &#123;</div><div class="line">        <span class="comment">//写入位置如果在队列最后 则需要重新设置为初始位置</span></div><div class="line">        ir-&gt;write_position = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;repo_not_empty).notify_all(); <span class="comment">//通知消费者产品库不为空</span></div><div class="line">    lock.unlock();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ConsumeItem</span><span class="params">(ItemRepository *ir)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> data;</div><div class="line">    <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(ir-&gt;mtx);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (ir-&gt;write_position == ir-&gt;read_position) &#123;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consumer is waiting for items...\n"</span>;</div><div class="line">        (ir-&gt;repo_not_empty).wait(lock); <span class="comment">// 消费者等待"产品库缓冲区不为空"这一条件发生</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    data = (ir-&gt;item_buffer)[ir-&gt;read_position]; <span class="comment">//读取产品</span></div><div class="line">    (ir-&gt;read_position)++; <span class="comment">//读取位置后移</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ir-&gt;read_position &gt;= kItemRepositorySize) &#123;</div><div class="line">        <span class="comment">//读取位置如果在队列最后 则需要重新设置为初始位置</span></div><div class="line">        ir-&gt;read_position = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    (ir-&gt;repo_not_full).notify_all();</div><div class="line">    lock.unlock();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> data;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//生产者任务</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProducerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">bool</span> ready_to_exit = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(gItemRepository.produced_item_counter_mtx);</div><div class="line">        <span class="keyword">if</span> (gItemRepository.produced_item_counter &lt; kItemsToProduce) &#123;</div><div class="line">            ++(gItemRepository.produced_item_counter);</div><div class="line">            ProduceItem(&amp;gItemRepository, gItemRepository.produced_item_counter);</div><div class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Producer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is producing the"</span> &lt;&lt; gItemRepository.produced_item_counter &lt;&lt; <span class="string">"^th item..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">        &#125; <span class="keyword">else</span> ready_to_exit = <span class="literal">true</span>;</div><div class="line">        lock.unlock();</div><div class="line">        <span class="keyword">if</span> (ready_to_exit == <span class="literal">true</span>) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Producer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is exiting..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//消费者任务</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ConsumerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">bool</span> ready_to_exit = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(gItemRepository.consumed_item_counter_mtx);</div><div class="line">        <span class="keyword">if</span> (gItemRepository.consumed_item_counter &lt;= kItemsToProduce) &#123;</div><div class="line">            <span class="keyword">int</span> item = ConsumeItem(&amp;gItemRepository);</div><div class="line">            ++(gItemRepository.consumed_item_counter);</div><div class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consumer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is consuming the"</span> &lt;&lt; gItemRepository.consumed_item_counter &lt;&lt; <span class="string">"^th item"</span>&lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;  </div><div class="line">        &#125; <span class="keyword">else</span> ready_to_exit = <span class="literal">true</span>;</div><div class="line">        lock.unlock();</div><div class="line">        <span class="keyword">if</span> (ready_to_exit == <span class="literal">true</span>) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Consumer thread"</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"is exiting..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitItemRepository</span><span class="params">(ItemRepository *ir)</span> </span>&#123;</div><div class="line">    ir-&gt;write_position = <span class="number">0</span>;</div><div class="line">    ir-&gt;read_position = <span class="number">0</span>;</div><div class="line">    ir-&gt;produced_item_counter = <span class="number">0</span>;</div><div class="line">    ir-&gt;consumed_item_counter = <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    InitItemRepository(&amp;gItemRepository);</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">producer1</span><span class="params">(ProducerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">producer2</span><span class="params">(ProducerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">producer3</span><span class="params">(ProducerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">producer4</span><span class="params">(ProducerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">consumer1</span><span class="params">(ConsumerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">consumer2</span><span class="params">(ConsumerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">consumer3</span><span class="params">(ConsumerTask)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">consumer4</span><span class="params">(ConsumerTask)</span></span>;</div><div class="line">    producer1.join();</div><div class="line">    producer2.join();</div><div class="line">    producer3.join();</div><div class="line">    producer4.join();</div><div class="line">    consumer1.join();</div><div class="line">    consumer2.join();</div><div class="line">    consumer3.join();</div><div class="line">    consumer4.join();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/02/14/C++11 并发学习(四)/" class="archive-article-date">
  	<time datetime="2017-02-14T04:02:34.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-02-14</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/concurrency/">concurrency</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/threadpool/">threadpool</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="airticle-C++11 并发学习(三)" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/14/C++11 并发学习(三)/">C++11 并发学习(三)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p></p><p><br><a href="http://www.cnblogs.com/haippy/p/3284540.html" target="_blank" rel="external">学习自大神博客</a></p>
<h2 id="C-11-ThreadPool-简单实现"><a href="#C-11-ThreadPool-简单实现" class="headerlink" title="C++11 ThreadPool 简单实现"></a>C++11 ThreadPool 简单实现</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> THREAD_POOL_H</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> THREAD_POOL_H</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atomic&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;condition_variable&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;future&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">// C++11 版的 线程池</span></div><div class="line"><span class="keyword">namespace</span> zl</div><div class="line">&#123;</div><div class="line">    <span class="keyword">class</span> ThreadsGuard</div><div class="line">    &#123;</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        ThreadsGuard(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt;&amp; v)</div><div class="line">            : threads_(v)</div><div class="line">        &#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ~ThreadsGuard()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i != threads_.size(); ++i)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (threads_[i].joinable())</div><div class="line">                &#123;</div><div class="line">                    threads_[i].join();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        ThreadsGuard(ThreadsGuard&amp;&amp; tg) = <span class="keyword">delete</span>;</div><div class="line">        ThreadsGuard&amp; <span class="keyword">operator</span> = (ThreadsGuard&amp;&amp; tg) = <span class="keyword">delete</span>;</div><div class="line"></div><div class="line">        ThreadsGuard(<span class="keyword">const</span> ThreadsGuard&amp;) = <span class="keyword">delete</span>;</div><div class="line">        ThreadsGuard&amp; <span class="keyword">operator</span> = (<span class="keyword">const</span> ThreadsGuard&amp;) = <span class="keyword">delete</span>;</div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt;&amp; threads_;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">class</span> ThreadPool</div><div class="line">    &#123;</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="keyword">typedef</span> <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>()&gt; task_type;</div><div class="line"></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">ThreadPool</span><span class="params">(<span class="keyword">int</span> n = <span class="number">0</span>)</span></span>;</div><div class="line"></div><div class="line">        ~ThreadPool()</div><div class="line">        &#123;</div><div class="line">            stop();</div><div class="line">            cond_.notify_all();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span></span></div><div class="line">        &#123;</div><div class="line">            stop_.store(<span class="literal">true</span>, <span class="built_in">std</span>::memory_order_release);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">template</span>&lt;<span class="keyword">class</span> Function, <span class="keyword">class</span>... Args&gt;</div><div class="line">        <span class="built_in">std</span>::future&lt;<span class="keyword">typename</span> <span class="built_in">std</span>::result_of&lt;Function(Args...)&gt;::type&gt; add(Function&amp;&amp;, Args&amp;&amp;...);</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        ThreadPool(ThreadPool&amp;&amp;) = <span class="keyword">delete</span>;</div><div class="line">        ThreadPool&amp; <span class="keyword">operator</span> = (ThreadPool&amp;&amp;) = <span class="keyword">delete</span>;</div><div class="line">        ThreadPool(<span class="keyword">const</span> ThreadPool&amp;) = <span class="keyword">delete</span>;</div><div class="line">        ThreadPool&amp; <span class="keyword">operator</span> = (<span class="keyword">const</span> ThreadPool&amp;) = <span class="keyword">delete</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">        <span class="built_in">std</span>::atomic&lt;<span class="keyword">bool</span>&gt; stop_;</div><div class="line">        <span class="built_in">std</span>::mutex mtx_;</div><div class="line">        <span class="built_in">std</span>::condition_variable cond_;</div><div class="line"></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">queue</span>&lt;task_type&gt; tasks_;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt; threads_;</div><div class="line">        zl::ThreadsGuard tg_;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">inline</span> ThreadPool::ThreadPool(<span class="keyword">int</span> n)</div><div class="line">        : stop_(<span class="literal">false</span>)</div><div class="line">        , tg_(threads_)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">int</span> nthreads = n;</div><div class="line">        <span class="keyword">if</span> (nthreads &lt;= <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            nthreads = <span class="built_in">std</span>::thread::hardware_concurrency();</div><div class="line">            nthreads = (nthreads == <span class="number">0</span> ? <span class="number">2</span> : nthreads);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i != nthreads; ++i)</div><div class="line">        &#123;</div><div class="line">            threads_.push_back(<span class="built_in">std</span>::thread([<span class="keyword">this</span>]&#123;</div><div class="line">                <span class="keyword">while</span> (!stop_.load(<span class="built_in">std</span>::memory_order_acquire))</div><div class="line">                &#123;</div><div class="line">                    task_type task;</div><div class="line">                    &#123;</div><div class="line">                        <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; ulk(<span class="keyword">this</span>-&gt;mtx_);</div><div class="line">                        <span class="keyword">this</span>-&gt;cond_.wait(ulk, [<span class="keyword">this</span>]&#123; <span class="keyword">return</span> stop_.load(<span class="built_in">std</span>::memory_order_acquire) || !<span class="keyword">this</span>-&gt;tasks_.empty(); &#125;);</div><div class="line">                        <span class="keyword">if</span> (stop_.load(<span class="built_in">std</span>::memory_order_acquire))</div><div class="line">                            <span class="keyword">return</span>;</div><div class="line">                        task = <span class="built_in">std</span>::move(<span class="keyword">this</span>-&gt;tasks_.front());</div><div class="line">                        <span class="keyword">this</span>-&gt;tasks_.pop();</div><div class="line">                    &#125;</div><div class="line">                    task();</div><div class="line">                &#125;</div><div class="line">            &#125;));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">template</span>&lt;<span class="keyword">class</span> Function, <span class="keyword">class</span>... Args&gt;</div><div class="line">    <span class="built_in">std</span>::future&lt;<span class="keyword">typename</span> <span class="built_in">std</span>::result_of&lt;Function(Args...)&gt;::type&gt;</div><div class="line">        ThreadPool::add(Function&amp;&amp; fcn, Args&amp;&amp;... args)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> <span class="built_in">std</span>::result_of&lt;Function(Args...)&gt;::type return_type;</div><div class="line">        <span class="keyword">typedef</span> <span class="built_in">std</span>::packaged_task&lt;return_type()&gt; task;</div><div class="line"></div><div class="line">        <span class="keyword">auto</span> t = <span class="built_in">std</span>::make_shared&lt;task&gt;(<span class="built_in">std</span>::bind(<span class="built_in">std</span>::forward&lt;Function&gt;(fcn), <span class="built_in">std</span>::forward&lt;Args&gt;(args)...));</div><div class="line">        <span class="keyword">auto</span> ret = t-&gt;get_future();</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lg(mtx_);</div><div class="line">            <span class="keyword">if</span> (stop_.load(<span class="built_in">std</span>::memory_order_acquire))</div><div class="line">                <span class="keyword">throw</span> <span class="built_in">std</span>::runtime_error(<span class="string">"thread pool has stopped"</span>);</div><div class="line">            tasks_.emplace([t]&#123;(*t)(); &#125;);</div><div class="line">        &#125;</div><div class="line">        cond_.notify_one();</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">/* THREAD_POOL_H */</span></span></div></pre></td></tr></table></figure>
<hr>
<h2 id="线程池的具体思路就不多说了，我们主要说一下用到的c-11的部分"><a href="#线程池的具体思路就不多说了，我们主要说一下用到的c-11的部分" class="headerlink" title="线程池的具体思路就不多说了，我们主要说一下用到的c++11的部分"></a>线程池的具体思路就不多说了，我们主要说一下用到的c++11的部分</h2><h3 id="首先是-建立了一个-std-vector-lt-std-thread-gt-amp-v-的容器"><a href="#首先是-建立了一个-std-vector-lt-std-thread-gt-amp-v-的容器" class="headerlink" title="首先是 建立了一个 std::vector&lt; std::thread&gt;&amp; v 的容器"></a>首先是 建立了一个 std::vector&lt; std::thread&gt;&amp; v 的容器</h3><h3 id="定义了一个原子操作std-atomic-lt-bool-gt-stop-对bool进行了原子性封装"><a href="#定义了一个原子操作std-atomic-lt-bool-gt-stop-对bool进行了原子性封装" class="headerlink" title="定义了一个原子操作std::atomic&lt; bool&gt; stop_  对bool进行了原子性封装"></a>定义了一个原子操作std::atomic&lt; bool&gt; stop_  对bool进行了原子性封装</h3><h3 id="然后不仅用到了std-lock-guard，还用了相比其提供了更好的上锁和解锁控制的std-unique-lock。"><a href="#然后不仅用到了std-lock-guard，还用了相比其提供了更好的上锁和解锁控制的std-unique-lock。" class="headerlink" title="然后不仅用到了std::lock_guard，还用了相比其提供了更好的上锁和解锁控制的std::unique_lock。"></a>然后不仅用到了std::lock_guard，还用了相比其提供了更好的上锁和解锁控制的std::unique_lock。</h3><p>这里主要介绍一下操作更为丰富的 <em>std::unique_lock</em></p>
<blockquote>
<p>顾名思义，unique_lock 对象以独占所有权的方式（ unique owership）管理 mutex 对象的上锁和解锁操作，所谓独占所有权，就是没有其他的 unique_lock 对象同时拥有某个 mutex 对象的所有权。</p>
</blockquote>
<p>  ①. 上锁/解锁操作：lock，try_lock，try_lock_for，try_lock_until 和 unlock</p>
<p>  ②. 修改操作：移动赋值(move assignment)(前面已经介绍过了)，交换(swap)（与另一个 std::unique_lock 对象交换它们所管理的 Mutex 对象的所有权），释放(release)（返回指向它所管理的 Mutex 对象的指针，并释放所有权）</p>
<p>  ③. 获取属性操作：owns_lock（返回当前 std::unique_lock 对象是否获得了锁）、operator bool()（与 owns_lock 功能相同，返回当前 std::unique_lock 对象是否获得了锁）、mutex（返回当前 std::unique_lock 对象所管理的 Mutex 对象的指针）。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><blockquote>
<p>感觉这个例子还是用到挺多C++11的特性，在这里还是得一一解释一下（只是简单解释一下，关于C++还有很多要学的，我目前也只是个菜鸡啊。。。C++太棒了！特性多到你学不完→→手动滑稽）：</p>
</blockquote>
<h3 id="首先是std-function"><a href="#首先是std-function" class="headerlink" title="首先是std::function"></a>首先是std::function</h3><p>简单的来说就是：</p>
<blockquote>
<p>通过std::function对C++中各种可调用实体（普通函数、Lambda表达式、函数指针、以及其它函数对象等）的封装，形成一个新的可调用的std::function对象；让我们不再纠结那么多的可调用实体。一切变的简单粗暴。</p>
</blockquote>
<p>其实就是以前我们用函数指针来统一处理不同的函数对象类型，现在我们可以使用更安全的std::function来完成这些任务。</p>
<p>在上述例子中，使用它来定义了一个任务类型对象</p>
<p>typedef std::function&lt; void()&gt; task_type;</p>
<p><a href="http://www.jellythink.com/archives/771" target="_blank" rel="external">更为深入地学习，可以看这篇博客</a></p>
<h3 id="std-memory-order"><a href="#std-memory-order" class="headerlink" title="std::memory_order"></a>std::memory_order</h3><p>C++11 中规定了6种访存次序(Memory Order)，<a href="https://www.zhihu.com/question/24301047" target="_blank" rel="external">知乎上给出了通俗的解释</a></p>
<ul>
<li>momory_order_relaxed,</li>
<li>memory_order_consume,</li>
<li>memory_order_acquire,</li>
<li>memory_order_release,</li>
<li>memory_order_acq_rel,</li>
<li>memory_order_seq_cst.</li>
</ul>
<blockquote>
<p>虽然有6个选项，其实表示的是三种内存模型</p>
</blockquote>
<ul>
<li><p>sequential consistent(memory_order_seq_cst)</p>
</li>
<li><p>relaxed(memory_order_seq_cst)</p>
</li>
<li><p>acquire release(memory_order_consume, memory_order_acquire, memory_order_release, memory_order_acq_rel) </p>
</li>
</ul>
<p>我们这里用到的是获取-释放次序 <em>acquire release</em></p>
<blockquote>
<p>目的就是限制两个来自不同线程的原子操作的顺序，具体的操作就是需要两个线程进行一下同步，同步对一个变量的读写操作…</p>
</blockquote>
<p>①. 原子load操作：</p>
<p>while (!stop_.load(std::memory_order_acquire))</p>
<p>②. 原子store操作：</p>
<p>std::memory_order_release</p>
<h3 id="std-result-of"><a href="#std-result-of" class="headerlink" title="std::result_of"></a>std::result_of</h3><p>其实这个就是和我们之前的auto decltype都是属于自动类型推导，主要是使我们的代码可读易维护</p>
<p>我们这里用的<br>std::future&lt; typename std::result_of&lt; Function(Args…)&gt;::type&gt; add(Function&amp;&amp;, Args&amp;&amp;…);<br>就是为了获取function的返回值</p>
<blockquote>
<p>result_of 其实就是通过decltype来推导函数的返回类型</p>
</blockquote>
<h3 id="std-move"><a href="#std-move" class="headerlink" title="std::move"></a>std::move</h3><p>在C++11中，标准库在&lt; utility&gt;中提供了一个有用的函数std::move，这个函数的名字具有迷惑性，因为实际上std::move并不能移动任何东西，它唯一的功能是将一个左值强制转化为右值引用，继而我们可以通过右值引用使用该值，以用于移动语义。从实现上讲，std::move基本等同于一个类型转换：<br>static_cast&lt; T&amp;&amp;&gt;(lvalue);</p>
<blockquote>
<p>值得一提的是，被转化的左值，其生命期并没有随着左右值的转化而改变。如果读者期望std::move转化的左值变量lvalue能立即被析构，那么肯定会失望了。</p>
</blockquote>
<h3 id="std-packaged-task"><a href="#std-packaged-task" class="headerlink" title="std::packaged_task"></a>std::packaged_task</h3><p>std::packaged_task它包装了一个可调用的目标（如function, lambda expression, bind expression, or another function object）,以便异步调用，它和promise在某种程度上有点像，promise保存了一个共享状态的值，而packaged_task保存的是一个函数</p>
<p>typedef std::packaged_task&lt; return_type()&gt; task;</p>
<h3 id="std-make-shared"><a href="#std-make-shared" class="headerlink" title="std::make_shared"></a>std::make_shared</h3><p>C++11 中引入了智能指针, 同时还有一个模板函数 std::make_shared 可以返回一个指定类型的 std::shared_ptr：</p>
<p>struct A;<br>std::shared_ptr&lt; A&gt; p1 = std::make_shared&lt; A&gt;();<br>std::shared_ptr&lt; A&gt; p2(new A);</p>
<p>①. 如果是使用new：</p>
<p>auto p = new widget();<br>shared_ptr sp1{ p }, sp2{ sp1 };<br>需要两次内存分配</p>
<p>②. 然而使用make_shared的话：</p>
<p>auto sp1 = make_shared(), sp2{ sp1 };</p>
<p>所以我们这里 std::make_shared 其实就是为了代替 new<br>auto t = std::make_shared&lt; task&gt;(std::bind(std::forward&lt; Function&gt;(fcn), std::forward&lt; Args&gt;(args)…));</p>
<p><a href="http://www.tuicool.com/articles/F3u6jy" target="_blank" rel="external">想要进一步了解它与std::shared_ptr的构造函数比较的戳</a></p>
<p>总结一些我们需要了解的就是：</p>
<p>①. 同直接使用new相比，make函数减小了代码重复，提高的异常安全，并且对于std::make_shared和std::allcoated_shared，生成的代码会更小更快。</p>
<p>②. 不能使用make函数的情况包括我们需要定制删除器和期望直接传递大括号初始化器。</p>
<p>③. 对于std::shared_ptr，额外的不建议使用make函数的情况包括：<br>（1）定制内存管理的类<br>（2）关注内存的系统，非常大的对象，以及生存期比 std::shared_ptr长的std::weak_ptr</p>
<p>下一篇我们将会实现C++11多线程下各种生产者消费者模型</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/02/14/C++11 并发学习(三)/" class="archive-article-date">
  	<time datetime="2017-02-14T04:02:34.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-02-14</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/concurrency/">concurrency</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/threadpool/">threadpool</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="airticle-C++11 并发学习(二)" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/14/C++11 并发学习(二)/">C++11 并发学习(二)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p></p><p><br><a href="http://www.cnblogs.com/haippy/p/3284540.html" target="_blank" rel="external">学习自大神博客</a></p>
<h2 id="线程详解"><a href="#线程详解" class="headerlink" title="线程详解"></a>线程详解</h2><p>具体源码的大家有兴趣的可以去查看<a href="http://www.open-std.org/" target="_blank" rel="external">c++ 标准委员会的官方文档</a></p>
<p>在这里我主要讲一下他们的主要结构以及主要用法</p>
<h3 id="lt-thread-gt"><a href="#lt-thread-gt" class="headerlink" title="&lt; thread&gt;"></a>&lt; thread&gt;</h3><ol>
<li>std::thread 简单例子</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span> <span class="comment">// std::cout</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span>   <span class="comment">// std::thread</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">thread_task</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"hello thread"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t</span><span class="params">(thread_task)</span></span>;</div><div class="line">    t.join();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="lt-mutex-gt"><a href="#lt-mutex-gt" class="headerlink" title="&lt; mutex&gt;"></a>&lt; mutex&gt;</h3><blockquote>
<p>std::mutex 是C++11 中最基本的互斥量，std::mutex 对象提供了独占所有权的特性——即不支持递归地对 std::mutex 对象上锁，而 std::recursive_lock 则可以递归地对互斥量对象上锁。</p>
</blockquote>
<p>①. Mutex 系列类(四种)</p>
<ul>
<li>std::mutex，最基本的 Mutex 类。</li>
<li>std::recursive_mutex，递归 Mutex 类。</li>
<li>std::time_mutex，定时 Mutex 类。</li>
<li>std::recursive_timed_mutex，定时递归 Mutex 类</li>
</ul>
<p>②. Lock 类（两种）</p>
<ul>
<li>std::lock_guard，与 Mutex RAII （资源获取即初始化）相关，方便线程对互斥量上锁。</li>
<li>std::unique_lock，与 Mutex RAII （资源获取即初始化）相关，方便线程对互斥量上锁，但提供了更好的上锁和解锁控制。</li>
</ul>
<h3 id="lt-condition-variable-gt"><a href="#lt-condition-variable-gt" class="headerlink" title="&lt; condition_variable&gt;"></a>&lt; condition_variable&gt;</h3><blockquote>
<p>&lt; condition_variable &gt; 头文件主要包含了与条件变量相关的类和函数。与条件变量相关的类包括 std::condition_variable 和 std::condition_variable_any，还有枚举类型std::cv_status。另外还包括函数 std::notify_all_at_thread_exit()</p>
<p>在 Linux 下是使用 Pthread 库中的 pthread<em>cond</em>*() 函数来实现条件变量相关的功能</p>
</blockquote>
<h3 id="lt-future-gt"><a href="#lt-future-gt" class="headerlink" title="&lt; future&gt;"></a>&lt; future&gt;</h3><blockquote>
<p>C++11 标准中与异步任务系相关的类型主要是以下四种 std::promise，std::packaged_task（std::promise，std::packaged_task 也称为异步任务的提供者 Provider，此外 std::async 也可以作为异步任务的提供者，不过 std::async 并不是类，而是函数，本章后面会详细介绍异步任务的提供者 Provider），std::future，std::shared_future。另外 &lt; future&gt; 中还定义一些辅助的类，例如： std::future_error，std::future_errc，std::status，std::launch。</p>
</blockquote>
<p>之前也有提到，主要是用来实现异步</p>
<h3 id="lt-atomic-gt"><a href="#lt-atomic-gt" class="headerlink" title="&lt; atomic&gt;"></a>&lt; atomic&gt;</h3><p>关于C++11的原子操作之前我有过笔记，下图</p>
<p><img src="http://oe9uinblw.bkt.clouddn.com/WechatIMG2.jpeg" alt=""></p>
<p>好了，关于C++11的新特性大致的梳理了一遍，接下来我们先看看之前提到的那个C++11的线程池具体是怎么实现的吧</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/02/14/C++11 并发学习(二)/" class="archive-article-date">
  	<time datetime="2017-02-13T17:02:34.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-02-14</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/concurrency/">concurrency</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/thread/">thread</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="airticle-C++11 并发学习(一)" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/13/C++11 并发学习(一)/">C++11 并发学习(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p></p><p><br><a href="http://www.cnblogs.com/haippy/p/3284540.html" target="_blank" rel="external">学习自大神博客</a></p>
<h2 id="并发和并行"><a href="#并发和并行" class="headerlink" title="并发和并行"></a>并发和并行</h2><blockquote>
<p>与并发相近的另一个概念是并行(Parallel)。和并发所描述的情况一样，并行也是指两个或多个任务被同时执行。但是严格来讲，并发和并行的概念并是不等同的，两者存在很大的差别。下面我们来看看计算机科学家们是怎么区分并发和并行的。</p>
<p>并发是一个处理器同时处理多个任务，而并行多个处理器或者是多核的处理器同时处理多个不同的任务。前者是逻辑上的同时发生（simultaneous），而后者是物理上的同时发生。</p>
</blockquote>
<h2 id="C-并发"><a href="#C-并发" class="headerlink" title="C++并发"></a>C++并发</h2><h3 id="C-11多线程相关的头文件"><a href="#C-11多线程相关的头文件" class="headerlink" title="C++11多线程相关的头文件"></a>C++11多线程相关的头文件</h3><blockquote>
<p>C++11 新标准中引入了五个头文件来支持多线程编程，它们分别是 &lt; atomic&gt;, &lt; thread&gt;, &lt; mutex&gt;, &lt; condition_variable&gt; 和 &lt; future&gt;。</p>
</blockquote>
<p>①. &lt; atomic&gt;：该头文主要声明了两个类, std::atomic 和 std::atomic_flag，另外还声明了一套 C 风格的原子类型和与 C 兼容的原子操作的函数。<br>&lt; atomic&gt; 一一 可以用来实现数据结构的无锁结构</p>
<p>②. &lt; thread&gt;：该头文件主要声明了 std::thread 类，另外 std::this_thread 命名空间也在该头文件中。<br>之前在Linux下写多线程的时候用的Pthread，但是在实现线程池的时候，有用到过C++11的<thread>，具体是学习自<a href="https://github.com/lizhenghn123/zl_threadpool" target="_blank" rel="external">这个大神的C++的线程池demo</a></thread></p>
<p>③. &lt; mutex&gt;：该头文件主要声明了与互斥量(Mutex)相关的类，包括 std::mutex_* 一系列类，std::lock_guard, std::unique_lock, 以及其他的类型和函数。</p>
<p>④. &lt; condition_variable&gt;：该头文件主要声明了与条件变量相关的类，包括 std::condition_variable 和 std::condition_variable_any。</p>
<p>⑤. &lt; future&gt;：该头文件主要声明了 std::promise, std::package_task 两个 Provider 类，以及 std::future 和 std::shared_future 两个 Future 类，另外还有一些与之相关的类型和函数，std::async() 函数就声明在此头文件中。<br>这里介绍一下std::async() 一一 用来优雅的实现C++异步，一般和std::future()一起使用，前者用于创建异步任务，后者从异步任务中获取结果。</p>
<p>接下来我们就是要具体地学习每一个部分了，不过大部分就是之前学习过，用过的，应该学起来还是很快的。</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/02/13/C++11 并发学习(一)/" class="archive-article-date">
  	<time datetime="2017-02-13T02:58:34.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-02-13</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/concurrency/">concurrency</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/thread/">thread</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="airticle-Linux mount (一)" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/15/Linux mount (一)/">Linux mount 学习(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p></p><p></p>
<h2 id="Linux-mount"><a href="#Linux-mount" class="headerlink" title="Linux mount"></a>Linux mount</h2><p>介绍一些比较实用的mount用法，包括挂载内核中的虚拟文件系统、loop device和bind mount。</p>
<h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><blockquote>
<p>mount -t type -o options device dir</p>
</blockquote>
<ul>
<li><p>device: 要挂载的设备</p>
</li>
<li><p>dir: 挂载到哪个目录</p>
</li>
</ul>
<h3 id="挂载-loop-device"><a href="#挂载-loop-device" class="headerlink" title="挂载 loop device"></a>挂载 loop device</h3><h4 id="ISO文件"><a href="#ISO文件" class="headerlink" title="ISO文件"></a>ISO文件</h4><blockquote>
<p>需要用到loop device的最常见的场景是mount一个ISO文件，示例如下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#利用mkisofs构建一个用于测试的iso文件</div><div class="line">kingand67@kelele67:~$ mkdir -p iso/subdir01</div><div class="line">kingand67@kelele67:~$ mkisofs -o ./test.iso ./iso</div><div class="line">I: -input-charset not specified, using utf-8 (detected in locale settings)</div><div class="line">Total translation table size: 0</div><div class="line">Total rockridge attributes bytes: 0</div><div class="line">Total directory bytes: 2048</div><div class="line">Path table size(bytes): 26</div><div class="line">Max brk space used 0</div><div class="line">175 extents written (0 MB)</div><div class="line"></div><div class="line"></div><div class="line">#mount ISO 到目录 /mnt</div><div class="line">kingand67@kelele67:~$ sudo mount ./test.iso /mnt</div><div class="line">mount: /dev/loop0 is write-protected, mounting read-only</div><div class="line"></div><div class="line">#mount成功，能看到里面的文件夹</div><div class="line">kingand67@kelele67:~$ ls /mnt</div><div class="line">subdir01</div><div class="line"></div><div class="line"></div><div class="line">#通过losetup命令可以看到占用了loop0设备</div><div class="line">kingand67@kelele67:~$ losetup -a</div><div class="line">/dev/loop0: []: (/home/kingand67/test.iso)</div></pre></td></tr></table></figure>
<hr>
<h4 id="虚拟硬盘"><a href="#虚拟硬盘" class="headerlink" title="虚拟硬盘"></a>虚拟硬盘</h4><blockquote>
<p>loop device另一种常用的用法是虚拟一个硬盘，比如我想尝试下btrfs这个文件系统，但系统中目前的所有分区都已经用了，里面都是有用的数据，不想格式化他们，这时虚拟硬盘就有用武之地了，示例如下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#因为btrfs对分区的大小有最小要求，所以利用dd命令创建一个128M的文件</div><div class="line">kingand67@kelele67:~$ dd if=/dev/zero bs=1M count=128 of=./vdisk.img</div><div class="line">128+0 records in</div><div class="line">128+0 records out</div><div class="line">134217728 bytes (134 MB, 128 MiB) copied, 0.116018 s, 1.2 GB/s</div><div class="line"></div><div class="line">#在这个文件里面创建btrfs文件系统</div><div class="line">#为了方便，我就把整个硬盘全部给btrfs文件系统</div><div class="line"></div><div class="line">kingand67@kelele67:~$ mkfs.btrfs ./vdisk.img</div><div class="line">The program &apos;mkfs.btrfs&apos; is currently not installed. You can install it by typing:</div><div class="line">sudo apt install btrfs-tools</div><div class="line"></div><div class="line">#因为提示我们没有安装btrfs-tools，所以我们先安装</div><div class="line">kingand67@kelele67:~$ sudo apt install btrfs-tools</div><div class="line"></div><div class="line">#重新创建</div><div class="line">#输出了一些信息，提示创建成功</div><div class="line">kingand67@kelele67:~$ mkfs.btrfs ./vdisk.img</div><div class="line">btrfs-progs v4.4</div><div class="line">See http://btrfs.wiki.kernel.org for more information.</div><div class="line"></div><div class="line">Label:              (null)</div><div class="line">UUID:               67050364-6802-4ddd-adf0-257a0df7714c</div><div class="line">Node size:          16384</div><div class="line">Sector size:        4096</div><div class="line">Filesystem size:    128.00MiB</div><div class="line">Block group profiles:</div><div class="line">  Data:             single            8.00MiB</div><div class="line">  Metadata:         DUP              40.00MiB</div><div class="line">  System:           DUP              12.00MiB</div><div class="line">SSD detected:       no</div><div class="line">Incompat features:  extref, skinny-metadata</div><div class="line">Number of devices:  1</div><div class="line">Devices:</div><div class="line">   ID        SIZE  PATH</div><div class="line">    1   128.00MiB  ./vdisk.img</div><div class="line"></div><div class="line">#mount虚拟硬盘</div><div class="line">kingand67@kelele67:~$ sudo mount ./vdisk.img /mnt/</div><div class="line"></div><div class="line">#在虚拟硬盘中创建文件成功</div><div class="line">kingand67@kelele67:~$ sudo touch /mnt/aaaaaa</div><div class="line">kingand67@kelele67:~$ ls /mnt/</div><div class="line">aaaaaa</div><div class="line"></div><div class="line">#查看我们的loop device</div><div class="line">kingand67@kelele67:~$ losetup -a</div><div class="line">/dev/loop0: []: (/home/kingand67/vdisk.img)</div></pre></td></tr></table></figure>
<hr>
<h4 id="挂载多个设备到一个文件夹"><a href="#挂载多个设备到一个文件夹" class="headerlink" title="挂载多个设备到一个文件夹"></a>挂载多个设备到一个文件夹</h4><blockquote>
<p>在上面的例子中，将test.iso和vdisk.img都mount到了/mnt目录下，这个在Linux下是支持的，默认会用后面的mount覆盖掉前面的mount，只有当umount后面的device后，原来的device才看的到。</p>
</blockquote>
<h4 id="挂载一个设备到多个目录"><a href="#挂载一个设备到多个目录" class="headerlink" title="挂载一个设备到多个目录"></a>挂载一个设备到多个目录</h4><blockquote>
<p>当然我们也可以把一个设备mount到多个文件夹，这样在多个文件夹中都可以访问该设备中的内容。</p>
</blockquote>
<h4 id="bind-mount"><a href="#bind-mount" class="headerlink" title="bind mount"></a>bind mount</h4><blockquote>
<p>bind mount功能非常强大，可以将任何一个挂载点、普通目录或者文件挂载到其他地方，是玩转Linux的必备技能</p>
</blockquote>
<p>①基本功能</p>
<blockquote>
<p>bind mount会将源目录绑定到目的目录，然后在目的目录下就可以看到源目录里的文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#准备要用到的目录</div><div class="line">kingand67@kelele67:~$ mkdir -p bind/bind1/sub1</div><div class="line">kingand67@kelele67:~$ mkdir -p bind/bind2/sub2</div><div class="line"></div><div class="line"></div><div class="line">kingand67@kelele67:~$ tree bind</div><div class="line">bind</div><div class="line">├── bind1</div><div class="line">│   └── sub1</div><div class="line">└── bind2</div><div class="line">    └── sub2</div><div class="line"></div><div class="line">4 directories, 0 files</div><div class="line"></div><div class="line">#bind mount后，bind2里面显示的就是bind1目录的内容</div><div class="line">kingand67@kelele67:~$ sudo mount --bind ./bind/bind1/ ./bind/bind2</div><div class="line">kingand67@kelele67:~$ tree bind</div><div class="line">bind</div><div class="line">├── bind1</div><div class="line">│   └── sub1</div><div class="line">└── bind2</div><div class="line">    └── sub1</div><div class="line"></div><div class="line">4 directories, 0 files</div></pre></td></tr></table></figure>
<hr>
<p>②readonly bind</p>
<blockquote>
<p>我们可以在bind的时候指定readonly，这样原来的目录还是能读写，但目的目录为只读</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">#通过readonly的方式bind mount</div><div class="line">kingand67@kelele67:~$ sudo mount -o bind,ro ./bind/bind1/ ./bind/bind2</div><div class="line">kingand67@kelele67:~$ tree bind</div><div class="line">bind</div><div class="line">├── bind1</div><div class="line">│   └── sub1</div><div class="line">│       </div><div class="line">└── bind2</div><div class="line">    └── sub1</div><div class="line"></div><div class="line">4 directories, 0 files</div><div class="line"></div><div class="line">#bind2目录为只读，没法touch里面的文件</div><div class="line">kingand67@kelele67:~$ touch ./bind/bind2/sub1/aaa</div><div class="line">touch: cannot touch &apos;./bind/bind2/sub1/aaa&apos;: Read-only file system</div><div class="line"></div><div class="line">#bind1还是能读写</div><div class="line">kingand67@kelele67:~$ touch ./bind/bind1/sub1/aaa</div><div class="line"></div><div class="line">#我们可以在bind1和bind2目录下看到刚创建的文件</div><div class="line">kingand67@kelele67:~$ tree bind</div><div class="line">bind</div><div class="line">├── bind1</div><div class="line">│   └── sub1</div><div class="line">│       └── aaa</div><div class="line">└── bind2</div><div class="line">    └── sub1</div><div class="line">        └── aaa</div></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>如果我们想让当前目录readonly，那么可以bind自己，并且指定readonly参数：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#bind mount并且指定readonly</div><div class="line">kingand67@kelele67:~$ sudo mount -o bind,ro ./bind/bind1/ ./bind/bind1</div><div class="line"></div><div class="line">#创建新文件失败</div><div class="line">kingand67@kelele67:~$ touch ./bind/bind1/sub1/aaa</div><div class="line">touch: cannot touch &apos;./bind/bind1/sub1/aaa&apos;: Read-only file system</div><div class="line"></div><div class="line">#umount之后，文件夹恢复到原来的读写权限</div><div class="line">kingand67@kelele67:~$ sudo umount ./bind/bind1/</div><div class="line"></div><div class="line">##touch文件成功</div><div class="line">kingand67@kelele67:~$ touch ./bind/bind1/sub1/aaa</div></pre></td></tr></table></figure>
<hr>
<p>③bind mount单个文件</p>
<blockquote>
<p>我们也可以bind mount单个文件，这个功能尤其适合需要在不同版本配置文件之间切换的时候</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">#创建两个用于测试的文件</div><div class="line">kingand67@kelele67:~$ echo aaaaaa &gt; bind/aa</div><div class="line">kingand67@kelele67:~$ echo bbbbbb &gt; bind/bb</div><div class="line">kingand67@kelele67:~$ cat bind/aa</div><div class="line">aaaaaa</div><div class="line">kingand67@kelele67:~$ cat bind/bb</div><div class="line">bbbbbb</div><div class="line"></div><div class="line">#bind mount后，bb里面看到的是aa的内容</div><div class="line">kingand67@kelele67:~$ sudo mount --bind ./bind/aa bind/bb</div><div class="line">kingand67@kelele67:~$ cat bind/bb</div><div class="line">aaaaaa</div><div class="line"></div><div class="line">#即使我们删除aa文件，我们还是能够通过bb看到aa里面的内容</div><div class="line">kingand67@kelele67:~$ rm bind/aa</div><div class="line">kingand67@kelele67:~$ cat bind/bb</div><div class="line">aaaaaa</div><div class="line"></div><div class="line"></div><div class="line">#umount bb文件后，bb的内容出现了，不过aa的内容再也找不到了</div><div class="line">kingand67@kelele67:~$ sudo umount bind/bb</div><div class="line">kingand67@kelele67:~$ cat bind/bb</div><div class="line">bbbbbb</div></pre></td></tr></table></figure>
<hr>
<p>④move一个挂载点到另一个地方</p>
<blockquote>
<p>move操作可以将一个挂载点移动到别的地方，这里以bind mount为例来演示，当然其他类型的挂载点也可以通过move操作来移动。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">#umount上面操作所产生的挂载点</div><div class="line">kingand67@kelele67:~$ sudo umount bind/bind1</div><div class="line">kingand67@kelele67:~$ sudo umount bind/bind2</div><div class="line"></div><div class="line">#bind mount</div><div class="line">kingand67@kelele67:~$ sudo mount --bind ./bind/bind1/ ./bind/bind2/</div><div class="line">kingand67@kelele67:~$ ls ./bind/bind*</div><div class="line">./bind/bind1:</div><div class="line">sub1</div><div class="line"></div><div class="line">./bind/bind2:</div><div class="line">sub1</div><div class="line"></div><div class="line">#move操作要求mount point的父mount point不能为shared。</div><div class="line">#在这里./bind/bind2/的父mount point为&apos;/&apos;，所以需要将&apos;/&apos;变成private后才能做move操作</div><div class="line">#关于shared、private的含义将会在下一篇介绍</div><div class="line">kingand67@kelele67:~$ findmnt -o TARGET,PROPAGATION /</div><div class="line">TARGET PROPAGATION</div><div class="line">/      shared</div><div class="line">kingand67@kelele67:~$ sudo mount --make-private /</div><div class="line">kingand67@kelele67:~$ findmnt -o TARGET,PROPAGATION /</div><div class="line">TARGET PROPAGATION</div><div class="line">/      private</div><div class="line"></div><div class="line">#move成功，在mnt下能看到bind1里面的内容</div><div class="line">kingand67@kelele67:~$ sudo mount --move ./bind/bind2/ /mnt</div><div class="line">kingand67@kelele67:~$ ls /mnt/</div><div class="line">sub1</div><div class="line"></div><div class="line">#由于bind2上的挂载点已经被移动到了/mnt上，于是能看到bind2目录下原来的文件了</div><div class="line">kingand67@kelele67:~$ ls ./bind/bind2/</div><div class="line">sub2</div></pre></td></tr></table></figure>
<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在这篇文章中演示了一些比较实用的mount操作，尤其是bind mount，至于在哪些情况下要用哪些功能，需要我们自己去挖掘。下一篇中将介绍mount相关的“Shared subtrees”</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://segmentfault.com/a/1190000006878392" target="_blank" rel="external">Linux mount （第一部分）</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/01/15/Linux mount (一)/" class="archive-article-date">
  	<time datetime="2017-01-15T05:05:02.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-01-15</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mount/">mount</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="airticle-浅析Linux初始化init系统" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/14/浅析Linux初始化init系统/">浅析Linux初始化init系统</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>

</p><h2 id="第一部分-sysvinit"><a href="#第一部分-sysvinit" class="headerlink" title="第一部分 sysvinit"></a>第一部分 sysvinit</h2><h3 id="什么是sysvinit"><a href="#什么是sysvinit" class="headerlink" title="什么是sysvinit"></a>什么是sysvinit</h3><blockquote>
<p>sysvinit 就是 system V 风格的 init 系统，顾名思义，它源于 System V 系列 UNIX。它提供了比 BSD 风格 init 系统更高的灵活性。是已经风行了几十年的 UNIX init 系统，一直被各类 Linux 发行版所采用。</p>
</blockquote>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>优点：</p>
<ul>
<li><p>概念简单。</p>
</li>
<li><p>确定的执行顺序：脚本严格按照启动数字的大小顺序执行，一个执行完毕再执行下一个，这非常有益于错误排查。</p>
</li>
</ul>
<p>缺点：</p>
<ul>
<li><p>UpStart 和 systemd 支持并发启动，导致没有人可以确定地了解具体的启动顺序，排错不易。</p>
</li>
<li><p>但是串行地执行脚本导致 sysvinit 运行效率较慢，在新的 IT 环境下，启动快慢成为一个重要问题。此外动态设备加载等 Linux 新特性也暴露出 sysvinit 设计的一些问题。</p>
</li>
</ul>
<p>Upstart 是第一个被广泛应用的新一代 init 系统。我们在接下来的第二部分介绍 UpStart</p>
<h2 id="第二部分-UpStart"><a href="#第二部分-UpStart" class="headerlink" title="第二部分 UpStart"></a>第二部分 UpStart</h2><h3 id="什么是-UpStart"><a href="#什么是-UpStart" class="headerlink" title="什么是 UpStart"></a>什么是 UpStart</h3><p>假如您使用的 Linux 发行版是 Ubuntu，很可能会发现在您的计算机上找不到/etc/inittab 文件了，这是因为 Ubuntu 使用了一种被称为 upstart 的新型 init 系统。</p>
<h3 id="为什么使用-UpStart"><a href="#为什么使用-UpStart" class="headerlink" title="为什么使用 UpStart"></a>为什么使用 UpStart</h3><p>随着不断的发展，人们发现经典的 sysvinit 已经不适合笔记本环境。</p>
<p>原因在于：</p>
<p>桌面系统或便携式设备的一个特点是经常重启，而且要频繁地使用硬件热插拔技术。</p>
<p>Sysvinit 没有办法处理这类需求，它必须一次性把所有可能用到的服务都启动起来，即便是需要被初始化的设备并没有连接到系统上，CUPS 服务也必须启动。</p>
<h3 id="UpStart优势"><a href="#UpStart优势" class="headerlink" title="UpStart优势"></a>UpStart优势</h3><p>UpStart 解决了之前提到的 sysvinit 的缺点。采用事件驱动模型，UpStart 可以：</p>
<ul>
<li><p>更快地启动系统</p>
</li>
<li><p>当新硬件被发现时动态启动服务</p>
</li>
<li><p>硬件被拔除时动态停止服务</p>
</li>
</ul>
<h3 id="UpStart命令"><a href="#UpStart命令" class="headerlink" title="UpStart命令"></a>UpStart命令</h3><ul>
<li>可以用 initctl list 来查看所有工作的概况：</li>
</ul>
<h3 id="UpStart小结"><a href="#UpStart小结" class="headerlink" title="UpStart小结"></a>UpStart小结</h3><p>可以看到，UpStart 的设计比 SysVInit 更加先进。多数 Linux 发行版上已经不再使用 SysVInit，一部分发行版采用了 UpStart，比如 Ubuntu（Ubuntu16.04改用systemd）；而另外一些比如 Fedora，采用了一种被称为 systemd 的 init 系统。接下来我们再介绍 systemd。</p>
<h2 id="第三部分-Systemd"><a href="#第三部分-Systemd" class="headerlink" title="第三部分 Systemd"></a>第三部分 Systemd</h2><h3 id="什么是-Systemd"><a href="#什么是-Systemd" class="headerlink" title="什么是 Systemd"></a>什么是 Systemd</h3><p>Systemd 是 Linux 系统中最新的初始化系统（init），它主要的设计目标是克服 sysvinit 固有的缺点，提高系统的启动速度。</p>
<p>Systemd 的很多概念来源于苹果 Mac OS 操作系统上的 launchd</p>
<p>由于是最新的，所以我们着重了解一下</p>
<h3 id="systemd-特性"><a href="#systemd-特性" class="headerlink" title="systemd 特性"></a>systemd 特性</h3><ul>
<li><p>systemd 提供按需启动能力</p>
</li>
<li><p>Systemd 采用 Linux 的 Cgroup 特性跟踪和管理进程的生命周期</p>
</li>
<li><p>启动挂载点和自动挂载的管理</p>
</li>
<li><p>实现事务性依赖关系管理</p>
</li>
<li><p>能够对系统进行快照和恢复</p>
</li>
<li><p>日志服务</p>
</li>
</ul>
<p>###</p>
<p>Systemd 的基本概念</p>
<ul>
<li><p>单元的概念<br>系统初始化需要做的事情非常多。需要启动后台服务，比如启动 SSHD 服务；需要做配置工作，比如挂载文件系统。这个过程中的每一步都被 systemd 抽象为一个配置单元，即 unit。可以认为一个服务是一个配置单元；一个挂载点是一个配置单元；一个交换分区的配置是一个配置单元；等等。</p>
</li>
<li><p>service ：代表一个后台服务进程，比如 mysqld。这是最常用的一类。</p>
</li>
</ul>
<p>*socket ：此类配置单元封装系统和互联网中的一个 套接字 。当下，systemd 支持流式、数据报和连续包的 AF_INET、AF_INET6、AF_UNIX socket 。每一个套接字配置单元都有一个相应的服务配置单元 。相应的服务在第一个”连接”进入套接字时就会启动(例如：nscd.socket 在有新连接后便启动 nscd.service)。</p>
<ul>
<li><p>device ：此类配置单元封装一个存在于 Linux 设备树中的设备。每一个使用 udev 规则标记的设备都将会在 systemd 中作为一个设备配置单元出现。</p>
</li>
<li><p>mount ：此类配置单元封装文件系统结构层次中的一个挂载点。Systemd 将对这个挂载点进行监控和管理。比如可以在启动时自动将其挂载；可以在某些条件下自动卸载。Systemd 会将/etc/fstab 中的条目都转换为挂载点，并在开机时处理。</p>
</li>
<li><p>automount ：此类配置单元封装系统结构层次中的一个自挂载点。每一个自挂载配置单元对应一个挂载配置单元 ，当该自动挂载点被访问时，systemd 执行挂载点中定义的挂载行为。</p>
</li>
<li><p>swap: 和挂载配置单元类似，交换配置单元用来管理交换分区。用户可以用交换配置单元来定义系统中的交换分区，可以让这些交换分区在启动时被激活。</p>
</li>
<li><p>target ：此类配置单元为其他配置单元进行逻辑分组。它们本身实际上并不做什么，只是引用其他配置单元而已。这样便可以对配置单元做一个统一的控制。这样就可以实现大家都已经非常熟悉的运行级别概念。</p>
</li>
<li><p>timer：定时器配置单元用来定时触发用户定义的操作，这类配置单元取代了 atd、crond 等传统的定时服务。</p>
</li>
<li><p>snapshot ：与 target 配置单元相似，快照是一组配置单元。它保存了系统当前的运行状态。</p>
</li>
</ul>
<h3 id="Systemd-的并发启动原理"><a href="#Systemd-的并发启动原理" class="headerlink" title="Systemd 的并发启动原理"></a>Systemd 的并发启动原理</h3><p>如前所述，在 Systemd 中，所有的服务都并发启动，比如 Avahi、D-Bus、livirtd、X11、HAL 可以同时启动。乍一看，这似乎有点儿问题，比如 Avahi 需要 syslog 的服务，Avahi 和 syslog 同时启动，假设 Avahi 的启动比较快，所以 syslog 还没有准备好，可是 Avahi 又需要记录日志，这岂不是会出现问题？<br>Systemd 的开发人员仔细研究了服务之间相互依赖的本质问题，发现所谓依赖可以分为三个具体的类型，而每一个类型实际上都可以通过相应的技术解除依赖关系。</p>
<h4 id="并发启动原理之一：解决-socket-依赖"><a href="#并发启动原理之一：解决-socket-依赖" class="headerlink" title="并发启动原理之一：解决 socket 依赖"></a>并发启动原理之一：解决 socket 依赖</h4><p>绝大多数的服务依赖是套接字依赖。比如服务 A 通过一个套接字端口 S1 提供自己的服务，其他的服务如果需要服务 A，则需要连接 S1。因此如果服务 A 尚未启动，S1 就不存在，其他的服务就会得到启动错误。所以传统地，人们需要先启动服务 A，等待它进入就绪状态，再启动其他需要它的服务。Systemd 认为，只要我们预先把 S1 建立好，那么其他所有的服务就可以同时启动而无需等待服务 A 来创建 S1 了。如果服务 A 尚未启动，那么其他进程向 S1 发送的服务请求实际上会被 Linux 操作系统缓存，其他进程会在这个请求的地方等待。一旦服务 A 启动就绪，就可以立即处理缓存的请求，一切都开始正常运行。<br>那么服务如何使用由 init 进程创建的套接字呢？<br>Linux 操作系统有一个特性，当进程调用 fork 或者 exec 创建子进程之后，所有在父进程中被打开的文件句柄 (file descriptor) 都被子进程所继承。套接字也是一种文件句柄，进程 A 可以创建一个套接字，此后当进程 A 调用 exec 启动一个新的子进程时，只要确保该套接字的 close_on_exec 标志位被清空，那么新的子进程就可以继承这个套接字。子进程看到的套接字和父进程创建的套接字是同一个系统套接字，就仿佛这个套接字是子进程自己创建的一样，没有任何区别。<br>这个特性以前被一个叫做 inetd 的系统服务所利用。Inetd 进程会负责监控一些常用套接字端口，比如 Telnet，当该端口有连接请求时，inetd 才启动 telnetd 进程，并把有连接的套接字传递给新的 telnetd 进程进行处理。这样，当系统没有 telnet 客户端连接时，就不需要启动 telnetd 进程。Inetd 可以代理很多的网络服务，这样就可以节约很多的系统负载和内存资源，只有当有真正的连接请求时才启动相应服务，并把套接字传递给相应的服务进程。<br>和 inetd 类似，systemd 是所有其他进程的父进程，它可以先建立所有需要的套接字，然后在调用 exec 的时候将该套接字传递给新的服务进程，而新进程直接使用该套接字进行服务即可。</p>
<h4 id="并发启动原理之二：解决-D-Bus-依赖"><a href="#并发启动原理之二：解决-D-Bus-依赖" class="headerlink" title="并发启动原理之二：解决 D-Bus 依赖"></a>并发启动原理之二：解决 D-Bus 依赖</h4><p>D-Bus 是 desktop-bus 的简称，是一个低延迟、低开销、高可用性的进程间通信机制。它越来越多地用于应用程序之间通信，也用于应用程序和操作系统内核之间的通信。很多现代的服务进程都使用D-Bus 取代套接字作为进程间通信机制，对外提供服务。比如简化 Linux 网络配置的 NetworkManager 服务就使用 D-Bus 和其他的应用程序或者服务进行交互：邮件客户端软件 evolution 可以通过 D-Bus 从 NetworkManager 服务获取网络状态的改变，以便做出相应的处理。<br>D-Bus 支持所谓”bus activation”功能。如果服务 A 需要使用服务 B 的 D-Bus 服务，而服务 B 并没有运行，则 D-Bus 可以在服务 A 请求服务 B 的 D-Bus 时自动启动服务 B。而服务 A 发出的请求会被 D-Bus 缓存，服务 A 会等待服务 B 启动就绪。利用这个特性，依赖 D-Bus 的服务就可以实现并行启动。</p>
<h4 id="并发启动原理之三：解决文件系统依赖"><a href="#并发启动原理之三：解决文件系统依赖" class="headerlink" title="并发启动原理之三：解决文件系统依赖"></a>并发启动原理之三：解决文件系统依赖</h4><p>系统启动过程中，文件系统相关的活动是最耗时的，比如挂载文件系统，对文件系统进行磁盘检查（fsck），磁盘配额检查等都是非常耗时的操作。在等待这些工作完成的同时，系统处于空闲状态。那些想使用文件系统的服务似乎必须等待文件系统初始化完成才可以启动。但是 systemd 发现这种依赖也是可以避免的。<br>Systemd 参考了 autofs 的设计思路，使得依赖文件系统的服务和文件系统本身初始化两者可以并发工作。autofs 可以监测到某个文件系统挂载点真正被访问到的时候才触发挂载操作，这是通过内核 automounter 模块的支持而实现的。比如一个 open()系统调用作用在”/misc/cd/file1”的时候，/misc/cd 尚未执行挂载操作，此时 open()调用被挂起等待，Linux 内核通知 autofs，autofs 执行挂载。这时候，控制权返回给 open()系统调用，并正常打开文件。<br>Systemd 集成了 autofs 的实现，对于系统中的挂载点，比如/home，当系统启动的时候，systemd 为其创建一个临时的自动挂载点。在这个时刻/home 真正的挂载设备尚未启动好，真正的挂载操作还没有执行，文件系统检测也还没有完成。可是那些依赖该目录的进程已经可以并发启动，他们的 open()操作被内建在 systemd 中的 autofs 捕获，将该 open()调用挂起（可中断睡眠状态）。然后等待真正的挂载操作完成，文件系统检测也完成后，systemd 将该自动挂载点替换为真正的挂载点，并让 open()调用返回。由此，实现了那些依赖于文件系统的服务和文件系统本身同时并发启动。<br>当然对于”/“根目录的依赖实际上一定还是要串行执行，因为 systemd 自己也存放在/之下，必须等待系统根目录挂载检查好。<br>不过对于类似/home 等挂载点，这种并发可以提高系统的启动速度，尤其是当/home 是远程的 NFS 节点，或者是加密盘等，需要耗费较长的时间才可以准备就绪的情况下，因为并发启动，这段时间内，系统并不是完全无事可做，而是可以利用这段空余时间做更多的启动进程的事情，总的来说就缩短了系统启动时间。</p>
<p>###</p>
<ul>
<li><p>令人惊奇的激进的并发启动能力，极大地提高了系统启动速度</p>
</li>
<li><p>用 CGroup 统计跟踪子进程，干净可靠</p>
</li>
</ul>
<p>此外，和其前任不同的地方在于，systemd 已经不仅仅是一个初始化系统了。<br>Systemd 出色地替代了 sysvinit 的所有功能，但它并未就此自满。因为 init 进程是系统所有进程的父进程这样的特殊性，systemd 非常适合提供曾经由其他服务提供的功能，比如定时任务 (以前由 crond 完成) ；会话管理 (以前由 ConsoleKit/PolKit 等管理) 。仅仅从本文皮毛一样的介绍来看，Systemd 已经管得很多了，可它还在不断发展。它将逐渐成为一个多功能的系统环境，能够处理非常多的系统管理任务，有人甚至将它看作一个操作系统。</p>
<h3 id="扩展话题"><a href="#扩展话题" class="headerlink" title="扩展话题"></a>扩展话题</h3><p><a href="https://askubuntu.com/questions/1792/how-can-i-suspend-hibernate-from-command-line?cm_mc_uid=05938828085514744326348&amp;cm_mc_sid_50200000=1492191801" target="_blank" rel="external">如何让 ubuntu 系统休眠</a>，可以使用底层的/sys/power/state 接口，也可以使用诸如 pm-utility 等高层接口。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.ibm.com/developerworks/cn/linux/1407_liuming_init1/" target="_blank" rel="external">浅析 Linux 初始化 init系统</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/01/14/浅析Linux初始化init系统/" class="archive-article-date">
  	<time datetime="2017-01-14T03:50:02.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-01-14</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/systemd/">systemd</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sysvinit/">sysvinit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/upstart/">upstart</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="airticle-Zookeeper C API学习(一)" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/13/Zookeeper C API学习(一)/">Zookeeper C API学习(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p></p><p><br><a href="http://www.cnblogs.com/haippy/archive/2013/02/21/2919365.html" target="_blank" rel="external">学习自大神博客</a></p>
<h3 id="Zookeeper-伪分布式安装"><a href="#Zookeeper-伪分布式安装" class="headerlink" title="Zookeeper 伪分布式安装"></a>Zookeeper 伪分布式安装</h3><p>因为之前也上了大数据的选修，安装过<em>Hadoop</em>，所以说这个小动物园的安装当然是不在话下辣，毕竟也是被各种安装环境虐的死去活来的 → → 最近也打算开始研究<em>Docker</em>了，打算学习完<em>Zookeeper</em>就开始</p>
<p>安装好了</p>
<p><img src="" alt=""></p>
<p>### </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/01/13/Zookeeper C API学习(一)/" class="archive-article-date">
  	<time datetime="2017-01-13T01:54:34.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-01-13</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 kelele67
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
<script type="text/javascript">
var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260501136'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1260501136%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));
</script>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/"
	}
</script>

<script src="/./main.js"></script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/algorithm/" style="font-size: 20px;">algorithm</a> <a href="/tags/animation/" style="font-size: 16.67px;">animation</a> <a href="/tags/c/" style="font-size: 16.67px;">c</a> <a href="/tags/c/" style="font-size: 20px;">c++</a> <a href="/tags/concurrency/" style="font-size: 20px;">concurrency</a> <a href="/tags/data-structures/" style="font-size: 10px;">data structures</a> <a href="/tags/gc/" style="font-size: 13.33px;">gc</a> <a href="/tags/html5/" style="font-size: 10px;">html5</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/ios/" style="font-size: 10px;">ios</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/lua/" style="font-size: 13.33px;">lua</a> <a href="/tags/mount/" style="font-size: 10px;">mount</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/search/" style="font-size: 10px;">search</a> <a href="/tags/siri/" style="font-size: 10px;">siri</a> <a href="/tags/solution/" style="font-size: 10px;">solution</a> <a href="/tags/sort/" style="font-size: 10px;">sort</a> <a href="/tags/swift/" style="font-size: 16.67px;">swift</a> <a href="/tags/systemd/" style="font-size: 10px;">systemd</a> <a href="/tags/sysvinit/" style="font-size: 10px;">sysvinit</a> <a href="/tags/thread/" style="font-size: 13.33px;">thread</a> <a href="/tags/threadpool/" style="font-size: 13.33px;">threadpool</a> <a href="/tags/trees/" style="font-size: 10px;">trees</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/upstart/" style="font-size: 10px;">upstart</a> <a href="/tags/web-server/" style="font-size: 10px;">web server</a> <a href="/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
    			</div>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">&lt;div class=&quot;text&quot; style=&quot; text-align:center;&quot;&gt;大三学生&lt;br&gt;就读于重庆大学 软件狗&lt;br&gt;&lt;br&gt; 喜欢python&lt;br&gt;自由的灵魂&lt;br&gt;&lt;br&gt;世界万物都是隐喻&lt;br&gt;我们是通过隐喻这个装置接受反讽&lt;br&gt;加深扩大自己&lt;/div&gt;</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>
