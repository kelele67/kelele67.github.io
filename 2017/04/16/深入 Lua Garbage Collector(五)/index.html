<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="c,lua,gc," />








  <link rel="shortcut icon" type="image/x-icon" href="/icon/bird.ico?v=5.1.1" />






<meta name="description" content="有了前几天的基础，我们可以从顶向下来读 lua gc 部分的代码了。慢慢的，感觉我这个系列都可以叫跟着云风一起看Lua源码了，虽然自己看的是最新的5.3。挖个坑，之后应该会真的跟着云风大大的那本readinglua一起看完lua的最新源码。">
<meta name="keywords" content="c,lua,gc">
<meta property="og:type" content="article">
<meta property="og:title" content="深入 Lua Garbage Collector(五)">
<meta property="og:url" content="http://yoursite.com/2017/04/16/深入 Lua Garbage Collector(五)/index.html">
<meta property="og:site_name" content="树犹如此|人何以堪">
<meta property="og:description" content="有了前几天的基础，我们可以从顶向下来读 lua gc 部分的代码了。慢慢的，感觉我这个系列都可以叫跟着云风一起看Lua源码了，虽然自己看的是最新的5.3。挖个坑，之后应该会真的跟着云风大大的那本readinglua一起看完lua的最新源码。">
<meta property="og:updated_time" content="2017-05-16T03:59:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入 Lua Garbage Collector(五)">
<meta name="twitter:description" content="有了前几天的基础，我们可以从顶向下来读 lua gc 部分的代码了。慢慢的，感觉我这个系列都可以叫跟着云风一起看Lua源码了，虽然自己看的是最新的5.3。挖个坑，之后应该会真的跟着云风大大的那本readinglua一起看完lua的最新源码。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'U0JYTSJKPY',
      apiKey: 'f3499a45aff4dffb505b45c35dd42268',
      indexName: 'hexo',
      hits: {"per_page":10},
      labels: {"input_placeholder":"搜索本站","hits_empty":"未找到 ${query} 相关内容","hits_stats":"${hits} 条相关条目，耗时${time} 毫秒"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/04/16/深入 Lua Garbage Collector(五)/"/>





  <title>深入 Lua Garbage Collector(五) | 树犹如此|人何以堪</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  







  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=62141337";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">树犹如此|人何以堪</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">做一个富有的废物</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/深入 Lua Garbage Collector(五)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kelele67">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oe9uedqb2.bkt.clouddn.com/4D9F59FD6F416AF4A92C4B977580BD95.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="树犹如此|人何以堪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">深入 Lua Garbage Collector(五)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T09:24:52+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/16/深入 Lua Garbage Collector(五)/" class="leancloud_visitors" data-flag-title="深入 Lua Garbage Collector(五)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>

</p><p>有了前几天的基础，我们可以从顶向下来读 lua gc 部分的代码了。<br>慢慢的，感觉我这个系列都可以叫跟着云风一起看Lua源码了，虽然自己看的是最新的5.3。挖个坑，之后应该会真的跟着云风大大的那本readinglua一起看完lua的最新源码。</p>
<a id="more"></a>
<h3 id="lua-gc"><a href="#lua-gc" class="headerlink" title="lua_gc"></a>lua_gc</h3><p>我们知道，lua 对外的 API 中，一切和 gc 打交道的都通过 lua_gc 。<br>C 语言构建系统时，一般不讲设计模式。但模式还是存在的。若要按《设计模式》中的分类，这应该归于 Facade 模式。代码在 lapi.c 的 1011 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** Garbage-collection function</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="function">LUA_API <span class="keyword">int</span> <span class="title">lua_gc</span> <span class="params">(lua_State *L, <span class="keyword">int</span> what, <span class="keyword">int</span> data)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> res = <span class="number">0</span>;</div><div class="line">  global_State *g;</div><div class="line">  lua_lock(L);</div><div class="line">  g = G(L);</div><div class="line">  <span class="keyword">switch</span> (what) &#123;</div><div class="line">    <span class="keyword">case</span> LUA_GCSTOP: &#123;</div><div class="line">      g-&gt;gcrunning = <span class="number">0</span>;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> LUA_GCRESTART: &#123;</div><div class="line">      luaE_setdebt(g, <span class="number">0</span>);</div><div class="line">      g-&gt;gcrunning = <span class="number">1</span>;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> LUA_GCCOLLECT: &#123;</div><div class="line">      luaC_fullgc(L, <span class="number">0</span>);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> LUA_GCCOUNT: &#123;</div><div class="line">      <span class="comment">/* GC values are expressed in Kbytes: #bytes/2^10 */</span></div><div class="line">      res = cast_int(gettotalbytes(g) &gt;&gt; <span class="number">10</span>);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> LUA_GCCOUNTB: &#123;</div><div class="line">      res = cast_int(gettotalbytes(g) &amp; <span class="number">0x3ff</span>);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> LUA_GCSTEP: &#123;</div><div class="line">      l_mem debt = <span class="number">1</span>;  <span class="comment">/* =1 to signal that it did an actual step */</span></div><div class="line">      <span class="keyword">int</span> oldrunning = g-&gt;gcrunning;</div><div class="line">      g-&gt;gcrunning = <span class="number">1</span>;  <span class="comment">/* allow GC to run */</span></div><div class="line">      <span class="keyword">if</span> (data == <span class="number">0</span>) &#123;</div><div class="line">        luaE_setdebt(g, -GCSTEPSIZE);  <span class="comment">/* to do a "small" step */</span></div><div class="line">        luaC_step(L);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> &#123;  <span class="comment">/* add 'data' to total debt */</span></div><div class="line">        debt = cast(l_mem, data) * <span class="number">1024</span> + g-&gt;GCdebt;</div><div class="line">        luaE_setdebt(g, debt);</div><div class="line">        luaC_checkGC(L);</div><div class="line">      &#125;</div><div class="line">      g-&gt;gcrunning = oldrunning;  <span class="comment">/* restore previous state */</span></div><div class="line">      <span class="keyword">if</span> (debt &gt; <span class="number">0</span> &amp;&amp; g-&gt;gcstate == GCSpause)  <span class="comment">/* end of cycle? */</span></div><div class="line">        res = <span class="number">1</span>;  <span class="comment">/* signal it */</span></div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> LUA_GCSETPAUSE: &#123;</div><div class="line">      res = g-&gt;gcpause;</div><div class="line">      g-&gt;gcpause = data;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> LUA_GCSETSTEPMUL: &#123;</div><div class="line">      res = g-&gt;gcstepmul;</div><div class="line">      <span class="keyword">if</span> (data &lt; <span class="number">40</span>) data = <span class="number">40</span>;  <span class="comment">/* avoid ridiculous low values (and 0) */</span></div><div class="line">      g-&gt;gcstepmul = data;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> LUA_GCISRUNNING: &#123;</div><div class="line">      res = g-&gt;gcrunning;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">default</span>: res = <span class="number">-1</span>;  <span class="comment">/* invalid option */</span></div><div class="line">  &#125;</div><div class="line">  lua_unlock(L);</div><div class="line">  <span class="keyword">return</span> res;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>从代码可见，对内部状态的访问，都是直接访问 global_State 表的。</p>
<h3 id="luaC-xxx-api"><a href="#luaC-xxx-api" class="headerlink" title="luaC_xxx api"></a>luaC_xxx api</h3><p>GC 控制则是调用内部 api 。lua 中对外的 api 和内部模块交互的 api 都是分开的。这样层次分明。内部子模块一般名为 luaX_xxx X 为子模块代号。对于收集器相关的 api 一律以 luaC_xxx 命名。这些 api 定义在 lgc.h 中。</p>
<p>此间提到的 api 有两个：</p>
<p>①. luaC_step</p>
<p>②. luaC_fullgc</p>
<p>见lgc.h 的 127和129 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function">LUAI_FUNC <span class="keyword">void</span> <span class="title">luaC_step</span> <span class="params">(lua_State *L)</span></span>;</div><div class="line"><span class="function">LUAI_FUNC <span class="keyword">void</span> <span class="title">luaC_fullgc</span> <span class="params">(lua_State *L, <span class="keyword">int</span> isemergency)</span></span>;</div></pre></td></tr></table></figure>
<hr>
<p>分别用于分步 GC 与 完整 GC 。</p>
<h4 id="luaC-condGC"><a href="#luaC-condGC" class="headerlink" title="luaC_condGC"></a>luaC_condGC</h4><p>另一个重要的 api 是104行 的luaC_condGC:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> luaC_condGC(L,c) \</span></div><div class="line">&#123;<span class="meta-keyword">if</span> (G(L)-&gt;GCdebt &gt; 0) &#123;c;&#125;; condchangemem(L);&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> luaC_checkGC(L)		luaC_condGC(L, luaC_step(L);)</span></div></pre></td></tr></table></figure>
<hr>
<h5 id="condchangemem函数"><a href="#condchangemem函数" class="headerlink" title="condchangemem函数"></a>condchangemem函数</h5><p>其中 condchangemem()函数在llimits.h的 228 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** macro to control inclusion of some hard tests on stack reallocation</div><div class="line">*/</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(HARDSTACKTESTS)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> condmovestack(L)	((void)0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="comment">/* realloc stack keeping its size */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> condmovestack(L)	luaD_reallocstack((L), (L)-&gt;stacksize)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(HARDMEMTESTS)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> condchangemem(L)	condmovestack(L)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> condchangemem(L)  \</span></div><div class="line">	((void)(!(G(L)-&gt;gcrunning) || (luaC_fullgc(L, 0), 1)))</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<hr>
<p>如果有hard memory tests就会重新分配stack空间(通常不存在)，其中 luaD_reallocstack 定义在ldo.h的38行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">LUAI_FUNC <span class="keyword">void</span> <span class="title">luaD_reallocstack</span> <span class="params">(lua_State *L, <span class="keyword">int</span> newsize)</span></span>;</div></pre></td></tr></table></figure>
<hr>
<p>通过以上的代码可以看到luaC_condGC是以宏形式定义出来，用于自动的 GC 。如果我们审查 lapi.c ldo.c lvm.c ，会发现大部分会导致内存增长的 api 中，都调用了它。保证 gc 可以随内存使用增加而自动进行。</p>
<blockquote>
<p>使用自动gc的问题</p>
</blockquote>
<p>它很可能使系统的峰值内存占用远超过实际需求量。原因就在于，收集行为往往发生在调用栈很深的地方。当你的应用程序呈现出某种周期性（大多数包驱动的服务都是这样）。在一个服务周期内，往往会引用众多临时对象，这个时候做 mark 工作，会导致许多临时对象也被 mark 住。</p>
<p>一个经验方法是，调用 LUA_GCSTOP 停止自动 GC。在周期间定期调用 gcstep 且使用较大的 data 值，在有限个周期做完一整趟 gc 。</p>
<h4 id="luaC-fullgc"><a href="#luaC-fullgc" class="headerlink" title="luaC_fullgc"></a>luaC_fullgc</h4><p>我们先来看 luaC_fullgc 。它用来执行完整的一次 gc 动作。fullgc 并不是仅仅把当前的流程走完。因为之前的 gc 行为可能执行了一半，可能有一些半路加进来的需要回收的对象。所以在走完一趟流程后，fullgc 将阻塞着再完整跑一遍 gc 。整个流程有一些优化的余地。即，前半程的 gc 流程其实不必严格执行，它并不需要真的去清除什么。只需要把状态恢复。这个工作是如何做到的呢？见 lgc.c 的 1128 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** Performs a full GC cycle; if 'isemergency', set a flag to avoid</div><div class="line">** some operations which could change the interpreter state in some</div><div class="line">** unexpected ways (running finalizers and shrinking some structures).</div><div class="line">** Before running the collection, check 'keepinvariant'; if it is true,</div><div class="line">** there may be some objects marked as black, so the collector has</div><div class="line">** to sweep all objects to turn them back to white (as white has not</div><div class="line">** changed, nothing will be collected).</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">luaC_fullgc</span> <span class="params">(lua_State *L, <span class="keyword">int</span> isemergency)</span> </span>&#123;</div><div class="line">  global_State *g = G(L);</div><div class="line">  lua_assert(g-&gt;gckind == KGC_NORMAL);</div><div class="line">  <span class="keyword">if</span> (isemergency) g-&gt;gckind = KGC_EMERGENCY;  <span class="comment">/* set flag */</span></div><div class="line">  <span class="keyword">if</span> (keepinvariant(g)) &#123;  <span class="comment">/* black objects? */</span></div><div class="line">    entersweep(L); <span class="comment">/* sweep everything to turn them back to white */</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">/* finish any pending sweep phase to start a new cycle */</span></div><div class="line">  luaC_runtilstate(L, bitmask(GCSpause));</div><div class="line">  luaC_runtilstate(L, ~bitmask(GCSpause));  <span class="comment">/* start new collection */</span></div><div class="line">  luaC_runtilstate(L, bitmask(GCScallfin));  <span class="comment">/* run up to finalizers */</span></div><div class="line">  <span class="comment">/* estimate must be correct after a full GC cycle */</span></div><div class="line">  lua_assert(g-&gt;GCestimate == gettotalbytes(g));</div><div class="line">  luaC_runtilstate(L, bitmask(GCSpause));  <span class="comment">/* finish collection */</span></div><div class="line">  g-&gt;gckind = KGC_NORMAL;</div><div class="line">  setpause(g);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>比较耗时的 mark 步骤被简单跳过了（如果它还没进行完的话）。和正常的 mark 流程不同，正常的 mark 流程最后，会将白色标记反转。见 lgc.c 994 行，atomic 函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">g-&gt;currentwhite = cast_byte(otherwhite(g));  <span class="comment">/* flip current white */</span></div></pre></td></tr></table></figure>
<hr>
<p>在 fullgc 的前半程中，直接跳过了 GCSpropagate ，重置了内部状态，但没有翻转白色标记。这会导致后面的 sweep 流程不会真的释放那些白色对象。sweep 工作实际做的只是把所有对象又重新设置回白色而已。</p>
<h4 id="luaC-step"><a href="#luaC-step" class="headerlink" title="luaC_step"></a>luaC_step</h4><p>接下来就是一个完整不被打断的 gc 过程了，我们来看luaC_step。</p>
<p>lgc.c 的 1098 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** performs a basic GC step when collector is running</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">luaC_step</span> <span class="params">(lua_State *L)</span> </span>&#123;</div><div class="line">  global_State *g = G(L);</div><div class="line">  l_mem debt = getdebt(g);  <span class="comment">/* GC deficit (be paid now) */</span></div><div class="line">  <span class="keyword">if</span> (!g-&gt;gcrunning) &#123;  <span class="comment">/* not running? */</span></div><div class="line">    luaE_setdebt(g, -GCSTEPSIZE * <span class="number">10</span>);  <span class="comment">/* avoid being called too often */</span></div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">do</span> &#123;  <span class="comment">/* repeat until pause or enough "credit" (negative debt) */</span></div><div class="line">    lu_mem work = singlestep(L);  <span class="comment">/* perform one single step */</span></div><div class="line">    debt -= work;</div><div class="line">  &#125; <span class="keyword">while</span> (debt &gt; -GCSTEPSIZE &amp;&amp; g-&gt;gcstate != GCSpause);</div><div class="line">  <span class="keyword">if</span> (g-&gt;gcstate == GCSpause)</div><div class="line">    setpause(g);  <span class="comment">/* pause until next cycle */</span></div><div class="line">  <span class="keyword">else</span> &#123;</div><div class="line">    debt = (debt / g-&gt;gcstepmul) * STEPMULADJ;  <span class="comment">/* convert 'work units' to Kb */</span></div><div class="line">    luaE_setdebt(g, debt);</div><div class="line">    runafewfinalizers(L);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h5 id="restartcollection函数"><a href="#restartcollection函数" class="headerlink" title="restartcollection函数"></a>restartcollection函数</h5><p>在上一篇我们也提到了GCPause 步骤中的 restartcollection，从名字就可以看出来，这是开始了新一轮的的mark，来收集要GC的对象。</p>
<p>lgc.c 323 行: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** mark root set and reset all gray lists, to start a new collection</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">restartcollection</span> <span class="params">(global_State *g)</span> </span>&#123;</div><div class="line">  g-&gt;gray = g-&gt;grayagain = <span class="literal">NULL</span>;</div><div class="line">  g-&gt;weak = g-&gt;allweak = g-&gt;ephemeron = <span class="literal">NULL</span>;</div><div class="line">  markobject(g, g-&gt;mainthread);</div><div class="line">  markvalue(g, &amp;g-&gt;l_registry);</div><div class="line">  markmt(g);</div><div class="line">  markbeingfnz(g);  <span class="comment">/* mark any finalizing object left from previous cycle */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h5 id="GCdebt"><a href="#GCdebt" class="headerlink" title="GCdebt"></a>GCdebt</h5><p>这里面还涉及到一个global_State里面定义的GCdebt，是那些没有获得补偿的分配的字节。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">l_mem GCdebt;  <span class="comment">/* bytes allocated not yet compensated by the collector */</span></div></pre></td></tr></table></figure>
<hr>
<p>而定义在lstate.c 97行的是为了更新GCdebt的值:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** set GCdebt to a new value keeping the value (totalbytes + GCdebt)</div><div class="line">** invariant</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">luaE_setdebt</span> <span class="params">(global_State *g, l_mem debt)</span> </span>&#123;</div><div class="line">  g-&gt;totalbytes -= (debt - g-&gt;GCdebt);</div><div class="line">  g-&gt;GCdebt = debt;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h5 id="runafewfinalizers函数"><a href="#runafewfinalizers函数" class="headerlink" title="runafewfinalizers函数"></a>runafewfinalizers函数</h5><p>最后的runafewfinalizers函数则是在</p>
<p>lgc.c 的 813 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** call a few (up to 'g-&gt;gcfinnum') finalizers</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runafewfinalizers</span> <span class="params">(lua_State *L)</span> </span>&#123;</div><div class="line">  global_State *g = G(L);</div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</div><div class="line">  lua_assert(!g-&gt;tobefnz || g-&gt;gcfinnum &gt; <span class="number">0</span>);</div><div class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; g-&gt;tobefnz &amp;&amp; i &lt; g-&gt;gcfinnum; i++)</div><div class="line">    GCTM(L, <span class="number">1</span>);  <span class="comment">/* call one finalizer */</span></div><div class="line">  g-&gt;gcfinnum = (!g-&gt;tobefnz) ? <span class="number">0</span>  <span class="comment">/* nothing more to finalize? */</span></div><div class="line">                    : g-&gt;gcfinnum * <span class="number">2</span>;  <span class="comment">/* else call a few more next time */</span></div><div class="line">  <span class="keyword">return</span> i;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>从GCPause开始，一直经历我们上一篇介绍的几个步骤，直到整个 gc 流程执行完毕。接着更新GCdebt的值，最后进行少量的finalizers也就是runafewfinalizers。</p>
<h3 id="gcpause-和-gcstepmul"><a href="#gcpause-和-gcstepmul" class="headerlink" title="gcpause 和 gcstepmul"></a>gcpause 和 gcstepmul</h3><p>gcpause 和 gcstepmul定义在</p>
<p>lstate.h 的 135 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> gcpause;  <span class="comment">/* size of pause between successive GCs */</span></div><div class="line"><span class="keyword">int</span> gcstepmul;  <span class="comment">/* GC 'granularity' */</span></div></pre></td></tr></table></figure>
<hr>
<p>luaC_step: 发起一步增量垃圾收集。 步数由 data 控制（越大的值意味着越多步）， 而其具体含义（具体数字表示了多少）并未标准化。 如果你想控制这个步数，必须实验性的测试 data 的值。 如果这一步结束了一个垃圾收集周期，返回返回 1 。 并没有给出准确的含义。实践中，我们也都是以经验取值。</p>
<p>回到源代码，我们就能搞清楚它们到底是什么了。</p>
<p>lapi.c 1057 行的LUA_API int lua_gc中:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> LUA_GCSETPAUSE: &#123;</div><div class="line">  res = g-&gt;gcpause;</div><div class="line">  g-&gt;gcpause = data;</div><div class="line">  <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> GCSpause: &#123;</div><div class="line">  g-&gt;GCmemtrav = g-&gt;strt.size * <span class="keyword">sizeof</span>(GCObject*);</div><div class="line">  restartcollection(g);</div><div class="line">  g-&gt;gcstate = GCSpropagate;</div><div class="line">  <span class="keyword">return</span> g-&gt;GCmemtrav;</div><div class="line">&#125;</div><div class="line"><span class="keyword">case</span> LUA_GCSETSTEPMUL: &#123;</div><div class="line">  res = g-&gt;gcstepmul;</div><div class="line">  <span class="keyword">if</span> (data &lt; <span class="number">40</span>) data = <span class="number">40</span>;  <span class="comment">/* avoid ridiculous low values (and 0) */</span></div><div class="line">  g-&gt;gcstepmul = data;</div><div class="line">  <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>这里只是设置 gcpause gcstepmul。</p>
<p>其中的一些变量都是定义在global_State的:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">lu_mem GCmemtrav;  <span class="comment">/* memory traversed by the GC */</span></div><div class="line">lu_mem GCestimate;  <span class="comment">/* an estimate of the non-garbage memory in use */</span></div><div class="line">stringtable strt;  <span class="comment">/* hash table for strings */</span></div></pre></td></tr></table></figure>
<hr>
<h4 id="gcpause"><a href="#gcpause" class="headerlink" title="gcpause"></a>gcpause</h4><p>gcpause 实际只在 lgc.c 909 行的 setpause函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** Set a reasonable "time" to wait before starting a new GC cycle; cycle</div><div class="line">** will start when memory use hits threshold. (Division by 'estimate'</div><div class="line">** should be OK: it cannot be zero (because Lua cannot even start with</div><div class="line">** less than PAUSEADJ bytes).</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setpause</span> <span class="params">(global_State *g)</span> </span>&#123;</div><div class="line">  l_mem threshold, debt;</div><div class="line">  l_mem estimate = g-&gt;GCestimate / PAUSEADJ;  <span class="comment">/* adjust 'estimate' */</span></div><div class="line">  lua_assert(estimate &gt; <span class="number">0</span>);</div><div class="line">  threshold = (g-&gt;gcpause &lt; MAX_LMEM / estimate)  <span class="comment">/* overflow? */</span></div><div class="line">            ? estimate * g-&gt;gcpause  <span class="comment">/* no overflow */</span></div><div class="line">            : MAX_LMEM;  <span class="comment">/* overflow; truncate to maximum */</span></div><div class="line">  debt = gettotalbytes(g) - threshold;</div><div class="line">  luaE_setdebt(g, debt);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>setpause也被包含在luaC_step中，可以看见，GCSETPAUSE 其实是通过调整 threshold 来实现的。当 threshold 足够大时，luaC_step 不会被 luaC_checkGC 自动触发。</p>
<p>gcpause 值的含义很文档一致，用来表示和实际内存使用量 estimate 的比值。一旦内存使用量超过这个阀值，就会触发 GC 的工作。</p>
<h4 id="gcstepmul"><a href="#gcstepmul" class="headerlink" title="gcstepmul"></a>gcstepmul</h4><p>要理解 gcstepmul ，就要从 lua_gc 的 LUA_GCSTEP 的实现看起。</p>
<h5 id="LUA-GCSTEP"><a href="#LUA-GCSTEP" class="headerlink" title="LUA_GCSTEP"></a>LUA_GCSTEP</h5><p>lapi.c 1039 的 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> LUA_GCSTEP: &#123;</div><div class="line">  l_mem debt = <span class="number">1</span>;  <span class="comment">/* =1 to signal that it did an actual step */</span></div><div class="line">  <span class="keyword">int</span> oldrunning = g-&gt;gcrunning;</div><div class="line">  g-&gt;gcrunning = <span class="number">1</span>;  <span class="comment">/* allow GC to run */</span></div><div class="line">  <span class="keyword">if</span> (data == <span class="number">0</span>) &#123;</div><div class="line">    luaE_setdebt(g, -GCSTEPSIZE);  <span class="comment">/* to do a "small" step */</span></div><div class="line">    luaC_step(L);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span> &#123;  <span class="comment">/* add 'data' to total debt */</span></div><div class="line">    debt = cast(l_mem, data) * <span class="number">1024</span> + g-&gt;GCdebt;</div><div class="line">    luaE_setdebt(g, debt);</div><div class="line">    luaC_checkGC(L);</div><div class="line">  &#125;</div><div class="line">  g-&gt;gcrunning = oldrunning;  <span class="comment">/* restore previous state */</span></div><div class="line">  <span class="keyword">if</span> (debt &gt; <span class="number">0</span> &amp;&amp; g-&gt;gcstate == GCSpause)  <span class="comment">/* end of cycle? */</span></div><div class="line">    res = <span class="number">1</span>;  <span class="comment">/* signal it */</span></div><div class="line">  <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>step的长度debt 的 data 被放大了 1024 倍。在 lgc.h 的 20 行，也可以看到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* how much to allocate before next GC step */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(GCSTEPSIZE)</span></div><div class="line"><span class="comment">/* ~100 small strings */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GCSTEPSIZE	(cast_int(100 * sizeof(TString)))</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<hr>
<p>我们姑且可以认为 data 的单位是 KBytes ，和 lua 总共占用的内存 totalbytes 有些关系。</p>
<h5 id="totalbytes"><a href="#totalbytes" class="headerlink" title="totalbytes"></a>totalbytes</h5><blockquote>
<p>这里 totalbytes 是严格通过 Alloc 管理的内存量。</p>
</blockquote>
<p>也被定义在global_State中:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lu_mem totalbytes;  <span class="comment">/* number of bytes currently allocated - GCdebt */</span></div></pre></td></tr></table></figure>
<hr>
<p>而前面提到的 estimate 则不同，它是一个估算量，比 totalbytes 要小。这是因为，前面也提到过，userdata 的回收比较特殊。被检测出已经访问不到的 userdata 占用的内存并不会马上释放（保证 gc 元方法的安全调用），但 estimate 会抛去这部分，不算在实际内存使用量内。</p>
<p>见 lgc.c 的 849 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** move all unreachable objects (or 'all' objects) that need</div><div class="line">** finalization from list 'finobj' to list 'tobefnz' (to be finalized)</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">separatetobefnz</span> <span class="params">(global_State *g, <span class="keyword">int</span> all)</span> </span>&#123;</div><div class="line">  GCObject *curr;</div><div class="line">  GCObject **p = &amp;g-&gt;finobj;</div><div class="line">  GCObject **lastnext = findlast(&amp;g-&gt;tobefnz);</div><div class="line">  <span class="keyword">while</span> ((curr = *p) != <span class="literal">NULL</span>) &#123;  <span class="comment">/* traverse all finalizable objects */</span></div><div class="line">    lua_assert(tofinalize(curr));</div><div class="line">    <span class="keyword">if</span> (!(iswhite(curr) || all))  <span class="comment">/* not being collected? */</span></div><div class="line">      p = &amp;curr-&gt;next;  <span class="comment">/* don't bother with it */</span></div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">      *p = curr-&gt;next;  <span class="comment">/* remove 'curr' from 'finobj' list */</span></div><div class="line">      curr-&gt;next = *lastnext;  <span class="comment">/* link at the end of 'tobefnz' list */</span></div><div class="line">      *lastnext = curr;</div><div class="line">      lastnext = &amp;curr-&gt;next;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>以及 1039 行:<br>GCSatomic case 里面的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">g-&gt;GCestimate = gettotalbytes(g);  <span class="comment">/* first estimate */</span>;</div></pre></td></tr></table></figure>
<hr>
<p>lstate.c 的 412 行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* actual number of total bytes allocated */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> gettotalbytes(g)	((g)-&gt;totalbytes + (g)-&gt;GCdebt)</span></div></pre></td></tr></table></figure>
<hr>
<p>从代码逻辑，我们暂时可以把 data 理解为，需要处理的字节数量（以 K bytes 为单位）。如果需要处理的数据量超过了 totalbytes ，自然就可以把 threshold 设置为 0 了。</p>
<blockquote>
<p>实际上不能完全这么理解。因为 GC 过程并不是一点点回收内存，同时可用内存越来越多。GC 分标记(mark) 清除(sweep) 调用 userdata 元方法等几个阶段。只有中间的清除阶段是真正释放内存的。所以可用内存的增加（ totalbytes 减少）过程，时间上并不是线性的。通常标记的开销更大。为了让 gcstep 的每个步骤消耗的时间更平滑，就得有手段动态调整 threshold 值。它和 totalbytes 最终影响了每个 step 的时间。</p>
</blockquote>
<p>再回到我们之前的luaC_step，见 lgc.c 的 1098 行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** performs a basic GC step when collector is running</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">luaC_step</span> <span class="params">(lua_State *L)</span> </span>&#123;</div><div class="line">  global_State *g = G(L);</div><div class="line">  l_mem debt = getdebt(g);  <span class="comment">/* GC deficit (be paid now) */</span></div><div class="line">  <span class="keyword">if</span> (!g-&gt;gcrunning) &#123;  <span class="comment">/* not running? */</span></div><div class="line">    luaE_setdebt(g, -GCSTEPSIZE * <span class="number">10</span>);  <span class="comment">/* avoid being called too often */</span></div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">do</span> &#123;  <span class="comment">/* repeat until pause or enough "credit" (negative debt) */</span></div><div class="line">    lu_mem work = singlestep(L);  <span class="comment">/* perform one single step */</span></div><div class="line">    debt -= work;</div><div class="line">  &#125; <span class="keyword">while</span> (debt &gt; -GCSTEPSIZE &amp;&amp; g-&gt;gcstate != GCSpause);</div><div class="line">  <span class="keyword">if</span> (g-&gt;gcstate == GCSpause)</div><div class="line">    setpause(g);  <span class="comment">/* pause until next cycle */</span></div><div class="line">  <span class="keyword">else</span> &#123;</div><div class="line">    debt = (debt / g-&gt;gcstepmul) * STEPMULADJ;  <span class="comment">/* convert 'work units' to Kb */</span></div><div class="line">    luaE_setdebt(g, debt);</div><div class="line">    runafewfinalizers(L);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>从代码我们可以看到，GC 的核心其实在于 singlestep 函数。luaC_step 每次调用多少次 singlestep 跟 gcstepmul 的值有关。</p>
<p>而lgc.c 48行定义了去调整stepmul的宏:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">** macro to adjust 'stepmul': 'stepmul' is actually used like</div><div class="line">** 'stepmul / STEPMULADJ' (value chosen by tests)</div><div class="line">*/</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> STEPMULADJ		200</span></div></pre></td></tr></table></figure>
<hr>
<p>如果是自动进行的 GC ，当 totalbytes 大于等于 threshold 时，就会触发 luaC_step 。每次 luaC_step ，threshold 都会被调高 1K (GCSTEPSIZE) 直到 threshold 追上 totalbytes 。这个追赶过程通常发生在 mark 流程。因为这个流程中，totalbytes 是只增不减的。</p>
<p>如果是手控 GC ，每次 gcstep 调用执行多少次 luaC_step 则跟 data 值有关。大体上是 100 就表示一次（在 mark 过程中就是这样）到了 sweep 流程就不一定了。这和 singlestep 调用次数，即 gcstepmul 的值有关。它影响了 totalbytes 的减小速度。</p>
<p>所以，一两句话很难严格定义出这些控制 GC 步进量的参数的含义，只能慢慢阅读代码，看看实现了。</p>
<p>在 lua 手册的700 行这样描述step multiplier:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></div><div class="line">The garbage-collector step multiplier</div><div class="line">controls the relative speed of the collector relative to</div><div class="line">memory allocation.</div><div class="line">Larger values make the collector more aggressive but also increase</div><div class="line">the size of each incremental step.</div><div class="line">You should not use values smaller than 100,</div><div class="line">because they make the collector too slow and</div><div class="line">can result in the collector never finishing a cycle.</div><div class="line">The default is 200,</div><div class="line">which means that the collector runs at "twice"</div><div class="line">the speed of memory allocation.</div></pre></td></tr></table></figure>
<hr>
<p>控制了收集器相对内存分配的速度。更大的数字将导致收集器工作的更主动的同时，也使每步收集的尺寸增加。小于 100 的值会使收集器工作的非常慢，可能导致收集器永远都结束不了当前周期。 缺省值为200 ，这意味着收集器将以内存分配器的两倍速运行。”</p>
<p>从代码看，这绝非严格定义。至少从今天已经分析的代码中还看不出这一点。</p>
<p>gcstepmul 的值和内存增涨速度如何产生联系？请看下回分解</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://blog.codingnow.com/2011/03/lua_gc_3.html" target="_blank" rel="external">云风的 BLOG</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/c/" rel="tag"># c</a>
          
            <a href="/tags/lua/" rel="tag"># lua</a>
          
            <a href="/tags/gc/" rel="tag"># gc</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/15/深入 Lua Garbage Collector(四)/" rel="next" title="深入 Lua Garbage Collector(四)">
                <i class="fa fa-chevron-left"></i> 深入 Lua Garbage Collector(四)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/17/深入 Lua Garbage Collector(六)/" rel="prev" title="深入 Lua Garbage Collector(六)">
                深入 Lua Garbage Collector(六) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODY1MC81MjIx"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oe9uedqb2.bkt.clouddn.com/4D9F59FD6F416AF4A92C4B977580BD95.png"
               alt="kelele67" />
          <p class="site-author-name" itemprop="name">kelele67</p>
           
              <p class="site-description motion-element" itemprop="description">古老却神奇的shell表白代码 :(){:|:&};:</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">57</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">59</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/kelele67" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/kelele67" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/liu-qi-21-51" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#lua-gc"><span class="nav-number">1.</span> <span class="nav-text">lua_gc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#luaC-xxx-api"><span class="nav-number">2.</span> <span class="nav-text">luaC_xxx api</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#luaC-condGC"><span class="nav-number">2.1.</span> <span class="nav-text">luaC_condGC</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#condchangemem函数"><span class="nav-number">2.1.1.</span> <span class="nav-text">condchangemem函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#luaC-fullgc"><span class="nav-number">2.2.</span> <span class="nav-text">luaC_fullgc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#luaC-step"><span class="nav-number">2.3.</span> <span class="nav-text">luaC_step</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#restartcollection函数"><span class="nav-number">2.3.1.</span> <span class="nav-text">restartcollection函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GCdebt"><span class="nav-number">2.3.2.</span> <span class="nav-text">GCdebt</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#runafewfinalizers函数"><span class="nav-number">2.3.3.</span> <span class="nav-text">runafewfinalizers函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gcpause-和-gcstepmul"><span class="nav-number">3.</span> <span class="nav-text">gcpause 和 gcstepmul</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#gcpause"><span class="nav-number">3.1.</span> <span class="nav-text">gcpause</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gcstepmul"><span class="nav-number">3.2.</span> <span class="nav-text">gcstepmul</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#LUA-GCSTEP"><span class="nav-number">3.2.1.</span> <span class="nav-text">LUA_GCSTEP</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#totalbytes"><span class="nav-number">3.2.2.</span> <span class="nav-text">totalbytes</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number"></span> <span class="nav-text">参考</span></a></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kelele67</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.1"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("uu22m818WHNRkNyNn5ifFEYU-gzGzoHsz", "wczk27BwQ0jGSE3uOFqH9974");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
