<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="python," />








  <link rel="shortcut icon" type="image/x-icon" href="/icon/bird.ico?v=5.1.1" />






<meta name="description" content="闲来无事，总结一下常用到的python技巧 目录 数据结构  迭代协议  字符串  I/O  数据处理  类和对象  并发编程  装饰器">
<meta name="keywords" content="python">
<meta property="og:type" content="article">
<meta property="og:title" content="python技巧全面总结">
<meta property="og:url" content="http://yoursite.com/2017/10/01/python技巧全面总结/index.html">
<meta property="og:site_name" content="趣果有间">
<meta property="og:description" content="闲来无事，总结一下常用到的python技巧 目录 数据结构  迭代协议  字符串  I/O  数据处理  类和对象  并发编程  装饰器">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-10-07T02:42:33.853Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="python技巧全面总结">
<meta name="twitter:description" content="闲来无事，总结一下常用到的python技巧 目录 数据结构  迭代协议  字符串  I/O  数据处理  类和对象  并发编程  装饰器">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'U0JYTSJKPY',
      apiKey: 'f3499a45aff4dffb505b45c35dd42268',
      indexName: 'hexo',
      hits: {"per_page":10},
      labels: {"input_placeholder":"搜索本站","hits_empty":"未找到 ${query} 相关内容","hits_stats":"${hits} 条相关条目，耗时${time} 毫秒"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/10/01/python技巧全面总结/"/>





  <title>python技巧全面总结 | 趣果有间</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  







  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=62141337";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">趣果有间</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">凡人皆无法挡</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/01/python技巧全面总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kelele67">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oe9uinblw.bkt.clouddn.com/avater67.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="趣果有间">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">python技巧全面总结</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-01T01:20:03+08:00">
                2017-10-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/10/01/python技巧全面总结/" class="leancloud_visitors" data-flag-title="python技巧全面总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>

</p><p>闲来无事，总结一下常用到的python技巧</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li>数据结构 </li>
<li>迭代协议 </li>
<li>字符串 </li>
<li>I/O </li>
<li>数据处理 </li>
<li>类和对象 </li>
<li>并发编程 </li>
<li>装饰器</li>
</ul>
<a id="more"></a>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><h3 id="2-1-Pythonic-筛选数据"><a href="#2-1-Pythonic-筛选数据" class="headerlink" title="2.1 Pythonic 筛选数据"></a>2.1 Pythonic 筛选数据</h3><ol>
<li><blockquote>
<p>[for … if …]</p>
</blockquote>
</li>
<li><blockquote>
<p>Filiter(lambda)</p>
</blockquote>
</li>
</ol>
<h3 id="2-2-Dict命名"><a href="#2-2-Dict命名" class="headerlink" title="2.2 Dict命名"></a>2.2 Dict命名</h3><ol>
<li><blockquote>
<p>NAME, AGE, SEX, EMAIL = 0, 1, 2, 3<br>Student[NAME]<br>Student[AGE]</p>
</blockquote>
</li>
<li><blockquote>
<p>from collections import namedtuple<br>Student = namedtuple(‘Student’, [‘name’, ‘age’, ‘sex’, ‘email’])<br>s = Student(‘jim’, 16, ‘male’, ‘djdiji@qq.com’)</p>
</blockquote>
</li>
</ol>
<h3 id="2-3-统计Dict-Counter"><a href="#2-3-统计Dict-Counter" class="headerlink" title="2.3 统计Dict Counter"></a>2.3 统计Dict Counter</h3><blockquote>
<p>from collections import Counter<br>c2 = Counter(data)<br>c2.most_common(3)</p>
</blockquote>
<h3 id="2-4-Dict-按照value排序"><a href="#2-4-Dict-按照value排序" class="headerlink" title="2.4 Dict 按照value排序"></a>2.4 Dict 按照value排序</h3><p>{‘a’: 93, ‘c’: 89, ‘b’: 70, ‘y’: 88, ‘x’: 94, ‘z’: 78}</p>
<ol>
<li><blockquote>
<p>zz = zip(d.itervalues(), d.iterkeys())</p>
</blockquote>
</li>
<li><blockquote>
<p>sorted(d.items(), key = lambda x: x[1])</p>
</blockquote>
</li>
</ol>
<h3 id="2-5-Dict公共键"><a href="#2-5-Dict公共键" class="headerlink" title="2.5 Dict公共键"></a>2.5 Dict公共键</h3><ol>
<li><blockquote>
<p>s1.viewkeys() &amp; s2.viewkeys()<br>set([‘s’])</p>
</blockquote>
</li>
<li><blockquote>
<p>map(dict.viewkeys, [s1, s2, s3])<br>[dict_keys([‘a’, ‘s’, ‘b’, ‘c’, ‘d’]), dict_keys([‘s’, ‘e’, ‘g’, ‘f’]), dict_keys([‘a’, ‘c’, ‘s’, ‘g’, ‘f’])]<br>reduce(lambda a, b:a &amp; b, map(dict.viewkeys, [s1, s2, s3]))<br>set([‘s’])</p>
</blockquote>
</li>
</ol>
<h3 id="2-6-Dict保持有序-append"><a href="#2-6-Dict保持有序-append" class="headerlink" title="2.6 Dict保持有序(append)"></a>2.6 Dict保持有序(append)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">from</span> time <span class="keyword">import</span> time</div><div class="line"> <span class="keyword">from</span> random <span class="keyword">import</span> randint</div><div class="line"> <span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</div><div class="line"></div><div class="line"> d = OrderedDict()</div><div class="line"> players = list(<span class="string">'ABCDEFGH'</span>)</div><div class="line"> start = time()</div><div class="line"> </div><div class="line"> <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>):</div><div class="line">  raw_input()</div><div class="line">  p = players.pop(randint(<span class="number">0</span>, <span class="number">7</span>-i))</div><div class="line">  end = time()</div><div class="line">  <span class="keyword">print</span> i + <span class="number">1</span>, p, end - start, d[p] = (i + <span class="number">1</span>, end - start)</div><div class="line"></div><div class="line"><span class="keyword">print</span></div><div class="line"><span class="keyword">print</span> <span class="string">'-'</span> * <span class="number">20</span></div></pre></td></tr></table></figure>
<hr>
<h3 id="2-7-实现用户历史记录"><a href="#2-7-实现用户历史记录" class="headerlink" title="2.7 实现用户历史记录"></a>2.7 实现用户历史记录</h3><p>猜数字小游戏，实现一个容量为n的历史记录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">from</span> random <span class="keyword">import</span> randint</div><div class="line"> <span class="keyword">from</span> collections <span class="keyword">import</span> deque</div><div class="line"> </div><div class="line"> N = randint(<span class="number">0</span>, <span class="number">100</span>)</div><div class="line"> history = deque([], <span class="number">5</span>)</div><div class="line"> </div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">guess</span><span class="params">(k)</span>:</span></div><div class="line">  <span class="keyword">if</span> k == N:</div><div class="line"> 	 <span class="keyword">print</span> <span class="string">'Right'</span></div><div class="line">	  <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"> <span class="keyword">if</span> k &lt; N:</div><div class="line">	 <span class="keyword">print</span> <span class="string">'%s is less than N'</span> % k</div><div class="line"> <span class="keyword">else</span>:</div><div class="line">	 <span class="keyword">print</span> <span class="string">'%s is greater than N'</span> % k</div><div class="line"> <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="number">1</span>:</div><div class="line"> line = raw_input(<span class="string">"input a number"</span>)</div></pre></td></tr></table></figure>
<hr>
<p>colletions deque + pickle(储存或者load一个python对象到文件中)</p>
<h2 id="三、迭代协议"><a href="#三、迭代协议" class="headerlink" title="三、迭代协议"></a>三、迭代协议</h2><h3 id="3-1-实现可迭代对象"><a href="#3-1-实现可迭代对象" class="headerlink" title="3.1 实现可迭代对象"></a>3.1 实现可迭代对象</h3><h3 id="3-2-实现迭代器对象"><a href="#3-2-实现迭代器对象" class="headerlink" title="3.2 实现迭代器对象"></a>3.2 实现迭代器对象</h3><p>实现一个迭代器对象WeatherItertor, next方法每次返回一个城市气温<br>实现一个迭代器对象WeatherIterable, <code>__iter__</code> 方法每次返回一个迭代器对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Iterable, Iterator</div><div class="line"></div><div class="line"><span class="comment"># 气温迭代器</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeatherIterator</span><span class="params">(Iterator)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cities)</span>:</span></div><div class="line">		self.cities = cities</div><div class="line">		self.index = <span class="number">0</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">getWeather</span><span class="params">(self, city)</span>:</span></div><div class="line">		r = requests.get(<span class="string">u'http://wthrcdn.etouch.cn/weather_mini?city='</span> + city)</div><div class="line">		data = r.json()[<span class="string">'data'</span>][<span class="string">'forecast'</span>][<span class="number">0</span>]</div><div class="line">		<span class="keyword">return</span> <span class="string">'%s : %s, %s'</span> % (city, data[<span class="string">'low'</span>], data[<span class="string">'high'</span>])</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">next</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">if</span> self.index == len(self.cities):</div><div class="line">			<span class="keyword">raise</span> StopIteration</div><div class="line">		city = self.cities[self.index]</div><div class="line">		self.index += <span class="number">1</span></div><div class="line">		<span class="keyword">return</span> self.getWeather(city)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeatherIterable</span><span class="params">(Iterable)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cities)</span>:</span></div><div class="line">		self.cities = cities</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">return</span> WeatherIterator(self.cities)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> WeatherIterable([<span class="string">u'北京'</span>, <span class="string">u'上海'</span>, <span class="string">u'广州'</span>, <span class="string">u'长春'</span>]):</div><div class="line">		<span class="keyword">print</span> x</div></pre></td></tr></table></figure>
<hr>
<h3 id="3-3-如何用生成器函数实现迭代器对象"><a href="#3-3-如何用生成器函数实现迭代器对象" class="headerlink" title="3.3 如何用生成器函数实现迭代器对象"></a>3.3 如何用生成器函数实现迭代器对象</h3><p>实现一个可迭代器类，打印范围内的所有素数</p>
<p>将该类的 <code>__iter__</code> 方法实现成生成器函数，每次yield返回一个素数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrimeNumbers</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start, end)</span>:</span></div><div class="line">		self.start = start</div><div class="line">		self.end = end</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">isPrimeNum</span><span class="params">(self, k)</span>:</span></div><div class="line">		<span class="keyword">if</span> k &lt; <span class="number">2</span>:</div><div class="line">			<span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">2</span>, k):</div><div class="line">			<span class="keyword">if</span> k % i == <span class="number">0</span>:</div><div class="line">				<span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">for</span> k <span class="keyword">in</span> xrange(self.start, self.end+<span class="number">1</span>):</div><div class="line">			<span class="keyword">if</span> self.isPrimeNum(k):</div><div class="line">				<span class="keyword">yield</span> k</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> PrimeNumbers(<span class="number">1</span>, <span class="number">100</span>):</div><div class="line">		<span class="keyword">print</span> x</div></pre></td></tr></table></figure>
<hr>
<h3 id="3-4-如何进行反向迭代和如何实现反向迭代"><a href="#3-4-如何进行反向迭代和如何实现反向迭代" class="headerlink" title="3.4 如何进行反向迭代和如何实现反向迭代"></a>3.4 如何进行反向迭代和如何实现反向迭代</h3><p>实现一个连续的浮点数发生器FloatRange(类似于xrange)<br>for x in reversed(l):<br>    print x</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># iter(l) 正向</span></div><div class="line"><span class="comment"># reversed(l) 反向 </span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FloatRnage</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start, end, step)</span>:</span></div><div class="line">		self.start = start</div><div class="line">		self.end = end</div><div class="line">		self.step = step</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">		t = self.start</div><div class="line">		<span class="keyword">while</span> t &lt;= self.end:</div><div class="line">			<span class="keyword">yield</span> t</div><div class="line">			t += self.step</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__reversed__</span><span class="params">(self)</span>:</span></div><div class="line">		t = self.end</div><div class="line">		<span class="keyword">while</span> t &gt;= self.start:</div><div class="line">			<span class="keyword">yield</span> t</div><div class="line">			t -= self.step</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> FloatRnage(<span class="number">1.0</span>, <span class="number">4.0</span>, <span class="number">0.5</span>):</div><div class="line">		<span class="keyword">print</span> x</div><div class="line"></div><div class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> reversed(FloatRnage(<span class="number">1.0</span>, <span class="number">4.0</span>, <span class="number">0.5</span>)):</div><div class="line">		<span class="keyword">print</span> x</div></pre></td></tr></table></figure>
<hr>
<h3 id="3-5-如何对迭代器做切片操作"><a href="#3-5-如何对迭代器做切片操作" class="headerlink" title="3.5 如何对迭代器做切片操作"></a>3.5 如何对迭代器做切片操作</h3><p>使用itertools中的islice(注意它会消耗迭代器对象)</p>
<h3 id="3-6-如何在一个for语句中迭代多个可迭代对象"><a href="#3-6-如何在一个for语句中迭代多个可迭代对象" class="headerlink" title="3.6 如何在一个for语句中迭代多个可迭代对象"></a>3.6 如何在一个for语句中迭代多个可迭代对象</h3><ol>
<li><p>并行 -&gt; 同时迭代多个各科成绩列表，统计学生成绩总分 -&gt; 使用zip(之前实现dict按value排序)</p>
</li>
<li><p>串行 -&gt; 迭代多个英语成绩列表，统计分数大于90分的人数 -&gt; 使用itertools中的chain连接多个可迭代对象</p>
</li>
</ol>
<h2 id="四、字符串"><a href="#四、字符串" class="headerlink" title="四、字符串"></a>四、字符串</h2><h3 id="4-1-如何拆分含有多种分隔符的字符串"><a href="#4-1-如何拆分含有多种分隔符的字符串" class="headerlink" title="4.1 如何拆分含有多种分隔符的字符串"></a>4.1 如何拆分含有多种分隔符的字符串</h3><ol>
<li><p>多次使用str.split()</p>
</li>
<li><p>使用正则表达式re.split() -&gt; re.split(r’’, str)</p>
</li>
</ol>
<h3 id="4-2-如何判断字符串a是否以字符串b开头或者结尾"><a href="#4-2-如何判断字符串a是否以字符串b开头或者结尾" class="headerlink" title="4.2 如何判断字符串a是否以字符串b开头或者结尾"></a>4.2 如何判断字符串a是否以字符串b开头或者结尾</h3><p>str.startswith() str.endswith() (!函数参数只能是元组)</p>
<h3 id="4-3-如何调整字符串中文本的格式"><a href="#4-3-如何调整字符串中文本的格式" class="headerlink" title="4.3 如何调整字符串中文本的格式"></a>4.3 如何调整字符串中文本的格式</h3><p>yyyy—mm-dd -&gt; mm/dd/yyyy</p>
<p>使用正则表达式re.sub()替换</p>
<ol>
<li><p>re.sub(‘(\d{4})-(\d{2})-(\d{2})’, ‘\2/\3/\1’, a.txt)</p>
</li>
<li><p>re.sub(‘(?P<year>\d{4})-(?P<month>\d{2})-(?P<day>\d{2})’, ‘?g<month>/<day>/<year>’, a.txt)</year></day></month></day></month></year></p>
</li>
</ol>
<h3 id="4-4-如何将多个小字符串拼接成一个大的字符串"><a href="#4-4-如何将多个小字符串拼接成一个大的字符串" class="headerlink" title="4.4 如何将多个小字符串拼接成一个大的字符串"></a>4.4 如何将多个小字符串拼接成一个大的字符串</h3><p>UDP分包</p>
<ol>
<li><p>‘+’ 拼接 (运算符重载 <code>__add__</code>)</p>
</li>
<li><p>‘’.join([str(x) for x in l])<br>使用生成器表达式减少开销：<br>‘’.join(str(x) for x in l)</p>
</li>
</ol>
<h3 id="4-5-如何对字符串进行左，右，居中对齐"><a href="#4-5-如何对字符串进行左，右，居中对齐" class="headerlink" title="4.5 如何对字符串进行左，右，居中对齐"></a>4.5 如何对字符串进行左，右，居中对齐</h3><p>python3 -&gt; print(‘{0:^}’).fromat(s)</p>
<p>python2 -&gt;</p>
<ol>
<li><p>str.ljust(), str.rjust(), str.center()</p>
</li>
<li><p>format ‘<20’, ‘="">20’, ‘^20’</20’,></p>
</li>
</ol>
<h3 id="4-6-如何去掉字符串中不需要的字符"><a href="#4-6-如何去掉字符串中不需要的字符" class="headerlink" title="4.6 如何去掉字符串中不需要的字符"></a>4.6 如何去掉字符串中不需要的字符</h3><ol>
<li><p>使用strip() lstrip() rstrip() 去掉两端字符</p>
</li>
<li><p>使用切片 + 拼接的方式</p>
</li>
<li><p>使用str.replace() 或者正则表达式re.sub()</p>
</li>
<li><p>使用str.translate(table, [, deletechars]) -&gt; string (一个字符映射到另一个字符)</p>
</li>
</ol>
<p>字符映射：<br>import string<br>s = ‘abc1230323xyz’<br>string.maketrans(‘abcxyz’, ‘xyzabc’) (xyz映射成abc, abc映射成xyz)<br>s.translate(string.maketrans(‘abcxyz’, ‘xyzabc’))</p>
<p>删除字符：<br>s.translate(None, ‘\r\t\n’)</p>
<h2 id="五、文件操作"><a href="#五、文件操作" class="headerlink" title="五、文件操作"></a>五、文件操作</h2><h3 id="5-1-如何读写文本文件"><a href="#5-1-如何读写文本文件" class="headerlink" title="5.1 如何读写文本文件"></a>5.1 如何读写文本文件</h3><p>python2和python3中字符串的差异<br>str -&gt; bytes<br>unicode -&gt; str</p>
<p>python2 -&gt; 写入文件前对Unicode编码，读入文件后对二进制字符串解码<br>python3 -&gt; open函数指定’t’的文本模式，endcoding指定编码格式</p>
<h3 id="5-2-如何处理二进制文件"><a href="#5-2-如何处理二进制文件" class="headerlink" title="5.2 如何处理二进制文件"></a>5.2 如何处理二进制文件</h3><p>分析一个WVA音频文件的头部信息<br>open()指定参数为’b’<br>使用readinto()读入准备好的buffer中<br>struct模块的 unpack()解析二进制文件<br>array模块的 array()</p>
<h3 id="5-3-如何设置文件的缓冲"><a href="#5-3-如何设置文件的缓冲" class="headerlink" title="5.3 如何设置文件的缓冲"></a>5.3 如何设置文件的缓冲</h3><p>全缓冲 -&gt; open() 的 buffering参数设置为 &gt; 1<br>行缓冲 -&gt; open() 的 buffering参数设置为1<br>无缓冲 -&gt; open() 的 buffering参数设置为0</p>
<h3 id="5-4-如何将文件映射到内存"><a href="#5-4-如何将文件映射到内存" class="headerlink" title="5.4 如何将文件映射到内存"></a>5.4 如何将文件映射到内存</h3><p>使用mmap模块中的 mmap()，传递一个fd<br>mmap.mmap(f.fileno(), 0, access = mmap.ACCESS_WRITE, offset = mmap.PAGESIZE * 4) (跳过4个页面)</p>
<h3 id="5-5-如何访问一个文件状态"><a href="#5-5-如何访问一个文件状态" class="headerlink" title="5.5 如何访问一个文件状态"></a>5.5 如何访问一个文件状态</h3><p>文件的类型？<br>文件的访问权限？<br>文件的三个时间： 文件的最后访问，修改，节点状态更改(chmod)?<br>文件的字节数？</p>
<p>1.<br>系统调用 os模块中 stat fstat(like stat, but for open fd) lstat(donnot follow sybolic links)</p>
<ol>
<li>快捷函数 os.path </li>
</ol>
<h3 id="5-6-如何使用临时文件"><a href="#5-6-如何使用临时文件" class="headerlink" title="5.6 如何使用临时文件"></a>5.6 如何使用临时文件</h3><p>tempfile模块中的 TemporaryFile NamedTemporaryFile</p>
<h3 id="5-7-如何读写csv文件数据"><a href="#5-7-如何读写csv文件数据" class="headerlink" title="5.7 如何读写csv文件数据"></a>5.7 如何读写csv文件数据</h3><p>csv模块中 reader writer</p>
<h3 id="5-8-如何读写json文件数据"><a href="#5-8-如何读写json文件数据" class="headerlink" title="5.8 如何读写json文件数据"></a>5.8 如何读写json文件数据</h3><p>json模块中 loads() dumps() load(文件) dump(文件)</p>
<h3 id="5-9-如何解析简单的xml文档"><a href="#5-9-如何解析简单的xml文档" class="headerlink" title="5.9 如何解析简单的xml文档"></a>5.9 如何解析简单的xml文档</h3><p>使用标准库的xml.etree.ElementTree 中的 parse</p>
<h3 id="5-10-如何构建xml文档"><a href="#5-10-如何构建xml文档" class="headerlink" title="5.10 如何构建xml文档"></a>5.10 如何构建xml文档</h3><p>使用标准库的xml.etree.ElementTree 中的 write</p>
<h3 id="5-11-如何读写excel文件"><a href="#5-11-如何读写excel文件" class="headerlink" title="5.11 如何读写excel文件"></a>5.11 如何读写excel文件</h3><p>使用第三方库 xlrd 读，xlwt 写</p>
<h2 id="六、类和对象"><a href="#六、类和对象" class="headerlink" title="六、类和对象"></a>六、类和对象</h2><h3 id="6-1-如何派生不可变类型，并修改其实例化行为"><a href="#6-1-如何派生不可变类型，并修改其实例化行为" class="headerlink" title="6.1 如何派生不可变类型，并修改其实例化行为"></a>6.1 如何派生不可变类型，并修改其实例化行为</h3><p>新类型的元组，只保留&gt;0的int<br>IntTuple([1, -1, ‘abc’, 6, [‘x’, ‘y’], 3]) -&gt; (1, 6, 3)</p>
<p>定义类IntTuple继承内置tuple，并实现<strong>new</strong>，修改其实例化行为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntTuple</span><span class="params">(tuple)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, iterable)</span>:</span></div><div class="line">		g = (<span class="keyword">for</span> x <span class="keyword">in</span> iterable <span class="keyword">if</span> isinstance(x, int) <span class="keyword">and</span> x &gt; <span class="number">0</span>)</div><div class="line">		<span class="keyword">return</span> super(IntTuple, cls).__new__(cls, g)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, iterable)</span>:</span></div><div class="line">		super(IntTuple, self).__init__(iterable)</div><div class="line"></div><div class="line"></div><div class="line">t = IntTuple([<span class="number">1</span>, <span class="number">-1</span>, <span class="string">'abc'</span>, <span class="number">6</span>, [<span class="string">'x'</span>, <span class="string">'y'</span>], <span class="number">3</span>])</div><div class="line"><span class="keyword">print</span> t</div></pre></td></tr></table></figure>
<hr>
<h3 id="6-2-如何为创建大量实例节省内存"><a href="#6-2-如何为创建大量实例节省内存" class="headerlink" title="6.2 如何为创建大量实例节省内存"></a>6.2 如何为创建大量实例节省内存</h3><p>网络游戏的player实例</p>
<p>定义类的 <code>__slots__</code> 属性，它是用来声明实例属性名字的列表</p>
<h3 id="6-3-如何让对象支持上下文管理"><a href="#6-3-如何让对象支持上下文管理" class="headerlink" title="6.3 如何让对象支持上下文管理"></a>6.3 如何让对象支持上下文管理</h3><p>with open…</p>
<p>让TelnetClient的实例支持上下文管理协议，不必调用cleanup()(关闭socket并把历史记录写入文件)而是自动清理<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> telnetlib <span class="keyword">import</span> telnetlib</div><div class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdin, stdout</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TelnetClient</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, addr, port=<span class="number">23</span>)</span>:</span></div><div class="line">		self.addr = addr</div><div class="line">		self.port = port</div><div class="line">		self.tn = <span class="keyword">None</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line">		self.tn = Telnet(self.addr, self.port)</div><div class="line">		self.history = deque()</div><div class="line"></div><div class="line">		<span class="comment"># user</span></div><div class="line">		t = self.tn.read_until(<span class="string">'login: '</span>)</div><div class="line">		stdout.write(t)</div><div class="line">		user = stdin.readline()</div><div class="line">		self.tn.write(user)</div><div class="line"></div><div class="line">		<span class="comment"># password</span></div><div class="line">		t = self.tn.read_until(<span class="string">'Password: '</span>)</div><div class="line">		<span class="keyword">if</span> t.startswith(user[:<span class="number">-1</span>]):</div><div class="line">			t = t[len(user) + <span class="number">1</span>:]</div><div class="line">		stdout.write(t)</div><div class="line">		self.tn.write(stdin.readline())</div><div class="line"></div><div class="line">		t = self.tn.read_until(<span class="string">'$ '</span>)</div><div class="line">		stdout.write(t)</div><div class="line">		<span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">			uinput = stdin.readline()</div><div class="line">			<span class="keyword">if</span> <span class="keyword">not</span> uinput:</div><div class="line">				<span class="keyword">break</span></div><div class="line">			self.history.append(uinput)</div><div class="line">			self.tn.write(uinput)</div><div class="line">			t = self.tn.read_until(<span class="string">'$ '</span>)</div><div class="line">			stdout.write(t[len(uinput) + <span class="number">1</span>:])</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">cleanup</span><span class="params">(self)</span>:</span></div><div class="line">		self.tn.close()</div><div class="line">		self.tn = <span class="keyword">None</span></div><div class="line">		<span class="keyword">with</span> open(self.addr + <span class="string">'_history.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</div><div class="line">			f.writelines(self.history)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	client = TelnetClient(<span class="string">'127.0.0.1'</span>)</div><div class="line">	<span class="keyword">print</span> <span class="string">'\nstart...'</span></div><div class="line">	client.start()</div><div class="line">	<span class="keyword">print</span> <span class="string">'\ncleanup'</span></div><div class="line">	client.cleanup()</div></pre></td></tr></table></figure></p>
<hr>
<p>实现上下文管理协议，需要在open()的开始前和结束后定义 <code>__enter__</code>, <code>__exit__</code> 实例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> telnetlib <span class="keyword">import</span> telnetlib</div><div class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdin, stdout</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TelnetClient</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, addr, port=<span class="number">23</span>)</span>:</span></div><div class="line">		self.addr = addr</div><div class="line">		self.port = port</div><div class="line">		self.tn = <span class="keyword">None</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line"></div><div class="line">		<span class="comment"># user</span></div><div class="line">		t = self.tn.read_until(<span class="string">'login: '</span>)</div><div class="line">		stdout.write(t)</div><div class="line">		user = stdin.readline()</div><div class="line">		self.tn.write(user)</div><div class="line"></div><div class="line">		<span class="comment"># password</span></div><div class="line">		t = self.tn.read_until(<span class="string">'Password: '</span>)</div><div class="line">		<span class="keyword">if</span> t.startswith(user[:<span class="number">-1</span>]):</div><div class="line">			t = t[len(user) + <span class="number">1</span>:]</div><div class="line">		stdout.write(t)</div><div class="line">		self.tn.write(stdin.readline())</div><div class="line"></div><div class="line">		t = self.tn.read_until(<span class="string">'$ '</span>)</div><div class="line">		stdout.write(t)</div><div class="line">		<span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">			uinput = stdin.readline()</div><div class="line">			<span class="keyword">if</span> <span class="keyword">not</span> uinput:</div><div class="line">				<span class="keyword">break</span></div><div class="line">			self.history.append(uinput)</div><div class="line">			self.tn.write(uinput)</div><div class="line">			t = self.tn.read_until(<span class="string">'$ '</span>)</div><div class="line">			stdout.write(t[len(uinput) + <span class="number">1</span>:])</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">		self.tn = Telnet(self.addr, self.port)</div><div class="line">		self.history = deque()</div><div class="line">		<span class="keyword">return</span> self</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></div><div class="line">		self.tn.close()</div><div class="line">		self.tn = <span class="keyword">None</span></div><div class="line">		<span class="keyword">with</span> open(self.addr + <span class="string">'_history.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</div><div class="line">			f.writelines(self.history)    </div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	<span class="keyword">with</span> TelnetClient(<span class="string">'127.0.0.1'</span>) <span class="keyword">as</span> client:</div><div class="line">		client.start()</div></pre></td></tr></table></figure>
<hr>
<h3 id="6-4-如何创建可管理的对象属性"><a href="#6-4-如何创建可管理的对象属性" class="headerlink" title="6.4 如何创建可管理的对象属性"></a>6.4 如何创建可管理的对象属性</h3><p>形式上是访问属性，其实是调用方法，避免使用set get<br>使用property属性去创建可管理属性，fset fget fdel 对应相应属性访问</p>
<ol>
<li><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mat</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="string">"""动态读，class 内部只存 temp 的值，每次取 pro 的时候实时计算"""</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, t)</span>:</span></div><div class="line">		self.tmp = t</div><div class="line"></div><div class="line"><span class="meta">	@property</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">pro</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">return</span> self.tmp * self.tmp</div><div class="line"></div><div class="line">a = Mat(<span class="number">5</span>)</div><div class="line"><span class="keyword">print</span> (a.tmp, a.pro)</div><div class="line"></div><div class="line">a.tmp = <span class="number">10</span></div><div class="line"><span class="keyword">print</span> (a.tmp, a.pro)</div><div class="line"></div><div class="line"><span class="comment"># 不加属性</span></div><div class="line"><span class="comment"># 5 &lt;bound method Mat.pro of &lt;__main__.Mat object at 0x1090144a8&gt;&gt;</span></div><div class="line"><span class="comment"># 10 &lt;bound method Mat.pro of &lt;__main__.Mat object at 0x1090144a8&gt;&gt;</span></div><div class="line"><span class="comment"># 加了之后</span></div><div class="line"><span class="comment"># 5 25</span></div><div class="line"><span class="comment"># 10 100</span></div></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<ol>
<li><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mat2</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="string">"""两个都存，写入的时候两个都改"""</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, t)</span>:</span></div><div class="line">		self.tmp = t</div><div class="line"></div><div class="line"><span class="meta">	@property</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">tmp</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">return</span> self._tmp</div><div class="line"></div><div class="line"><span class="meta">	@tmp.setter</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">tmp</span><span class="params">(self, v)</span>:</span></div><div class="line">		self._tmp = v</div><div class="line">		self.pro = self.Pro(v)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">Pro</span><span class="params">(self, t)</span>:</span></div><div class="line">		<span class="keyword">return</span> t * t</div><div class="line"></div><div class="line">a = Mat2(<span class="number">5</span>)</div><div class="line"><span class="keyword">print</span> (a.tmp, a.pro)</div><div class="line">a.tmp = <span class="number">10</span></div><div class="line"><span class="keyword">print</span> (a.tmp, a.pro)</div><div class="line"><span class="comment"># 5 25</span></div><div class="line"><span class="comment"># 10 100</span></div></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="6-5-如何让类支持比较操作"><a href="#6-5-如何让类支持比较操作" class="headerlink" title="6.5 如何让类支持比较操作"></a>6.5 如何让类支持比较操作</h3><ol>
<li>比较运算符重载，即实现<figure class="highlight plain"><figcaption><span>``__le__``, ``__gt__``, ``__ge__``, ``__eq__``, ``__ne__``</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">2. </div><div class="line">使用标准库functools的类装饰器total_ordering可以简化此进程</div><div class="line">```python</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line"></div><div class="line">from functools import total_ordering</div><div class="line">from abc import ABCMeta, abstractmethod</div><div class="line"></div><div class="line"># 抽象基类</div><div class="line">@total_ordering</div><div class="line">class Shape(object):</div><div class="line"></div><div class="line">	@abstractmethod</div><div class="line">	def area(self):</div><div class="line">		pass</div><div class="line">	# 只用实现等于和小于</div><div class="line">	def __eq__(self, obj):</div><div class="line">		if not isinstance(obj, Shape):</div><div class="line">			raise TypeError(&apos;obj is not Shape&apos;)</div><div class="line">		return self.area() == obj.area()</div><div class="line"></div><div class="line">	def __lt__(self, obj):</div><div class="line">		if not isinstance(obj, Shape):</div><div class="line">			raise TypeError(&apos;obj is not Shape&apos;)</div><div class="line">		return self.area() &lt; obj.area()    </div><div class="line"></div><div class="line">@total_ordering</div><div class="line">class Rectangle(Shape):</div><div class="line">	def __init__(self, w, h):</div><div class="line">		self.w = w</div><div class="line">		self.h = h</div><div class="line"></div><div class="line">	def area(self):</div><div class="line">		return self.w * self.h</div><div class="line"></div><div class="line">class Circle(Shape):</div><div class="line">	def __init__(self, r):</div><div class="line">		self.r = r</div><div class="line"></div><div class="line">	def area(self):</div><div class="line">		return self.r ** 2 * 3.14</div></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="6-6-如何使用描述符对实例属性进行检查"><a href="#6-6-如何使用描述符对实例属性进行检查" class="headerlink" title="6.6 如何使用描述符对实例属性进行检查"></a>6.6 如何使用描述符对实例属性进行检查</h3><p>类似C C++ 对实例属性进行检查 age -&gt; int name -&gt; string<br>对要检查的实例属性实现 <code>__get__</code> <code>__set__</code> <code>__delete__</code> 并在 <code>__set__</code> 中进行 isinstance()检查</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Attr</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, type_)</span>:</span></div><div class="line">		self.name = name</div><div class="line">		self.type_ = type_</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, cls)</span>:</span></div><div class="line">		<span class="keyword">return</span> instance.__dict__[self.name]</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></div><div class="line">		<span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, self.type_):</div><div class="line">			<span class="keyword">raise</span> TypeError(<span class="string">'expected an %s'</span> % self.type_)</div><div class="line">		instance.__dict__[self.name] = value</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__delete__</span><span class="params">(self, instance)</span>:</span></div><div class="line">		<span class="keyword">raise</span> AttributeError(<span class="string">"can't delete this attr"</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(object)</span>:</span></div><div class="line">	name    = Attr(<span class="string">'name'</span>, str)</div><div class="line">	age     = Attr(<span class="string">'age'</span>, int) </div><div class="line">	height  = Attr(<span class="string">'height'</span>, float)</div><div class="line">	weight  = Attr(<span class="string">'weight'</span>, float)</div><div class="line"></div><div class="line">s = Person()</div><div class="line">s.name = <span class="string">'Bob'</span></div><div class="line">s.age = <span class="number">17</span></div><div class="line">s.height = <span class="number">1.82</span></div><div class="line">s.weight = <span class="number">52.5</span></div></pre></td></tr></table></figure>
<hr>
<h3 id="6-7-如何在环状数据结构中管理内存"><a href="#6-7-如何在环状数据结构中管理内存" class="headerlink" title="6.7 如何在环状数据结构中管理内存"></a>6.7 如何在环状数据结构中管理内存</h3><p>环形数据结构存在循环引用：父节点引用子节点，子节点也引用父节点，同时del两个节点，两个对象不能立即被回收</p>
<p>使用标准库weakref，创建一种能访问对象但是不增加引用计数的对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> weakref</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Data</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value, owner)</span>:</span></div><div class="line">		self.owner = weakref.ref(owner)</div><div class="line">		self.value = value</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">return</span> <span class="string">"%s's data, value is %s"</span> % (self.owner(), self.value)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">print</span> <span class="string">'in Data.__del__'</span> </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></div><div class="line">		self.data = Data(value, self)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">print</span> <span class="string">'in Node.__del__'</span></div><div class="line"></div><div class="line">node = Node(<span class="number">100</span>)</div><div class="line"><span class="keyword">del</span> node</div><div class="line">raw_input(<span class="string">'wait...'</span>)</div></pre></td></tr></table></figure>
<hr>
<h3 id="6-8-如何通过实例化方法名字的字符串调用方法"><a href="#6-8-如何通过实例化方法名字的字符串调用方法" class="headerlink" title="6.8 如何通过实例化方法名字的字符串调用方法"></a>6.8 如何通过实例化方法名字的字符串调用方法</h3><ol>
<li><p>使用内置函数getattr()，通过名字在实例上获取方法对象</p>
</li>
<li><p>使用标准库operator下的methodcaller()函数调用</p>
</li>
</ol>
<h2 id="七、并发编程"><a href="#七、并发编程" class="headerlink" title="七、并发编程"></a>七、并发编程</h2><h3 id="7-1-如何使用多线程"><a href="#7-1-如何使用多线程" class="headerlink" title="7.1 如何使用多线程"></a>7.1 如何使用多线程</h3><p>使用标准库中的Threading.Thread创建线程</p>
<h3 id="7-2-如何线程间通信"><a href="#7-2-如何线程间通信" class="headerlink" title="7.2 如何线程间通信"></a>7.2 如何线程间通信</h3><p>由于全局锁的存在，多线程进行CPU密集型操作并不能提高效率<br>所以可以采用多线程进行I/O操作 Download<br>单线程进行CPU密集操作 Convert<br>使用标准库Queue.Queue，它是一个线程安全队列，<br>Download线程把下载数据放入队列，Convert线程从队列里提取数据</p>
<h3 id="7-3-如何在线程间进行事件通知"><a href="#7-3-如何在线程间进行事件通知" class="headerlink" title="7.3 如何在线程间进行事件通知"></a>7.3 如何在线程间进行事件通知</h3><p>线程间的时间通知，可以使用标准库Threading.Ecent:</p>
<p>1.等待事件一端调用wait，等待事件<br>2.通知时间一端调用set，通知事件</p>
<h3 id="7-4-如何使用线程本地数据"><a href="#7-4-如何使用线程本地数据" class="headerlink" title="7.4 如何使用线程本地数据"></a>7.4 如何使用线程本地数据</h3><p>web监控服务器，每个线程连接一个客户端，支持多客户端</p>
<p>threading.local函数可以创建线程本地数据空间，其下属性对每个线程独立存在</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os, cv2, time, struct, threading</div><div class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</div><div class="line"><span class="keyword">from</span> socketserver <span class="keyword">import</span> TCPServer, ThreadingTCPServer</div><div class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread, RLock</div><div class="line"><span class="keyword">from</span> select <span class="keyword">import</span> select</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JpegStreamer</span><span class="params">(Thread)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, camera)</span>:</span></div><div class="line">		Thread.__init__(self)</div><div class="line">		self.cap = cv2.VideoCapture(camera)</div><div class="line">		self.lock = RLock()</div><div class="line">		self.pipes = &#123;&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(self)</span>:</span></div><div class="line">		pr, pw = os.pipe()</div><div class="line">		self.lock.acquire()</div><div class="line">		self.pipes[pr] = pw</div><div class="line">		self.lock.release()</div><div class="line">		<span class="keyword">return</span> pr</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">unregister</span><span class="params">(self, pr)</span>:</span></div><div class="line">		self.lock.acquire()</div><div class="line">		pw = self.pipes.pop(pr)</div><div class="line">		self.lock.release()</div><div class="line">		os.close(pr)</div><div class="line">		os.close(pw)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">capture</span><span class="params">(self)</span>:</span></div><div class="line">		cap = self.cap</div><div class="line">		<span class="keyword">while</span> cap.isOpened():</div><div class="line">			ret, frame = cap.read()</div><div class="line">			<span class="keyword">if</span> ret:</div><div class="line">				<span class="comment">#ret, data = cv2.imencode('.jpg', frame)</span></div><div class="line">				ret, data = cv2.imencode(<span class="string">'.jpg'</span>, frame, (cv2.IMWRITE_JPEG_QUALITY, <span class="number">40</span>))</div><div class="line">				<span class="keyword">yield</span> data.tostring()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self, frame)</span>:</span></div><div class="line">		n = struct.pack(<span class="string">'l'</span>, len(frame))</div><div class="line">		self.lock.acquire()</div><div class="line">		<span class="keyword">if</span> len(self.pipes):</div><div class="line">			_, pipes, _ = select([], iter(self.pipes.values()), [], <span class="number">1</span>)</div><div class="line">			<span class="keyword">for</span> pipe <span class="keyword">in</span> pipes:</div><div class="line">				os.write(pipe, n)</div><div class="line">				os.write(pipe, frame)</div><div class="line">		self.lock.release()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">for</span> frame <span class="keyword">in</span> self.capture():</div><div class="line">			self.send(frame)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JpegRetriever</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, streamer)</span>:</span></div><div class="line">		self.streamer = streamer</div><div class="line">		self.local = threading.local()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">retrieve</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">			ns = os.read(self.local.pipe, <span class="number">8</span>)</div><div class="line">			n = struct.unpack(<span class="string">'l'</span>, ns)[<span class="number">0</span>]</div><div class="line">			data = os.read(self.local.pipe, n)</div><div class="line">			<span class="keyword">yield</span> data</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">if</span> hasattr(self.local, <span class="string">'pipe'</span>):</div><div class="line">			<span class="keyword">raise</span> RuntimeError()</div><div class="line"></div><div class="line">		self.local.pipe = streamer.register()</div><div class="line">		<span class="keyword">return</span> self.retrieve()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, *args)</span>:</span></div><div class="line">		self.streamer.unregister(self.local.pipe)</div><div class="line">		<span class="keyword">del</span> self.local.pipe</div><div class="line">		<span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span><span class="params">(BaseHTTPRequestHandler)</span>:</span></div><div class="line">	retriever = <span class="keyword">None</span></div><div class="line"><span class="meta">	@staticmethod</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">setJpegRetriever</span><span class="params">(retriever)</span>:</span></div><div class="line">		Handler.retriever = retriever</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">if</span> self.retriever <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">			<span class="keyword">raise</span> RuntimeError(<span class="string">'no retriver'</span>)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> self.path != <span class="string">'/'</span>:</div><div class="line">			<span class="keyword">return</span></div><div class="line"></div><div class="line">		self.send_response(<span class="number">200</span>) </div><div class="line">		self.send_header(<span class="string">'Content-type'</span>, <span class="string">'multipart/x-mixed-replace;boundary=abcde'</span>)</div><div class="line">		self.end_headers()</div><div class="line"></div><div class="line">		<span class="keyword">with</span> self.retriever <span class="keyword">as</span> frames:</div><div class="line">			<span class="keyword">for</span> frame <span class="keyword">in</span> frames:</div><div class="line">				self.send_frame(frame)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">send_frame</span><span class="params">(self, frame)</span>:</span></div><div class="line">		s  = <span class="string">'--abcde\r\n'</span></div><div class="line">		s += <span class="string">'Content-Type: image/jpeg\r\n'</span></div><div class="line">		s += <span class="string">'Content-Length: %s\r\n\r\n'</span> % len(frame)</div><div class="line">		self.wfile.write(s.encode(<span class="string">'ascii'</span>))</div><div class="line">		self.wfile.write(frame)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	streamer = JpegStreamer(<span class="number">0</span>)</div><div class="line">	streamer.start()</div><div class="line"></div><div class="line">	retriever = JpegRetriever(streamer)</div><div class="line">	Handler.setJpegRetriever(retriever)</div><div class="line"></div><div class="line">	print(<span class="string">'Start server...'</span>)</div><div class="line">	httpd = ThreadingTCPServer((<span class="string">''</span>, <span class="number">9000</span>), Handler)</div><div class="line">	httpd.serve_forever()</div></pre></td></tr></table></figure>
<hr>
<h3 id="7-5-如何实现线程池"><a href="#7-5-如何实现线程池" class="headerlink" title="7.5 如何实现线程池"></a>7.5 如何实现线程池</h3><p>python3中有线程池实现<br>使用标准库中concurrent.futures下的ThreadPoolExecutor对象的submit和map方法可以用来启动线程池中线程执行任务</p>
<p>使用线程池代替7.4中例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os, cv2, time, struct, threading</div><div class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</div><div class="line"><span class="keyword">from</span> socketserver <span class="keyword">import</span> TCPServer, ThreadingTCPServer</div><div class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread, RLock</div><div class="line"><span class="keyword">from</span> select <span class="keyword">import</span> select</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JpegStreamer</span><span class="params">(Thread)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, camera)</span>:</span></div><div class="line">		Thread.__init__(self)</div><div class="line">		self.cap = cv2.VideoCapture(camera)</div><div class="line">		self.lock = RLock()</div><div class="line">		self.pipes = &#123;&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(self)</span>:</span></div><div class="line">		pr, pw = os.pipe()</div><div class="line">		self.lock.acquire()</div><div class="line">		self.pipes[pr] = pw</div><div class="line">		self.lock.release()</div><div class="line">		<span class="keyword">return</span> pr</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">unregister</span><span class="params">(self, pr)</span>:</span></div><div class="line">		self.lock.acquire()</div><div class="line">		pw = self.pipes.pop(pr)</div><div class="line">		self.lock.release()</div><div class="line">		os.close(pr)</div><div class="line">		os.close(pw)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">capture</span><span class="params">(self)</span>:</span></div><div class="line">		cap = self.cap</div><div class="line">		<span class="keyword">while</span> cap.isOpened():</div><div class="line">			ret, frame = cap.read()</div><div class="line">			<span class="keyword">if</span> ret:</div><div class="line">				<span class="comment">#ret, data = cv2.imencode('.jpg', frame)</span></div><div class="line">				ret, data = cv2.imencode(<span class="string">'.jpg'</span>, frame, (cv2.IMWRITE_JPEG_QUALITY, <span class="number">40</span>))</div><div class="line">				<span class="keyword">yield</span> data.tostring()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self, frame)</span>:</span></div><div class="line">		n = struct.pack(<span class="string">'l'</span>, len(frame))</div><div class="line">		self.lock.acquire()</div><div class="line">		<span class="keyword">if</span> len(self.pipes):</div><div class="line">			_, pipes, _ = select([], iter(self.pipes.values()), [], <span class="number">1</span>)</div><div class="line">			<span class="keyword">for</span> pipe <span class="keyword">in</span> pipes:</div><div class="line">				os.write(pipe, n)</div><div class="line">				os.write(pipe, frame)</div><div class="line">		self.lock.release()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">for</span> frame <span class="keyword">in</span> self.capture():</div><div class="line">			self.send(frame)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JpegRetriever</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, streamer)</span>:</span></div><div class="line">		self.streamer = streamer</div><div class="line">		self.local = threading.local()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">retrieve</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">			ns = os.read(self.local.pipe, <span class="number">8</span>)</div><div class="line">			n = struct.unpack(<span class="string">'l'</span>, ns)[<span class="number">0</span>]</div><div class="line">			data = os.read(self.local.pipe, n)</div><div class="line">			<span class="keyword">yield</span> data</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">if</span> hasattr(self.local, <span class="string">'pipe'</span>):</div><div class="line">			<span class="keyword">raise</span> RuntimeError()</div><div class="line"></div><div class="line">		self.local.pipe = streamer.register()</div><div class="line">		<span class="keyword">return</span> self.retrieve()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, *args)</span>:</span></div><div class="line">		self.streamer.unregister(self.local.pipe)</div><div class="line">		<span class="keyword">del</span> self.local.pipe</div><div class="line">		<span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span><span class="params">(BaseHTTPRequestHandler)</span>:</span></div><div class="line">	retriever = <span class="keyword">None</span></div><div class="line"><span class="meta">	@staticmethod</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">setJpegRetriever</span><span class="params">(retriever)</span>:</span></div><div class="line">		Handler.retriever = retriever</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">if</span> self.retriever <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">			<span class="keyword">raise</span> RuntimeError(<span class="string">'no retriver'</span>)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> self.path != <span class="string">'/'</span>:</div><div class="line">			<span class="keyword">return</span></div><div class="line"></div><div class="line">		self.send_response(<span class="number">200</span>) </div><div class="line">		self.send_header(<span class="string">'Content-type'</span>, <span class="string">'multipart/x-mixed-replace;boundary=abcde'</span>)</div><div class="line">		self.end_headers()</div><div class="line"></div><div class="line">		<span class="keyword">with</span> self.retriever <span class="keyword">as</span> frames:</div><div class="line">			<span class="keyword">for</span> frame <span class="keyword">in</span> frames:</div><div class="line">				self.send_frame(frame)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">send_frame</span><span class="params">(self, frame)</span>:</span></div><div class="line">		s  = <span class="string">'--abcde\r\n'</span></div><div class="line">		s += <span class="string">'Content-Type: image/jpeg\r\n'</span></div><div class="line">		s += <span class="string">'Content-Length: %s\r\n\r\n'</span> % len(frame)</div><div class="line">		self.wfile.write(s.encode(<span class="string">'ascii'</span>))</div><div class="line">		self.wfile.write(frame)</div><div class="line"></div><div class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadingPoolTCPServer</span><span class="params">(ThreadingTCPServer)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, server_address, RequestHandlerClass, bind_and_activate=True, max_thread_num=<span class="number">100</span>)</span>:</span></div><div class="line">		super().__init__(server_address, RequestHandlerClass, bind_and_activate)</div><div class="line">		self.executor = ThreadPoolExecutor(max_thread_num)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request, client_address)</span>:</span></div><div class="line">		self.executor.submit(self.process_request_thread, request, client_address)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	streamer = JpegStreamer(<span class="number">0</span>)</div><div class="line">	streamer.start()</div><div class="line"></div><div class="line">	retriever = JpegRetriever(streamer)</div><div class="line">	Handler.setJpegRetriever(retriever)</div><div class="line"></div><div class="line">	print(<span class="string">'Start server...'</span>)</div><div class="line">	httpd = ThreadingPoolTCPServer((<span class="string">''</span>, <span class="number">9000</span>), Handler, max_thread_num=<span class="number">3</span>)</div><div class="line">	httpd.serve_forever()</div></pre></td></tr></table></figure>
<hr>
<h3 id="7-6-如何使用多进程"><a href="#7-6-如何使用多进程" class="headerlink" title="7.6 如何使用多进程"></a>7.6 如何使用多进程</h3><p>由于GIL，处理CPU密集型，推荐使用多进程</p>
<p>使用标准库multiprocessing.Process，它可以启动子进程执行任务，操作接口，进程间通信，进程间同步等都与Threading.Thread类似</p>
<h2 id="八、装饰器"><a href="#八、装饰器" class="headerlink" title="八、装饰器"></a>八、装饰器</h2><h3 id="8-1-如何使用函数装饰器"><a href="#8-1-如何使用函数装饰器" class="headerlink" title="8.1 如何使用函数装饰器"></a>8.1 如何使用函数装饰器</h3><p>定义装饰器函数，用它来生成一个在原函数基础添加了新功能的函数，替代原函数</p>
<h3 id="8-2-如何为被装饰的函数保存元数据"><a href="#8-2-如何为被装饰的函数保存元数据" class="headerlink" title="8.2 如何为被装饰的函数保存元数据"></a>8.2 如何为被装饰的函数保存元数据</h3><p>在函数中保存着一些元数据，如<br><code>f.__name__</code>    : 函数名字<br><code>f.__doc__</code>     : 函数文档字符串<br><code>f.__moudle__</code>  : 函数所属模块<br><code>f.__dict__</code>    : 属性字典<br><code>f.__defaults__</code>: 默认参数元组<br>…<br>我们在使用装饰器后，再访问以上属性时，看到的是内部包裹函数的元数据，原来函数的元数据便丢失掉了，如何解决呢？</p>
<p>使用标准库functools中的装饰器wraps装饰内部包裹函数，可以制定将原函数的某些属性，更新到包裹函数上面</p>
<h3 id="8-3-如何实现带参数的装饰器"><a href="#8-3-如何实现带参数的装饰器" class="headerlink" title="8.3 如何实现带参数的装饰器"></a>8.3 如何实现带参数的装饰器</h3><p>实现一个检查函数参数类型的装饰器</p>
<p>python3 提取函数签名<br>inspect.signature()<br>带参数的装饰器，也就是根据参数定制化一个装饰器。可以看成生产装饰器的工厂，每次调用typeassert，返回一个特定的装饰器，然后用它去修饰其他函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> signature</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">typeassert</span><span class="params">(*ty_args, **ty_kargs)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(func)</span>:</span></div><div class="line">		<span class="comment"># func -&gt; a, b</span></div><div class="line">		<span class="comment"># d = &#123;'a': int, 'b': str&#125;</span></div><div class="line">		sig = signature(func)</div><div class="line">		btypes = sig.bind_partial(*ty_args, **ty_kargs).arguments</div><div class="line">		<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kargs)</span>:</span></div><div class="line">			<span class="comment"># arg in d, instance(arg, d[arg])</span></div><div class="line">			<span class="keyword">for</span> name, obj <span class="keyword">in</span> sig.bind(*args, **kargs).arguments.items():</div><div class="line">				<span class="keyword">if</span> name <span class="keyword">in</span> btypes:</div><div class="line">					<span class="keyword">if</span> <span class="keyword">not</span> isinstance(obj, btypes):</div><div class="line">						<span class="keyword">raise</span> TypeError(<span class="string">'"%s" must be "%s"'</span> % (name, btypes[name]))</div><div class="line">			<span class="keyword">return</span> func(*args, **kargs)</div><div class="line">		<span class="keyword">return</span> wrapper</div><div class="line">	<span class="keyword">return</span> decorator</div><div class="line"></div><div class="line"><span class="meta">@typeassert(int, str, list)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(a, b, c)</span>:</span></div><div class="line">	<span class="keyword">print</span> (a, b, c)</div><div class="line"></div><div class="line">f(<span class="number">1</span>, <span class="string">'abc'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</div><div class="line">f(<span class="number">1</span>, <span class="number">2</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</div></pre></td></tr></table></figure>
<hr>
<h3 id="8-4-如何实现属性可修改的函数装饰器"><a href="#8-4-如何实现属性可修改的函数装饰器" class="headerlink" title="8.4 如何实现属性可修改的函数装饰器"></a>8.4 如何实现属性可修改的函数装饰器</h3><p>为分析程序内哪些函数开销比较大，我们定义一个带timeout参数的函数装饰器：<br>1.统计被装饰函数单次调用运行时间<br>2.时间大于timeout的，将此次函数调用记录到log中<br>3.运行时可修改timeout的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</div><div class="line"></div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">warn</span><span class="params">(timeout)</span>:</span></div><div class="line">	timeout = [timeout]</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(func)</span>:</span></div><div class="line">		<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kargs)</span>:</span></div><div class="line">			start = time.time()</div><div class="line">			res = func(*args, **kargs)</div><div class="line">			used = time.time() - start</div><div class="line">			<span class="keyword">if</span> used &gt; timeout[<span class="number">0</span>]:</div><div class="line">				msg = <span class="string">'"%s": %s &gt; %s'</span> % (func.__name__, used, timeout[<span class="number">0</span>])</div><div class="line">				logging.warn(msg)</div><div class="line">			<span class="keyword">return</span> res</div><div class="line">		<span class="function"><span class="keyword">def</span> <span class="title">setTimeout</span><span class="params">(k)</span>:</span></div><div class="line">			<span class="comment"># nonlocal timeout # python3</span></div><div class="line">			<span class="comment"># timeout = k</span></div><div class="line">			timeout[<span class="number">0</span>] = k</div><div class="line">		wrapper.setTimeout = setTimeout</div><div class="line">		<span class="keyword">return</span> wrapper</div><div class="line">	<span class="keyword">return</span> decorator</div><div class="line"></div><div class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</div><div class="line"><span class="meta">@warn(1.5)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></div><div class="line">	<span class="keyword">print</span> (<span class="string">'In test'</span>)</div><div class="line">	<span class="keyword">while</span> randint(<span class="number">0</span>, <span class="number">1</span>):</div><div class="line">		time.sleep(<span class="number">0.5</span>)</div><div class="line"></div><div class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">30</span>):</div><div class="line">	test()</div><div class="line"></div><div class="line">test.setTimeout(<span class="number">1</span>)</div><div class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">30</span>):</div><div class="line">	test()</div></pre></td></tr></table></figure>
<hr>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"># python</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/30/C++ 的 Memory Oder/" rel="next" title="C++11 的 Memory Oder">
                <i class="fa fa-chevron-left"></i> C++11 的 Memory Oder
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2222/06/06/个人总结/" rel="prev" title="个人总结">
                个人总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODY1MC81MjIx"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oe9uinblw.bkt.clouddn.com/avater67.jpg"
               alt="kelele67" />
          <p class="site-author-name" itemprop="name">kelele67</p>
           
              <p class="site-description motion-element" itemprop="description">古老却神奇的shell表白代码 :(){:|:&};:</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">73</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">70</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/kelele67" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/kelele67" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/liu-qi-21-51" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#目录"><span class="nav-number">1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据结构"><span class="nav-number">2.</span> <span class="nav-text">数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Pythonic-筛选数据"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 Pythonic 筛选数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Dict命名"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 Dict命名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-统计Dict-Counter"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 统计Dict Counter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-Dict-按照value排序"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 Dict 按照value排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-Dict公共键"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 Dict公共键</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-Dict保持有序-append"><span class="nav-number">2.6.</span> <span class="nav-text">2.6 Dict保持有序(append)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-实现用户历史记录"><span class="nav-number">2.7.</span> <span class="nav-text">2.7 实现用户历史记录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、迭代协议"><span class="nav-number">3.</span> <span class="nav-text">三、迭代协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-实现可迭代对象"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 实现可迭代对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-实现迭代器对象"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 实现迭代器对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-如何用生成器函数实现迭代器对象"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 如何用生成器函数实现迭代器对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-如何进行反向迭代和如何实现反向迭代"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 如何进行反向迭代和如何实现反向迭代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-如何对迭代器做切片操作"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 如何对迭代器做切片操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-如何在一个for语句中迭代多个可迭代对象"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 如何在一个for语句中迭代多个可迭代对象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、字符串"><span class="nav-number">4.</span> <span class="nav-text">四、字符串</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-如何拆分含有多种分隔符的字符串"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 如何拆分含有多种分隔符的字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-如何判断字符串a是否以字符串b开头或者结尾"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 如何判断字符串a是否以字符串b开头或者结尾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-如何调整字符串中文本的格式"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 如何调整字符串中文本的格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-如何将多个小字符串拼接成一个大的字符串"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 如何将多个小字符串拼接成一个大的字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-如何对字符串进行左，右，居中对齐"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 如何对字符串进行左，右，居中对齐</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-如何去掉字符串中不需要的字符"><span class="nav-number">4.6.</span> <span class="nav-text">4.6 如何去掉字符串中不需要的字符</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、文件操作"><span class="nav-number">5.</span> <span class="nav-text">五、文件操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-如何读写文本文件"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 如何读写文本文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-如何处理二进制文件"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 如何处理二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-如何设置文件的缓冲"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 如何设置文件的缓冲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-如何将文件映射到内存"><span class="nav-number">5.4.</span> <span class="nav-text">5.4 如何将文件映射到内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-如何访问一个文件状态"><span class="nav-number">5.5.</span> <span class="nav-text">5.5 如何访问一个文件状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-如何使用临时文件"><span class="nav-number">5.6.</span> <span class="nav-text">5.6 如何使用临时文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-7-如何读写csv文件数据"><span class="nav-number">5.7.</span> <span class="nav-text">5.7 如何读写csv文件数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-8-如何读写json文件数据"><span class="nav-number">5.8.</span> <span class="nav-text">5.8 如何读写json文件数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-9-如何解析简单的xml文档"><span class="nav-number">5.9.</span> <span class="nav-text">5.9 如何解析简单的xml文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-10-如何构建xml文档"><span class="nav-number">5.10.</span> <span class="nav-text">5.10 如何构建xml文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-11-如何读写excel文件"><span class="nav-number">5.11.</span> <span class="nav-text">5.11 如何读写excel文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、类和对象"><span class="nav-number">6.</span> <span class="nav-text">六、类和对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-如何派生不可变类型，并修改其实例化行为"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 如何派生不可变类型，并修改其实例化行为</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-如何为创建大量实例节省内存"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 如何为创建大量实例节省内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-如何让对象支持上下文管理"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 如何让对象支持上下文管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-如何创建可管理的对象属性"><span class="nav-number">6.4.</span> <span class="nav-text">6.4 如何创建可管理的对象属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-如何让类支持比较操作"><span class="nav-number">6.5.</span> <span class="nav-text">6.5 如何让类支持比较操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-如何使用描述符对实例属性进行检查"><span class="nav-number">6.6.</span> <span class="nav-text">6.6 如何使用描述符对实例属性进行检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-7-如何在环状数据结构中管理内存"><span class="nav-number">6.7.</span> <span class="nav-text">6.7 如何在环状数据结构中管理内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-8-如何通过实例化方法名字的字符串调用方法"><span class="nav-number">6.8.</span> <span class="nav-text">6.8 如何通过实例化方法名字的字符串调用方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#七、并发编程"><span class="nav-number">7.</span> <span class="nav-text">七、并发编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-如何使用多线程"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 如何使用多线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-如何线程间通信"><span class="nav-number">7.2.</span> <span class="nav-text">7.2 如何线程间通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-如何在线程间进行事件通知"><span class="nav-number">7.3.</span> <span class="nav-text">7.3 如何在线程间进行事件通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-如何使用线程本地数据"><span class="nav-number">7.4.</span> <span class="nav-text">7.4 如何使用线程本地数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-如何实现线程池"><span class="nav-number">7.5.</span> <span class="nav-text">7.5 如何实现线程池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-如何使用多进程"><span class="nav-number">7.6.</span> <span class="nav-text">7.6 如何使用多进程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#八、装饰器"><span class="nav-number">8.</span> <span class="nav-text">八、装饰器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-如何使用函数装饰器"><span class="nav-number">8.1.</span> <span class="nav-text">8.1 如何使用函数装饰器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-如何为被装饰的函数保存元数据"><span class="nav-number">8.2.</span> <span class="nav-text">8.2 如何为被装饰的函数保存元数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-如何实现带参数的装饰器"><span class="nav-number">8.3.</span> <span class="nav-text">8.3 如何实现带参数的装饰器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-如何实现属性可修改的函数装饰器"><span class="nav-number">8.4.</span> <span class="nav-text">8.4 如何实现属性可修改的函数装饰器</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kelele67</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.1"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("uu22m818WHNRkNyNn5ifFEYU-gzGzoHsz", "wczk27BwQ0jGSE3uOFqH9974");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
