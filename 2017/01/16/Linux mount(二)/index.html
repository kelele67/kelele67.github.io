<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Linux mount 学习(二) | 树犹如此|人何以堪</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Shared subtrees
简单点说， Shared subtrees 就是一种控制子挂载点能否在其他地方被看到的技术，它只会在 bind mount 和 mount namespace 中用到，属于不怎么常用的功能。本篇将以 bind mount 为例对 Shared subtrees 做一个简单介绍

Shared subtrees
回想一下上一篇中介绍的bind mount部分，如果b">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux mount 学习(二)">
<meta property="og:url" content="http://yoursite.com/2017/01/16/Linux mount(二)/index.html">
<meta property="og:site_name" content="树犹如此|人何以堪">
<meta property="og:description" content="Shared subtrees
简单点说， Shared subtrees 就是一种控制子挂载点能否在其他地方被看到的技术，它只会在 bind mount 和 mount namespace 中用到，属于不怎么常用的功能。本篇将以 bind mount 为例对 Shared subtrees 做一个简单介绍

Shared subtrees
回想一下上一篇中介绍的bind mount部分，如果b">
<meta property="og:updated_time" content="2017-04-18T10:05:47.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux mount 学习(二)">
<meta name="twitter:description" content="Shared subtrees
简单点说， Shared subtrees 就是一种控制子挂载点能否在其他地方被看到的技术，它只会在 bind mount 和 mount namespace 中用到，属于不怎么常用的功能。本篇将以 bind mount 为例对 Shared subtrees 做一个简单介绍

Shared subtrees
回想一下上一篇中介绍的bind mount部分，如果b">
  
  
    <link rel="icon" href="//favicon.png">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="http://oe9uedqb2.bkt.clouddn.com/4D9F59FD6F416AF4A92C4B977580BD95.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">kelele67</a></h1>
		</hgroup>

		
		<p class="header-subtitle">做一个富有的废物</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/about">关于本站</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/kelele67" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/kelele67" title="weibo">weibo</a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/liu-qi-21-51" title="zhihu">zhihu</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">kelele67</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="http://oe9uedqb2.bkt.clouddn.com/4D9F59FD6F416AF4A92C4B977580BD95.png" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">kelele67</h1>
			</hgroup>
			
			<p class="header-subtitle">做一个富有的废物</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/about">关于本站</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/kelele67" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/kelele67" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/liu-qi-21-51" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="airticle-Linux mount(二)" class="article article-type-airticle" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Linux mount 学习(二)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p></p><p></p>
<h2 id="Shared-subtrees"><a href="#Shared-subtrees" class="headerlink" title="Shared subtrees"></a>Shared subtrees</h2><blockquote>
<p>简单点说， <strong>Shared subtrees</strong> 就是一种控制子挂载点能否在其他地方被看到的技术，它只会在 <strong>bind mount</strong> 和 <strong>mount namespace</strong> 中用到，属于不怎么常用的功能。本篇将以 <strong>bind mount</strong> 为例对 <strong>Shared subtrees</strong> 做一个简单介绍</p>
</blockquote>
<h2 id="Shared-subtrees-1"><a href="#Shared-subtrees-1" class="headerlink" title="Shared subtrees"></a>Shared subtrees</h2><blockquote>
<p>回想一下上一篇中介绍的bind mount部分，如果bind在一起的两个目录下的子目录再挂载了设备的话，他们之间还能相互看到子目录里挂载的内容吗？ 比如在第一个目录下的子目录里面再mount了一个设备，那么在另一个目录下面能看到这个mount的设备里面的东西吗？答案是要看bind mount的propagation type。那什么是propagation type呢？</p>
</blockquote>
<p>peer group和propagation type都是随着shared subtrees一起被引入的概念，下面分别对他们做一个介绍。</p>
<h3 id="peer-group"><a href="#peer-group" class="headerlink" title="peer group"></a>peer group</h3><p>peer group 就是一挂载点的集合，他们之间可以共享挂载信息。</p>
<ul>
<li><p>mount-bind使得源和目的挂载点属于同一个peer group</p>
</li>
<li><p>创建新的mount namespace，新的和老的namespace里相同挂载点就会属于同一个peer group，因为新namespace会拷贝一份老namespace的挂载点信息</p>
</li>
</ul>
<h3 id="propagation-type"><a href="#propagation-type" class="headerlink" title="propagation type"></a>propagation type</h3><blockquote>
<p>这是一个标志，决定修改挂载点的时候会不会影响相同的peer group</p>
</blockquote>
<ul>
<li><p>MS_SHARED: 挂载信息会在同一个peer group的不同挂载点之间共享传播</p>
</li>
<li><p>MS_PRIVATE: 挂载信息根本就不共享，也即private的挂载点不会属于任何peer group</p>
</li>
<li><p>MS_SLAVE: 信息的传播是单向的，在同一个peer group里面，master的挂载点下面发生变化的时候，slave的挂载点下面也跟着变化，但反之则不然，slave下发生变化的时候不会通知master，master不会发生变化。</p>
</li>
<li><p>MS_UNBINDABLE: 这个和MS_PRIVATE相同，只是这种类型的挂载点不能作为bind mount的源，主要用来防止递归嵌套情况的出现</p>
</li>
</ul>
<h3 id="需要注意的地方"><a href="#需要注意的地方" class="headerlink" title="需要注意的地方"></a>需要注意的地方</h3><ul>
<li><p>propagation type是挂载点的属性，每个挂载点都是独立的</p>
</li>
<li><p>挂载点是有父子关系的，比如挂载点/和/mnt/cdrom，/mnt/cdrom都是‘/’的子挂载点，‘/’是/mnt/cdrom的父挂载点</p>
</li>
<li><p>默认情况下，如果父挂载点是MS_SHARED，那么子挂载点也是MS_SHARED的，否则子挂载点将会是MS_PRIVATE，跟爷爷挂载点没有关系</p>
</li>
</ul>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">#准备4个虚拟的disk</div><div class="line">kingand67@kelele67:~$ mkdir disks &amp;&amp; cd disks</div><div class="line">&lt;p&gt;</div><div class="line">kingand67@kelele67:~/disks$ dd if=/dev/zero bs=1M count=32 of=./disk1.img</div><div class="line">32+0 records in</div><div class="line">32+0 records out</div><div class="line">33554432 bytes (34 MB, 32 MiB) copied, 0.0203764 s, 1.6 GB/s</div><div class="line">&lt;p&gt;</div><div class="line">kingand67@kelele67:~/disks$ dd if=/dev/zero bs=1M count=32 of=./disk2.img</div><div class="line">32+0 records in</div><div class="line">32+0 records out</div><div class="line">33554432 bytes (34 MB, 32 MiB) copied, 0.0316243 s, 1.1 GB/s</div><div class="line">&lt;p&gt;</div><div class="line">kingand67@kelele67:~/disks$ dd if=/dev/zero bs=1M count=32 of=./disk3.img</div><div class="line">32+0 records in</div><div class="line">32+0 records out</div><div class="line">33554432 bytes (34 MB, 32 MiB) copied, 0.0227662 s, 1.5 GB/s</div><div class="line">&lt;p&gt;</div><div class="line">kingand67@kelele67:~/disks$ dd if=/dev/zero bs=1M count=32 of=./disk4.img</div><div class="line">32+0 records in</div><div class="line">32+0 records out</div><div class="line">33554432 bytes (34 MB, 32 MiB) copied, 0.0322572 s, 1.0 GB/s</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">#并在上面创建ext2文件系统，用于后续的mount测试</div><div class="line">kingand67@kelele67:~/disks$ mkfs.ext2 ./disk1.img</div><div class="line">mke2fs 1.42.13 (17-May-2015)</div><div class="line">Discarding device blocks: done                            </div><div class="line">Creating filesystem with 32768 1k blocks and 8192 inodes</div><div class="line">Filesystem UUID: d34a16ed-3d87-4fa3-adeb-185ca6816a7c</div><div class="line">Superblock backups stored on blocks: </div><div class="line">	8193, 24577</div><div class="line">Allocating group tables: done                            </div><div class="line">Writing inode tables: done                            </div><div class="line">Writing superblocks and filesystem accounting information: done</div><div class="line">&lt;p&gt;</div><div class="line">kingand67@kelele67:~/disks$ mkfs.ext2 ./disk2.img</div><div class="line">mke2fs 1.42.13 (17-May-2015)</div><div class="line">Discarding device blocks: done                            </div><div class="line">Creating filesystem with 32768 1k blocks and 8192 inodes</div><div class="line">Filesystem UUID: 5a615c9b-bb6b-4c56-82ee-24af8efbb3a2</div><div class="line">Superblock backups stored on blocks: </div><div class="line">	8193, 24577</div><div class="line">Allocating group tables: done                            </div><div class="line">Writing inode tables: done                            </div><div class="line">Writing superblocks and filesystem accounting information: done</div><div class="line">&lt;p&gt;</div><div class="line">kingand67@kelele67:~/disks$ mkfs.ext2 ./disk3.img</div><div class="line">mke2fs 1.42.13 (17-May-2015)</div><div class="line">Discarding device blocks: done                            </div><div class="line">Creating filesystem with 32768 1k blocks and 8192 inodes</div><div class="line">Filesystem UUID: c4d0aca6-d952-4d9f-8270-0147a8912cab</div><div class="line">Superblock backups stored on blocks: </div><div class="line">	8193, 24577</div><div class="line">Allocating group tables: done                            </div><div class="line">Writing inode tables: done                            </div><div class="line">Writing superblocks and filesystem accounting information: done</div><div class="line">&lt;p&gt;</div><div class="line">kingand67@kelele67:~/disks$ mkfs.ext2 ./disk4.img</div><div class="line">mke2fs 1.42.13 (17-May-2015)</div><div class="line">Discarding device blocks: done                            </div><div class="line">Creating filesystem with 32768 1k blocks and 8192 inodes</div><div class="line">Filesystem UUID: fa60b67e-4d98-41f3-8db5-27c06882df02</div><div class="line">Superblock backups stored on blocks: </div><div class="line">	8193, 24577</div><div class="line">Allocating group tables: done                            </div><div class="line">Writing inode tables: done                            </div><div class="line">Writing superblocks and filesystem accounting information: done</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#准备两个目录用于挂载上面创建的disk</div><div class="line">kingand67@kelele67:~/disks$ mkdir disk1 disk2</div><div class="line">kingand67@kelele67:~/disks$ ls</div><div class="line">disk1  disk1.img  disk2  disk2.img  disk3.img  disk4.im</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#确保根目录的propagation type是shared，</div><div class="line">#这一步是为了保证大家的操作结果和示例中的一样</div><div class="line">kingand67@kelele67:~/disks$ sudo mount --make-shared /</div></pre></td></tr></table></figure>
<hr>
<h4 id="查看-propagation-type-和-peer-group"><a href="#查看-propagation-type-和-peer-group" class="headerlink" title="查看 propagation type 和 peer group"></a>查看 propagation type 和 peer group</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#显式的以shared方式挂载disk1</div><div class="line">kingand67@kelele67:~/disks$ sudo mount --make-shared ./disk1.img ./disk1</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#显式的以private方式挂载disk2</div><div class="line">kingand67@kelele67:~/disks$ sudo mount --make-private ./disk2.img ./disk2</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#mountinfo比mounts文件包含有更多的关于挂载点的信息</div><div class="line">#这里sed主要用来过滤掉跟当前主题无关的信息</div><div class="line">#shared:111表示挂载点/home/dev/disks/disk1是以shared方式挂载，且peer group id为111</div><div class="line">#而挂载点/home/dev/disks/disk2没有相关信息，表示是以private方式挂载</div><div class="line">kingand67@kelele67:~/disks$ cat /proc/self/mountinfo |grep disk | sed &apos;s/-.*//&apos;</div><div class="line">150 22 7:0 / /home/kingand67/disks/disk1 rw,relatime shared:111 </div><div class="line">156 22 7:1 / /home/kingand67/disks/disk2 rw,relatime</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#分别在disk1和disk2目录下创建目录disk3和disk4，然后挂载disk3，disk4到这两个目录</div><div class="line">kingand67@kelele67:~/disks$ sudo mkdir ./disk1/disk3 ./disk2/disk4</div><div class="line">kingand67@kelele67:~/disks$ sudo mount ./disk3.img ./disk1/disk3</div><div class="line">kingand67@kelele67:~/disks$ sudo mount ./disk4.img ./disk2/disk4</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#查看挂载信息，第一列的数字是挂载点ID，第二例是父挂载点ID，</div><div class="line">#从结果来看，150和162的类型都是shared，而179和173的类型都是private的，</div><div class="line">#说明在默认mount的情况下，子挂载点会继承父挂载点的propagation type</div><div class="line">kingand67@kelele67:~/disks$ cat /proc/self/mountinfo |grep disk | sed &apos;s/-.*//&apos;</div><div class="line">150 22 7:0 / /home/kingand67/disks/disk1 rw,relatime shared:111 </div><div class="line">156 22 7:1 / /home/kingand67/disks/disk2 rw,relatime </div><div class="line">162 150 7:2 / /home/kingand67/disks/disk1/disk3 rw,relatime shared:117 </div><div class="line">293 156 7:3 / /home/kingand67/disks/disk2/disk4 rw,relatime</div></pre></td></tr></table></figure>
<hr>
<h4 id="shared-和-private-mount"><a href="#shared-和-private-mount" class="headerlink" title="shared 和 private mount"></a>shared 和 private mount</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#umount掉disk3和disk4，创建两个新的目录bind1和bind2用于bind测试</div><div class="line">kingand67@kelele67:~/disks$ sudo umount /home/kingand67/disks/disk1/disk3 </div><div class="line">kingand67@kelele67:~/disks$ sudo umount /home/kingand67/disks/disk2/disk4</div><div class="line">kingand67@kelele67:~/disks$ mkdir bind1 bind2</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#bind的方式挂载disk1到bind1，disk2到bind2</div><div class="line">kingand67@kelele67:~/disks$ sudo mount --bind ./disk1 ./bind1</div><div class="line">kingand67@kelele67:~/disks$ sudo mount --bind ./disk2 ./bind2</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#查看挂载信息，显然默认情况下bind1和bind2的propagation type继承自父挂载点22(/)，都是shared。</div><div class="line">#由于bind2的源挂载点disk2是private的，所以bind2没有和disk2在同一个peer group里面，</div><div class="line">#而是重新创建了一个新的peer group，这个group里面就只有它一个。</div><div class="line">#因为150和162都是shared类型且是通过bind方式mount在一起的，所以他们属于同一个peer group 111。</div><div class="line">kingand67@kelele67:~/disks$ cat /proc/self/mountinfo |grep disk | sed &apos;s/-.*//&apos;</div><div class="line">150 22 7:0 / /home/kingand67/disks/disk1 rw,relatime shared:111 </div><div class="line">156 22 7:1 / /home/kingand67/disks/disk2 rw,relatime </div><div class="line">162 22 7:0 / /home/kingand67/disks/bind1 rw,relatime shared:111 </div><div class="line">168 22 7:1 / /home/kingand67/disks/bind2 rw,relatime shared:127</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#ID为24的挂载点为根目录的挂载点</div><div class="line">kingand67@kelele67:~/disks$ cat /proc/self/mountinfo |grep ^22| sed &apos;s/-.*//&apos;</div><div class="line">22 0 8:1 / / rw,relatime shared:1</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#这时disk3和disk4目录都是空的</div><div class="line">kingand67@kelele67:~/disks$ ls bind1/disk3/</div><div class="line">kingand67@kelele67:~/disks$ ls bind2/disk4/</div><div class="line">kingand67@kelele67:~/disks$ ls disk1/disk3/</div><div class="line">kingand67@kelele67:~/disks$ ls disk2/disk4/</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#重新挂载disk3和disk4</div><div class="line">kingand67@kelele67:~/disks$ sudo mount ./disk3.img ./disk1/disk3/</div><div class="line">kingand67@kelele67:~/disks$ sudo mount ./disk4.img ./disk2/disk4/</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#由于disk1/和bind1/属于同一个peer group，</div><div class="line">#所以在挂载了disk3后，在两个目录下都能看到disk3下的内容</div><div class="line">kingand67@kelele67:~/disks$ ls disk1/disk3/</div><div class="line">lost+found</div><div class="line">kingand67@kelele67:~/disks$ ls bind1/disk3/</div><div class="line">lost+found</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#而disk2/是private类型的，所以在他下面挂载disk4不会通知bind2，</div><div class="line">#于是bind2下的disk4目录是空的</div><div class="line">kingand67@kelele67:~/disks$ ls disk2/disk4/</div><div class="line">lost+found</div><div class="line">kingand67@kelele67:~/disks$ ls bind2/disk4/</div><div class="line">kingand67@kelele67:~/disks$</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#再看看disk3，虽然174和175的父挂载点不一样，但由于他们父挂载点属于同一个peer group，</div><div class="line">#且disk3是以默认方式挂载的，所以他们属于同一个peer group</div><div class="line">kingand67@kelele67:~/disks$ cat /proc/self/mountinfo |egrep &quot;disk3&quot;| sed &apos;s/-.*//&apos;</div><div class="line">174 150 7:2 / /home/kingand67/disks/disk1/disk3 rw,relatime shared:133 </div><div class="line">175 162 7:2 / /home/kingand67/disks/bind1/disk3 rw,relatime shared:133</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#umount bind1/disk3后，disk1/disk3也相应的自动umount掉了</div><div class="line">kingand67@kelele67:~/disks$ sudo umount bind1/disk3</div><div class="line">kingand67@kelele67:~/disks$ cat /proc/self/mountinfo | grep disk3</div><div class="line">kingand67@kelele67:~/disks$</div></pre></td></tr></table></figure>
<hr>
<h4 id="slave-mount"><a href="#slave-mount" class="headerlink" title="slave mount"></a>slave mount</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#umount除disk1的所有其他挂载点</div><div class="line">kingand67@kelele67:~/disks$ sudo umount ./disk2/disk4</div><div class="line">kingand67@kelele67:~/disks$ sudo umount /home/kingand67/disks/bind1</div><div class="line">kingand67@kelele67:~/disks$ sudo umount /home/kingand67/disks/bind2</div><div class="line">kingand67@kelele67:~/disks$ sudo umount /home/kingand67/disks/disk2</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#确认只剩disk1</div><div class="line">kingand67@kelele67:~/disks$ cat /proc/self/mountinfo |grep disk| sed &apos;s/-.*//&apos;</div><div class="line">150 22 7:0 / /home/kingand67/disks/disk1 rw,relatime shared:111</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#分别显式的用shared和slave的方式bind disk1</div><div class="line">kingand67@kelele67:~/disks$ sudo mount --bind --make-shared ./disk1 ./bind1</div><div class="line">kingand67@kelele67:~/disks$ sudo mount --bind --make-slave ./bind1 ./bind2</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#150、156和162都属于同一个peer group，</div><div class="line">#master:105表示/home/dev/disks/bind2是peer group 105的slave</div><div class="line">kingand67@kelele67:~/disks$ cat /proc/self/mountinfo |grep disk| sed &apos;s/-.*//&apos;</div><div class="line">150 22 7:0 / /home/kingand67/disks/disk1 rw,relatime shared:111 </div><div class="line">156 22 7:0 / /home/kingand67/disks/bind1 rw,relatime shared:111 </div><div class="line">162 22 7:0 / /home/kingand67/disks/bind2 rw,relatime master:111</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#mount disk3到disk1的子目录disk3下</div><div class="line">kingand67@kelele67:~/disks$ sudo mount ./disk3.img ./disk1/disk3/</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#其他两个目录bin1和bind2里面也挂载成功，说明master发生变化的时候，slave会跟着变化</div><div class="line">kingand67@kelele67:~/disks$ cat /proc/self/mountinfo |grep disk| sed &apos;s/-.*//&apos;</div><div class="line">150 22 7:0 / /home/kingand67/disks/disk1 rw,relatime shared:111 </div><div class="line">156 22 7:0 / /home/kingand67/disks/bind1 rw,relatime shared:111 </div><div class="line">162 22 7:0 / /home/kingand67/disks/bind2 rw,relatime master:111 </div><div class="line">168 150 7:1 / /home/kingand67/disks/disk1/disk3 rw,relatime shared:127 </div><div class="line">170 162 7:1 / /home/kingand67/disks/bind2/disk3 rw,relatime master:127 </div><div class="line">169 156 7:1 / /home/kingand67/disks/bind1/disk3 rw,relatime shared:127</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#umount disk3，然后mount disk3到bind2目录下</div><div class="line">kingand67@kelele67:~/disks$ sudo umount ./disk1/disk3/</div><div class="line">kingand67@kelele67:~/disks$ sudo mount ./disk3.img ./bind2/disk3/</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#由于bind2的propagation type是slave，所以disk1和bind1两个挂载点下面不会挂载disk3</div><div class="line">#从168的类型可以看出，当父挂载点162是slave类型时，默认情况下其子挂载点168是private类型</div><div class="line">kingand67@kelele67:~/disks$ cat /proc/self/mountinfo |grep disk| sed &apos;s/-.*//&apos;</div><div class="line">150 22 7:0 / /home/kingand67/disks/disk1 rw,relatime shared:111 </div><div class="line">156 22 7:0 / /home/kingand67/disks/bind1 rw,relatime shared:111 </div><div class="line">162 22 7:0 / /home/kingand67/disks/bind2 rw,relatime master:111 </div><div class="line">168 162 7:1 / /home/kingand67/disks/bind2/disk3 rw,relatime</div></pre></td></tr></table></figure>
<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>如果用到了 <strong>bind mount</strong> 和 <strong>mount namespace</strong> ，在挂载设备的时候就需要注意一下父挂载点是否和其他挂载点有 <strong>peer group</strong> 关系，如果有且父挂载点是 <strong>shared</strong> ，就说明你挂载的设备除了在当前挂载点可以看到，在父挂载点的 <strong>peer group</strong> 的下面也可以看到。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://segmentfault.com/a/1190000006899213" target="_blank" rel="external">Linux mount （第二部分）</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2017/01/16/Linux mount(二)/" class="archive-article-date">
  	<time datetime="2017-01-15T18:03:01.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-01-16</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mount/">mount</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2017/01/16/Linux mount 技巧/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          Linux编译技巧
        
      </div>
    </a>
  
  
    <a href="/2017/01/15/Linux mount (一)/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Linux mount 学习(一)</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>




<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
	    <a class="jiathis_button_twitter"></a>
	    <a class="jiathis_button_plus"></a> 
	    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Linux mount(二)" data-title="Linux mount 学习(二)" data-url="http://yoursite.com/2017/01/16/Linux mount(二)/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"38d12c42fae50816089820c1b93c4785"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 kelele67
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
<script type="text/javascript">
var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260501136'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1260501136%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));
</script>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/"
	}
</script>

<script src="/./main.js"></script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/CRT/" style="font-size: 15px;">CRT</a> <a href="/tags/algorithm/" style="font-size: 17.5px;">algorithm</a> <a href="/tags/animation/" style="font-size: 15px;">animation</a> <a href="/tags/c/" style="font-size: 20px;">c</a> <a href="/tags/c/" style="font-size: 17.5px;">c++</a> <a href="/tags/ccache/" style="font-size: 10px;">ccache</a> <a href="/tags/cgroup/" style="font-size: 10px;">cgroup</a> <a href="/tags/concurrency/" style="font-size: 17.5px;">concurrency</a> <a href="/tags/data-structures/" style="font-size: 10px;">data structures</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/gc/" style="font-size: 12.5px;">gc</a> <a href="/tags/html5/" style="font-size: 10px;">html5</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/ios/" style="font-size: 10px;">ios</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/lua/" style="font-size: 12.5px;">lua</a> <a href="/tags/make/" style="font-size: 10px;">make</a> <a href="/tags/mount/" style="font-size: 12.5px;">mount</a> <a href="/tags/muffer-manipulation/" style="font-size: 10px;">muffer manipulation</a> <a href="/tags/namespace/" style="font-size: 10px;">namespace</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/python/" style="font-size: 17.5px;">python</a> <a href="/tags/release/" style="font-size: 10px;">release</a> <a href="/tags/search/" style="font-size: 10px;">search</a> <a href="/tags/siri/" style="font-size: 10px;">siri</a> <a href="/tags/solution/" style="font-size: 10px;">solution</a> <a href="/tags/sort/" style="font-size: 10px;">sort</a> <a href="/tags/string-manipulation/" style="font-size: 10px;">string manipulation</a> <a href="/tags/swift/" style="font-size: 15px;">swift</a> <a href="/tags/systemd/" style="font-size: 10px;">systemd</a> <a href="/tags/sysvinit/" style="font-size: 10px;">sysvinit</a> <a href="/tags/thread/" style="font-size: 12.5px;">thread</a> <a href="/tags/threadpool/" style="font-size: 12.5px;">threadpool</a> <a href="/tags/tmpfs/" style="font-size: 10px;">tmpfs</a> <a href="/tags/trees/" style="font-size: 10px;">trees</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/upstart/" style="font-size: 10px;">upstart</a> <a href="/tags/web-server/" style="font-size: 10px;">web server</a> <a href="/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
    			</div>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">&lt;div class=&quot;text&quot; style=&quot; text-align:center;&quot;&gt;大三学生&lt;br&gt;就读于重庆大学 软件狗&lt;br&gt;&lt;br&gt; 喜欢python&lt;br&gt;自由的灵魂&lt;br&gt;&lt;br&gt;世界万物都是隐喻&lt;br&gt;我们是通过隐喻这个装置接受反讽&lt;br&gt;加深扩大自己&lt;/div&gt;</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>
